<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>FURY - Discord-like Platform</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>


    <script type="module">

        // Import the functions you need from the SDKs you need

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";


        // Your web app's Firebase configuration

        const firebaseConfig = {

            apiKey: "AIzaSyCkp-J_21Nb7qBquiMA90Zl13elfGesCPI",

            authDomain: "squit-up-auth.firebaseapp.com",

            projectId: "squit-up-auth",

            storageBucket: "squit-up-auth.firebasestorage.app",

            messagingSenderId: "503910898443",

            appId: "1:503910898443:web:c5a56eb24cd4f183d8600e",

            measurementId: "G-K4LHFHSNJC"

        };


        // Initialize Firebase

        const app = initializeApp(firebaseConfig);

        const auth = getAuth(app);

        const db = getFirestore(app);

        const analytics = getAnalytics(app);

        const provider = new GoogleAuthProvider();


        // Make Firebase services available globally

        window.firebaseAuth = auth;

        window.firebaseDb = db;

        window.GoogleAuthProvider = GoogleAuthProvider;

        window.signInWithPopup = signInWithPopup;

        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;

        window.signInWithEmailAndPassword = signInWithEmailAndPassword;

        window.onAuthStateChanged = onAuthStateChanged;

        window.signOut = signOut;

        window.doc = doc;

        window.setDoc = setDoc;

        window.getDoc = getDoc;

        window.collection = collection;

        window.query = query;

        window.where = where;

        window.getDocs = getDocs;

        window.deleteDoc = deleteDoc;

        window.googleProvider = provider;

    </script>

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        

        body {

            font-family: 'Inter', sans-serif;

            background: #36393f;

            min-height: 100%;

            box-sizing: border-box;

        }

        

        html, body {

            height: 100%;

            margin: 0;

            padding: 0;

        }


        /* Discord-like styling */

        .discord-bg { background: #36393f; }

        .discord-sidebar { background: #2f3136; }

        .discord-channel { background: #40444b; }

        .discord-chat { background: #36393f; }

        .discord-input { background: #40444b; }

        

        /* Auth screens */

        .auth-container {

            background: #36393f;

            min-height: 100vh;

            display: flex;

            align-items: center;

            justify-content: center;

            padding: 2rem;

        }

        

        .auth-card {

            background: #2f3136;

            border-radius: 8px;

            padding: 2rem;

            width: 100%;

            max-width: 480px;

            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.24);

        }


        /* Main app layout */

        .main-app {

            display: none;

            height: 100vh;

            overflow: hidden;

        }


        /* Custom scrollbars */

        .custom-scrollbar::-webkit-scrollbar {

            width: 8px;

        }

        .custom-scrollbar::-webkit-scrollbar-thumb {

            background: #202225;

            border-radius: 4px;

        }

        .custom-scrollbar::-webkit-scrollbar-track {

            background: transparent;

        }


        /* Server icons */

        .server-icon {

            width: 48px;

            height: 48px;

            border-radius: 50%;

            transition: border-radius 0.2s ease;

            cursor: pointer;

        }

        .server-icon:hover {

            border-radius: 16px;

        }

        .server-icon.active {

            border-radius: 16px;

        }


        /* Message styling */

        .message-hover:hover {

            background: rgba(4, 4, 5, 0.07);

        }


        /* Emoji picker */

        .emoji-picker {

            background: #2f3136;

            border: 1px solid #40444b;

            border-radius: 8px;

            max-height: 300px;

            overflow-y: auto;

        }


        /* Profile customization */

        .profile-banner {

            height: 120px;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            position: relative;

        }


        /* Friend request animations */

        .slide-in {

            animation: slideIn 0.3s ease-out;

        }

        

        @keyframes slideIn {

            from { transform: translateX(-100%); opacity: 0; }

            to { transform: translateX(0); opacity: 1; }

        }


        /* Status indicators */

        .status-online { background: #43b581; }

        .status-idle { background: #faa61a; }

        .status-dnd { background: #f04747; }

        .status-offline { background: #747f8d; }


        /* Modal backdrop */

        .modal-backdrop {

            background: rgba(0, 0, 0, 0.85);

        }

    </style>

</head>

<body class="text-white discord-bg">


    <div id="login-screen" class="auth-container">

        <div class="auth-card">

            <div class="text-center mb-8">

                <h1 class="text-3xl font-bold mb-2" style="

                    background: linear-gradient(90deg, #ff416c, #ff4b2b, #ff7e5f, #ffa585);

                    -webkit-background-clip: text;

                    -webkit-text-fill-color: transparent;

                ">Welcome to FURY</h1>

                <p class="text-gray-400">We're so excited to see you again!</p>

            </div>


            <form id="login-form" class="space-y-4 mb-6">

                <div>

                    <label class="block text-sm font-medium text-gray-300 mb-2">USER ID</label>

                    <input type="text" id="login-userid" placeholder="@username" 

                               class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">

                </div>

                <div>

                    <label class="block text-sm font-medium text-gray-300 mb-2">PASSWORD</label>

                    <input type="password" id="login-password" placeholder="Password" 

                               class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">

                </div>

                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded font-medium transition duration-200">

                    Log In

                </button>

                <div id="login-error" class="mt-3 p-3 bg-red-900 border border-red-700 rounded text-red-200 text-sm" style="display: none;">

                    <p>No user found with this User ID. If you don't have an account, please use "Continue with Google" to create a new account.</p>

                </div>

            </form>


            <div class="text-center mb-4">

                <span class="text-gray-400 text-sm">Don't have an account?</span>

            </div>


            <button id="google-signup-button" 

                     class="w-full py-3 bg-white hover:bg-gray-100 text-gray-800 rounded font-medium transition duration-200 flex items-center justify-center space-x-2 mb-4">

                <i data-lucide="chrome" class="w-5 h-5"></i>

                <span>Continue with Google</span>

            </button>
            
            <div id="google-error" class="mt-3 p-3 bg-red-900 border border-red-700 rounded text-red-200 text-sm" style="display: none;">
                <p>Google Sign-in Failed. Check your console for details, or verify your Firebase 'Auth > Sign-in Method' and 'Project Settings > Authorized Domains'.</p>
            </div>
            <p class="text-xs text-gray-500 text-center">By registering, you agree to FURY's Terms of Service and Privacy Policy.</p>

        </div>

    </div>


    <div id="setup-screen" class="auth-container" style="display: none;">

        <div class="auth-card">

            <div class="text-center mb-8">

                <h2 class="text-2xl font-bold mb-2">Complete Your Profile</h2>

                <p class="text-gray-400">Set up your FURY account</p>

            </div>


            <form id="setup-form" class="space-y-4">

                <div>

                    <label class="block text-sm font-medium text-gray-300 mb-2">CHOOSE YOUR USER ID</label>

                    <div class="relative">

                        <span class="absolute left-3 top-2 text-gray-400">@</span>

                        <input type="text" id="setup-userid" placeholder="username" 

                               class="w-full pl-8 pr-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">

                    </div>

                    <p class="text-xs text-gray-400 mt-1">This will be your unique identifier</p>

                </div>

                

                <div>

                    <label class="block text-sm font-medium text-gray-300 mb-2">CREATE PASSWORD</label>

                    <input type="password" id="setup-password" placeholder="Password" 

                               class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">

                </div>

                

                <div>

                    <label class="block text-sm font-medium text-gray-300 mb-2">CONFIRM PASSWORD</label>

                    <input type="password" id="setup-confirm-password" placeholder="Confirm Password" 

                               class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">

                </div>


                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded font-medium transition duration-200">

                    Create Account

                </button>

                <div id="setup-error" class="mt-3 p-3 bg-red-900 border border-red-700 rounded text-red-200 text-sm" style="display: none;">

                    <p id="setup-error-message">Please check your information and try again.</p>

                </div>

                <div id="setup-success" class="mt-3 p-3 bg-green-900 border border-green-700 rounded text-green-200 text-sm" style="display: none;">

                    <p>Account created successfully! Setting up your profile...</p>

                </div>

            </form>

        </div>

    </div>


    <div id="main-app" class="main-app flex">

        <div class="w-18 discord-sidebar flex flex-col items-center py-3 space-y-2">

            <div class="server-icon bg-blue-600 flex items-center justify-center active" id="home-server">

                <i data-lucide="home" class="w-6 h-6 text-white"></i>

            </div>

            
            <div class="w-8 h-0.5 bg-gray-600 rounded"></div>

            
            <div id="server-list" class="space-y-2">

                </div>

            
            <div class="server-icon bg-gray-700 hover:bg-green-600 flex items-center justify-center transition-colors" id="add-server-btn">

                <i data-lucide="plus" class="w-6 h-6 text-white"></i>

            </div>

        </div>


        <div class="w-60 discord-channel flex flex-col">

            <div class="p-4 border-b border-gray-600">

                <div class="flex items-center space-x-3" id="current-server-info">

                    <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>

                    <span class="font-semibold">Direct Messages</span>

                </div>

            </div>


            <div class="flex border-b border-gray-600" id="nav-tabs">

                <button class="flex-1 py-2 px-4 text-sm font-medium text-white bg-gray-600" data-tab="friends">Friends</button>

                <button class="flex-1 py-2 px-4 text-sm font-medium text-gray-400 hover:text-white" data-tab="dms">DMs</button>

            </div>


            <div id="friends-panel" class="flex-1 overflow-y-auto custom-scrollbar">

                <div class="p-4">

                    <div class="flex items-center justify-between mb-3">

                        <h3 class="text-sm font-semibold text-gray-300">FRIEND REQUESTS</h3>

                        <span class="bg-red-500 text-xs px-2 py-1 rounded-full" id="friend-requests-count">2</span>

                    </div>

                    <div id="friend-requests-list" class="space-y-2">

                        </div>

                </div>


                <div class="p-4">

                    <h3 class="text-sm font-semibold text-gray-300 mb-3">ONLINE ‚Äî <span id="online-friends-count">3</span></h3>

                    <div id="online-friends-list" class="space-y-2">

                        </div>

                </div>


                <div class="p-4">

                    <h3 class="text-sm font-semibold text-gray-300 mb-3">ALL FRIENDS ‚Äî <span id="all-friends-count">12</span></h3>

                    <div id="all-friends-list" class="space-y-2">

                        </div>

                </div>

            </div>


            <div id="dms-panel" class="flex-1 overflow-y-auto custom-scrollbar" style="display: none;">

                <div class="p-4">

                    <div class="flex items-center space-x-2 mb-4">

                        <input type="text" placeholder="Find or start a conversation" 

                               class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 text-sm focus:outline-none focus:border-blue-500">

                    </div>

                    
                    <div class="mb-6 p-3 bg-gray-700 rounded-lg">

                        <h4 class="text-sm font-semibold text-gray-300 mb-2">Add New Friend</h4>

                        <div class="flex space-x-2">

                            <input type="text" id="dm-friend-request-input" placeholder="Enter User ID (@username)" 

                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white placeholder-gray-400 text-sm focus:outline-none focus:border-blue-500">

                            <button id="dm-send-friend-request" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm font-medium">

                                Send Request

                            </button>

                        </div>

                    </div>

                    
                    <div id="dm-list" class="space-y-1">

                        </div>

                </div>

            </div>


            <div id="channels-panel" class="flex-1 overflow-y-auto custom-scrollbar" style="display: none;">

                <div id="channels-list" class="p-2">

                    </div>

            </div>


            <div class="p-3 bg-gray-800 flex items-center justify-between">

                <div class="flex items-center space-x-2">

                    <div class="relative">

                        <img id="user-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%236366f1'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='white' font-size='14'%3Eüë§%3C/text%3E%3C/svg%3E" 

                             class="w-8 h-8 rounded-full" alt="Avatar">

                        <div class="absolute -bottom-1 -right-1 w-3 h-3 status-online rounded-full border-2 border-gray-800"></div>

                    </div>

                    <div class="text-sm">

                        <div class="font-medium text-white" id="user-display-name">User</div>

                        <div class="text-gray-400" id="user-id-display">@user</div>

                    </div>

                </div>

                <div class="flex space-x-1">

                    <button class="p-1 hover:bg-gray-700 rounded" id="settings-btn" title="Settings">

                        <i data-lucide="settings" class="w-4 h-4 text-gray-400"></i>

                    </button>

                    <button class="p-1 hover:bg-gray-700 rounded" id="logout-btn" title="Logout">

                        <i data-lucide="log-out" class="w-4 h-4 text-gray-400"></i>

                    </button>

                </div>

            </div>

        </div>


        <div class="flex-1 discord-chat flex flex-col">

            <div class="h-12 px-4 flex items-center justify-between border-b border-gray-600 bg-gray-800">

                <div class="flex items-center space-x-2">

                    <i data-lucide="hash" class="w-5 h-5 text-gray-400" id="chat-icon"></i>

                    <span class="font-semibold text-white" id="chat-title">Welcome</span>

                </div>

                <div class="flex items-center space-x-2">

                    <button class="p-2 hover:bg-gray-700 rounded" id="add-friend-btn" title="Add Friend">

                        <i data-lucide="user-plus" class="w-5 h-5 text-gray-400"></i>

                    </button>

                    <button class="p-2 hover:bg-gray-700 rounded" id="search-btn" title="Search">

                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>

                    </button>

                </div>

            </div>


            <div id="messages-container" class="flex-1 overflow-y-auto custom-scrollbar p-4">

                <div class="text-center py-8">

                    <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">

                        <i data-lucide="message-circle" class="w-8 h-8 text-gray-400"></i>

                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Welcome to FURY!</h3>

                    <p class="text-gray-400">This is the beginning of your legendary conversations.</p>

                </div>

            </div>


            <div class="p-4">

                <div class="relative">

                    <input type="text" id="message-input" placeholder="Message..." 

                           class="w-full px-4 py-3 pr-12 bg-gray-700 border-none rounded-lg text-white placeholder-gray-400 focus:outline-none">

                    <div class="absolute right-3 top-3 flex space-x-1">

                        <button class="p-1 hover:bg-gray-600 rounded" id="emoji-btn" title="Emoji">

                            <i data-lucide="smile" class="w-5 h-5 text-gray-400"></i>

                        </button>

                        <button class="p-1 hover:bg-gray-600 rounded" id="attach-btn" title="Attach">

                            <i data-lucide="paperclip" class="w-5 h-5 text-gray-400"></i>

                        </button>

                    </div>

                </div>

            </div>

        </div>

    </div>


    <div id="add-friend-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" style="display: none;">

        <div class="bg-gray-800 rounded-lg p-6 w-96 max-w-md mx-4">

            <h3 class="text-xl font-bold mb-4">Add Friend</h3>

            <p class="text-gray-400 text-sm mb-4">You can add friends with their FURY User ID.</p>

            <form id="add-friend-form">

                <input type="text" id="friend-userid-input" placeholder="Enter a User ID (@username)" 

                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 mb-4">

                <div class="flex justify-end space-x-3">

                    <button type="button" id="cancel-add-friend" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>

                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">Send Friend Request</button>

                </div>

            </form>

        </div>

    </div>


    <div id="create-server-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" style="display: none;">

        <div class="bg-gray-800 rounded-lg p-6 w-96 max-w-md mx-4">

            <h3 class="text-xl font-bold mb-4">Create Your Server</h3>

            <p class="text-gray-400 text-sm mb-4">Give your new server a personality with a name and an icon.</p>

            <form id="create-server-form">

                <div class="mb-4">

                    <label class="block text-sm font-medium text-gray-300 mb-2">SERVER NAME</label>

                    <input type="text" id="server-name-input" placeholder="My Awesome Server" 

                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">

                </div>

                <div class="flex justify-end space-x-3">

                    <button type="button" id="cancel-create-server" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>

                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">Create</button>

                </div>

            </form>

        </div>

    </div>


    <div id="profile-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" style="display: none;">

        <div class="bg-gray-800 rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">

            <div class="profile-banner relative">

                <button class="absolute top-4 right-4 p-2 bg-black bg-opacity-50 rounded-full hover:bg-opacity-70" id="edit-banner-btn">

                    <i data-lucide="camera" class="w-4 h-4 text-white"></i>

                </button>

                <input type="file" id="banner-upload" accept="image/*,.gif" style="display: none;">

            </div>

            
            <div class="p-6 -mt-16 relative">

                <div class="flex items-end space-x-4 mb-6">

                    <div class="relative">

                        <img id="profile-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%236366f1'/%3E%3Ctext x='40' y='50' text-anchor='middle' fill='white' font-size='32'%3Eüë§%3C/text%3E%3C/svg%3E" 

                             class="w-20 h-20 rounded-full border-4 border-gray-800" alt="Avatar">

                        <button class="absolute -bottom-1 -right-1 p-1 bg-gray-700 rounded-full hover:bg-gray-600" id="edit-avatar-btn">

                            <i data-lucide="camera" class="w-3 h-3 text-white"></i>

                        </button>

                        <input type="file" id="avatar-upload" accept="image/*,.gif" style="display: none;">

                    </div>

                    <div class="flex-1">

                        <h2 class="text-2xl font-bold text-white" id="profile-display-name">User</h2>

                        <p class="text-gray-400" id="profile-user-id">@user</p>

                    </div>

                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white" id="edit-profile-btn">Edit Profile</button>

                </div>


                <form id="profile-form" class="space-y-4" style="display: none;">

                    <div>

                        <label class="block text-sm font-medium text-gray-300 mb-2">DISPLAY NAME</label>

                        <input type="text" id="profile-name-input" 

                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:border-blue-500">

                    </div>

                    <div>

                        <label class="block text-sm font-medium text-gray-300 mb-2">ABOUT ME</label>

                        <textarea id="profile-bio-input" rows="3" 

                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:border-blue-500" 

                                  placeholder="Tell us about yourself..."></textarea>

                    </div>

                    <div class="flex justify-end space-x-3">

                        <button type="button" id="cancel-profile-edit" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>

                        <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white">Save Changes</button>

                    </div>

                </form>


                <div class="mt-6">

                    <button class="w-full py-2 text-left text-red-400 hover:text-red-300" id="close-profile-modal">Close</button>

                </div>

            </div>

        </div>

    </div>


    <div id="emoji-picker" class="absolute bottom-16 right-4 emoji-picker p-4 z-40" style="display: none;">

        <div class="grid grid-cols-8 gap-2">

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üòÄ">üòÄ</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üòÇ">üòÇ</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üòç">üòç</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="ü§î">ü§î</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üòé">üòé</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üò≠">üò≠</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üò°">üò°</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="ü•∫">ü•∫</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üëç">üëç</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üëé">üëé</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üíØ">üíØ</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üî•">üî•</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="‚ö°">‚ö°</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üéâ">üéâ</button>

            <button class="p-2 hover:bg-gray-600 rounded text-lg" data-emoji="üöÄ">üöÄ</button>

        </div>

    </div>


    <script>

        // Initialize Lucide icons

        lucide.createIcons();


        // Global state

        let currentUser = null;

        let currentChat = null;

        let servers = [];

        let friends = [];

        let friendRequests = [];

        let dms = [];

        let messages = {};

        let currentView = 'friends';


        // Initialize app

        document.addEventListener('DOMContentLoaded', () => {

            lucide.createIcons();

            initializeAuth();

        });


        // Authentication system

        function initializeAuth() {

            const loginForm = document.getElementById('login-form');

            const setupForm = document.getElementById('setup-form');

            const googleSignupBtn = document.getElementById('google-signup-button');


            // Check if user is already logged in

            window.onAuthStateChanged(window.firebaseAuth, (user) => {

                if (user) {

                    // User is signed in, check if profile is complete

                    checkUserProfile(user);

                }

            });


            // Existing user login

            loginForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const userId = document.getElementById('login-userid').value.trim();

                const password = document.getElementById('login-password').value.trim();

                const errorDiv = document.getElementById('login-error');

                

                errorDiv.style.display = 'none';

                

                if (userId && password) {

                    try {

                        // Check if user exists in Firestore

                        const userQuery = window.query(

                            window.collection(window.firebaseDb, 'users'),

                            window.where('userId', '==', userId.startsWith('@') ? userId : '@' + userId)

                        );

                        const querySnapshot = await window.getDocs(userQuery);

                        

                        if (querySnapshot.empty) {

                            // User doesn't exist

                            errorDiv.style.display = 'block';

                            return;

                        }

                        
                        // Get user data

                        const userDoc = querySnapshot.docs[0];

                        const userData = userDoc.data();

                        
                        // Sign in with email and password

                        await window.signInWithEmailAndPassword(window.firebaseAuth, userData.email, password);

                        

                    } catch (error) {

                        console.error('Login error:', error);

                        errorDiv.querySelector('p').textContent = error.message.includes('auth/invalid-credential') ? 
                            "Invalid credentials or password. Please try again." : 
                            "An unexpected error occurred during login. Check the console.";
                        errorDiv.style.display = 'block';

                    }

                }

            });


            // Google Sign Up/Login (EDITED for better error handling)
            googleSignupBtn.addEventListener('click', async () => {
                const errorDiv = document.getElementById('google-error');
                errorDiv.style.display = 'none';
                
                try {
                    await window.signInWithPopup(window.firebaseAuth, window.googleProvider);
                    // Auth state change listener handles the rest
                } catch (error) {
                    console.error('Google Sign-in Error:', error);
                    let message = "Google Sign-in Failed. Check your console for details, or verify your Firebase 'Auth > Sign-in Method' and 'Project Settings > Authorized Domains'.";

                    if (error.code === 'auth/popup-closed-by-user') {
                        message = "Sign-in cancelled. Please click 'Continue with Google' again to proceed.";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                         message = "The sign-in popup was blocked or closed too quickly. Please try again.";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        message = "Sign-in domain not authorized. Please add your website URL (e.g., https://vaidik2012.github.io) to Firebase Authorized Domains.";
                    }
                    
                    errorDiv.querySelector('p').textContent = message;
                    errorDiv.style.display = 'block';
                }
            });

            // Handle new user setup
            setupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userIdInput = document.getElementById('setup-userid');
                const password = document.getElementById('setup-password').value.trim();
                const confirmPassword = document.getElementById('setup-confirm-password').value.trim();
                const errorDiv = document.getElementById('setup-error');
                const successDiv = document.getElementById('setup-success');
                
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';

                let userId = userIdInput.value.trim();
                if (!userId.startsWith('@')) {
                    userId = '@' + userId;
                }

                if (!userId || password.length < 6 || password !== confirmPassword) {
                    errorDiv.querySelector('#setup-error-message').textContent = "User ID and password must be valid (password must be 6+ characters and match).";
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Check if User ID is already taken
                const userQuery = window.query(
                    window.collection(window.firebaseDb, 'users'),
                    window.where('userId', '==', userId)
                );
                const querySnapshot = await window.getDocs(userQuery);
                
                if (!querySnapshot.empty) {
                    errorDiv.querySelector('#setup-error-message').textContent = `The User ID ${userId} is already taken. Please choose another one.`;
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) throw new Error("No authenticated user found for setup.");

                    // Update the user's password in Firebase Auth (since they signed up with Google)
                    // Note: This step is typically unnecessary if the password is only stored in Firestore, 
                    // but is included for completeness if you intend to use email/password login later.
                    // For a seamless Google Sign-up, you might skip this and only set profile data.

                    // 1. Create user profile in Firestore
                    const userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || 'New FURY User',
                        userId: userId,
                        avatar: user.photoURL || 'default_avatar_url', // Use Google photo or default
                        bio: '',
                        status: 'online',
                        createdAt: new Date().toISOString()
                    };

                    await window.setDoc(window.doc(window.firebaseDb, 'users', user.uid), userData);

                    successDiv.style.display = 'block';
                    // Wait a moment for visual confirmation, then proceed to app
                    setTimeout(() => {
                        checkUserProfile(user);
                    }, 1000);

                } catch (error) {
                    console.error('Setup error:', error);
                    errorDiv.querySelector('#setup-error-message').textContent = `Account setup failed: ${error.message}`;
                    errorDiv.style.display = 'block';
                }
            });
        }


        // Function to check if profile is complete and route user
        async function checkUserProfile(user) {

            const userDocRef = window.doc(window.firebaseDb, 'users', user.uid);

            try {

                const userDoc = await window.getDoc(userDocRef);

                if (userDoc.exists()) {

                    // Profile complete, log them into the main app

                    currentUser = userDoc.data();

                    initializeMainApp();

                    showScreen('main-app');

                } else if (user.emailVerified && user.providerData.some(p => p.providerId === 'google.com')) {
                    // New Google user, needs profile setup
                    // We check for emailVerified because Google sign-in guarantees a verified email.
                    // This is the specific logic for the image issue resolution: if Google sign-in works,
                    // but the profile isn't in Firestore, show the setup screen.
                    document.getElementById('setup-screen').style.display = 'flex';
                    document.getElementById('login-screen').style.display = 'none';
                    // Pre-fill fields if possible
                    document.getElementById('setup-userid').value = user.displayName ? user.displayName.toLowerCase().replace(/\s/g, '') : '';


                } else {

                    // Other case (e.g., standard email/password login in the future, or unfinished manual registration)

                    // For now, redirect to login if no profile found and not a new Google signup flow

                    showScreen('login-screen');

                }

            } catch (error) {

                console.error("Error checking user profile:", error);

                showScreen('login-screen'); // Fallback to login on error

            }

        }


        function showScreen(screenId) {

            document.getElementById('login-screen').style.display = 'none';

            document.getElementById('setup-screen').style.display = 'none';

            document.getElementById('main-app').style.display = 'none';


            if (screenId === 'main-app') {

                document.getElementById('main-app').style.display = 'flex';

            } else {

                document.getElementById(screenId).style.display = 'flex';

            }

        }

        

        // Main app logic initialization

        function initializeMainApp() {

            // Display current user info

            document.getElementById('user-display-name').textContent = currentUser.displayName;

            document.getElementById('user-id-display').textContent = currentUser.userId;

            
            // Set Avatar (The core of the image issue fix)
            const defaultAvatarSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%236366f1'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='white' font-size='14'%3Eüë§%3C/text%3E%3C/svg%3E";
            const avatarUrl = currentUser.avatar && currentUser.avatar !== 'default_avatar_url' ? currentUser.avatar : defaultAvatarSvg;
            document.getElementById('user-avatar').src = avatarUrl;


            // Initial view setup

            activateHomeView();

            loadUserData();

            setupEventListeners();

        }


        function setupEventListeners() {

            // Logout

            document.getElementById('logout-btn').addEventListener('click', async () => {

                await window.signOut(window.firebaseAuth);

                currentUser = null;

                window.location.reload(); // Simple reload to show login screen

            });

            // Settings button (opens profile modal)
            document.getElementById('settings-btn').addEventListener('click', openProfileModal);
            
            // Modals
            document.getElementById('close-profile-modal').addEventListener('click', closeProfileModal);
            document.getElementById('cancel-create-server').addEventListener('click', () => document.getElementById('create-server-modal').style.display = 'none');
            document.getElementById('cancel-add-friend').addEventListener('click', () => document.getElementById('add-friend-modal').style.display = 'none');
            document.getElementById('add-server-btn').addEventListener('click', () => document.getElementById('create-server-modal').style.display = 'flex');
            document.getElementById('add-friend-btn').addEventListener('click', () => document.getElementById('add-friend-modal').style.display = 'flex');
            document.getElementById('emoji-btn').addEventListener('click', toggleEmojiPicker);
            document.getElementById('home-server').addEventListener('click', activateHomeView);

            // Tabs

            document.querySelectorAll('#nav-tabs button').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentView = e.target.dataset.tab;
                    updateHomeViewTabs();
                });
            });

            // Emoji Picker Clicks
            document.querySelectorAll('#emoji-picker button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const emoji = e.target.dataset.emoji;
                    document.getElementById('message-input').value += emoji;
                    document.getElementById('emoji-picker').style.display = 'none';
                });
            });

            // Profile Form Toggle
            const profileForm = document.getElementById('profile-form');
            const editProfileBtn = document.getElementById('edit-profile-btn');

            editProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const isEditing = profileForm.style.display === 'block';
                profileForm.style.display = isEditing ? 'none' : 'block';
                editProfileBtn.textContent = isEditing ? 'Edit Profile' : 'View Profile';
                document.getElementById('profile-display-name').style.display = isEditing ? 'block' : 'none';
                document.getElementById('profile-user-id').style.display = isEditing ? 'block' : 'none';
            });

            document.getElementById('cancel-profile-edit').addEventListener('click', () => {
                profileForm.style.display = 'none';
                editProfileBtn.textContent = 'Edit Profile';
                document.getElementById('profile-display-name').style.display = 'block';
                document.getElementById('profile-user-id').style.display = 'block';
            });
        }
        
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        }

        function updateHomeViewTabs() {
            document.querySelectorAll('#nav-tabs button').forEach(button => {
                if (button.dataset.tab === currentView) {
                    button.classList.add('bg-gray-600', 'text-white');
                    button.classList.remove('text-gray-400', 'hover:text-white');
                } else {
                    button.classList.remove('bg-gray-600', 'text-white');
                    button.classList.add('text-gray-400', 'hover:text-white');
                }
            });

            document.getElementById('friends-panel').style.display = currentView === 'friends' ? 'block' : 'none';
            document.getElementById('dms-panel').style.display = currentView === 'dms' ? 'block' : 'none';
        }


        function activateHomeView() {
            // Logic to switch to the Home/DM view (Friends list and DMs)
            document.getElementById('current-server-info').innerHTML = `<i data-lucide="users" class="w-5 h-5 text-gray-400"></i><span class="font-semibold">Direct Messages</span>`;
            document.getElementById('nav-tabs').style.display = 'flex';
            document.getElementById('channels-panel').style.display = 'none';
            document.getElementById('friends-panel').style.display = currentView === 'friends' ? 'block' : 'none';
            document.getElementById('dms-panel').style.display = currentView === 'dms' ? 'block' : 'none';
            document.getElementById('chat-icon').setAttribute('data-lucide', 'hash'); // Placeholder
            document.getElementById('chat-title').textContent = 'Welcome';

            updateHomeViewTabs();
            lucide.createIcons(); // Re-render lucide icons

        }


        function openProfileModal() {
            // Fill modal fields with current user data
            const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%236366f1'/%3E%3Ctext x='40' y='50' text-anchor='middle' fill='white' font-size='32'%3Eüë§%3C/text%3E%3C/svg%3E";
            const profileAvatarUrl = currentUser.avatar && currentUser.avatar !== 'default_avatar_url' ? currentUser.avatar : defaultAvatar;
            
            document.getElementById('profile-display-name').textContent = currentUser.displayName;
            document.getElementById('profile-user-id').textContent = currentUser.userId;
            document.getElementById('profile-avatar').src = profileAvatarUrl;

            document.getElementById('profile-name-input').value = currentUser.displayName;
            document.getElementById('profile-bio-input').value = currentUser.bio || '';


            // Show the modal
            document.getElementById('profile-modal').style.display = 'flex';
            
            // Hide form and show static info initially
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('edit-profile-btn').textContent = 'Edit Profile';
            document.getElementById('profile-display-name').style.display = 'block';
            document.getElementById('profile-user-id').style.display = 'block';

        }


        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }


        // Placeholder for loading initial data (friends, servers, etc.)

        function loadUserData() {

            // In a real app, this would fetch data from Firestore:

            // 1. Fetch servers (if any) and populate server-list

            // 2. Fetch friends and friend requests, populate friends-panel

            // 3. Fetch DMs, populate dms-panel


            // TEMPORARY MOCK DATA POPULATION:

            // Mock Friends

            const mockOnlineFriends = [

                { displayName: 'Vaidik', userId: '@vaidik', status: 'online' },

                { displayName: 'CoderGuru', userId: '@coder', status: 'idle' },

                { displayName: 'GamerMax', userId: '@max', status: 'dnd' }

            ];

            const mockAllFriends = [

                ...mockOnlineFriends,

                { displayName: 'OfflineFriend', userId: '@offline', status: 'offline' },

                { displayName: 'AnotherUser', userId: '@another', status: 'offline' },

            ];

            

            document.getElementById('online-friends-count').textContent = mockOnlineFriends.length;

            document.getElementById('all-friends-count').textContent = mockAllFriends.length;

            

            const renderFriend = (friend) => `

                <div class="flex items-center justify-between p-2 hover:bg-gray-700 rounded transition duration-150 cursor-pointer slide-in">

                    <div class="flex items-center space-x-3">

                        <div class="relative">

                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%2340444b'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='white' font-size='14'%3E${friend.displayName.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E"

                                 class="w-8 h-8 rounded-full" alt="Avatar">

                            <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 status-${friend.status} rounded-full border-2 border-gray-800"></div>

                        </div>

                        <div>

                            <div class="font-medium text-white">${friend.displayName}</div>

                            <div class="text-gray-400 text-sm">${friend.userId}</div>

                        </div>

                    </div>

                    ${friend.status !== 'offline' ? `

                        <div class="flex space-x-2">

                            <button class="p-1 hover:bg-gray-600 rounded" title="Start DM">

                                <i data-lucide="message-square" class="w-4 h-4 text-gray-400"></i>

                            </button>

                            <button class="p-1 hover:bg-gray-600 rounded" title="More Options">

                                <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>

                            </button>

                        </div>` : ''}

                </div>

            `;

            
            document.getElementById('online-friends-list').innerHTML = mockOnlineFriends.map(renderFriend).join('');

            document.getElementById('all-friends-list').innerHTML = mockAllFriends.map(renderFriend).join('');

            
            // Mock Friend Requests

            const mockRequests = [

                { displayName: 'NewGuy', userId: '@newguy' },

                { displayName: 'TestUser', userId: '@testuser' },

            ];

            document.getElementById('friend-requests-count').textContent = mockRequests.length;

            const renderRequest = (request) => `

                <div class="flex items-center justify-between p-2 bg-gray-700 hover:bg-gray-600 rounded transition duration-150 slide-in">

                    <div class="flex items-center space-x-3">

                        <div class="relative">

                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23f04747'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='white' font-size='14'%3E${request.displayName.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E"

                                 class="w-8 h-8 rounded-full" alt="Avatar">

                            <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 status-dnd rounded-full border-2 border-gray-800"></div>

                        </div>

                        <div>

                            <div class="font-medium text-white">${request.displayName}</div>

                            <div class="text-gray-400 text-sm">${request.userId}</div>

                        </div>

                    </div>

                    <div class="flex space-x-2">

                        <button class="p-1 text-green-500 hover:text-green-400" title="Accept">

                            <i data-lucide="check" class="w-5 h-5"></i>

                        </button>

                        <button class="p-1 text-red-500 hover:text-red-400" title="Decline">

                            <i data-lucide="x" class="w-5 h-5"></i>

                        </button>

                    </div>

                </div>

            `;

            document.getElementById('friend-requests-list').innerHTML = mockRequests.map(renderRequest).join('');

            
            lucide.createIcons(); // Ensure new icons are rendered

        }

        // Placeholder for sending messages

        document.getElementById('message-input').addEventListener('keypress', (e) => {

            if (e.key === 'Enter' && e.target.value.trim() !== '') {

                console.log('Sending message:', e.target.value.trim());

                // In a real app, this would send to Firestore/Realtime DB

                e.target.value = ''; // Clear input

            }

        });


    </script>


</body>

</html>
