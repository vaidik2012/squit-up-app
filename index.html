<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQUIT up - Discord Clone</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #36393f;
            color: #dcddde;
            height: 100%;
            overflow: hidden;
        }

        html, body {
            height: 100%;
        }

        /* Auth Screen */
        .auth-container {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .btn-google {
            background: #fff;
            color: #333;
            border: 2px solid #e1e5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-google:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        /* User ID Creation */
        .userid-container {
            display: none;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        .success-message {
            color: #27ae60;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Main App */
        .app-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .app-header {
            background: #2f3136;
            padding: 10px 20px;
            display: flex;
            justify-content: between;
            align-items: center;
            border-bottom: 1px solid #202225;
            min-height: 50px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .app-body {
            display: flex;
            height: calc(100% - 70px);
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #202225;
        }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid #202225;
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: #8e9297;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-btn {
            background: none;
            border: none;
            color: #8e9297;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
        }

        .add-btn:hover {
            color: #dcddde;
        }

        .sidebar-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-item:hover {
            background: #393c43;
        }

        .sidebar-item.active {
            background: #5865f2;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3ba55c;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: #36393f;
            padding: 12px 20px;
            border-bottom: 1px solid #202225;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .content-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            color: #dcddde;
        }

        .message-time {
            font-size: 12px;
            color: #72767d;
        }

        .message-text {
            color: #dcddde;
            line-height: 1.4;
        }

        /* Message Input */
        .message-input-container {
            padding: 20px;
            background: #36393f;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            background: #40444b;
            border: none;
            border-radius: 8px;
            color: #dcddde;
            font-size: 14px;
            box-sizing: border-box;
        }

        .message-input:focus {
            outline: none;
        }

        .message-input::placeholder {
            color: #72767d;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #36393f;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 440px;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #dcddde;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #8e9297;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-input {
            padding: 12px;
            background: #40444b;
            border: 1px solid #202225;
            border-radius: 4px;
            color: #dcddde;
            font-size: 14px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #5865f2;
        }

        .modal-btn {
            padding: 12px 24px;
            background: #5865f2;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn:hover {
            background: #4752c4;
        }

        .modal-btn:disabled {
            background: #4f545c;
            cursor: not-allowed;
        }

        /* Friend Requests */
        .friend-request {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #2f3136;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .friend-request-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .friend-request-actions {
            display: flex;
            gap: 8px;
        }

        .btn-accept {
            background: #3ba55c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-decline {
            background: #ed4245;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Profile Modal */
        .profile-section {
            margin-bottom: 20px;
        }

        .profile-section h3 {
            color: #dcddde;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .profile-banner {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            margin: 0 auto 16px;
            position: relative;
            top: -40px;
            border: 4px solid #36393f;
        }

        .upload-btn {
            background: #4f545c;
            color: #dcddde;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }

        .upload-btn:hover {
            background: #5d6269;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="logo">SQUIT up</div>
            <div class="subtitle">Connect with friends and communities</div>
            <button class="btn btn-google" onclick="simulateGoogleAuth()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- User ID Creation Screen -->
    <div id="useridScreen" class="userid-container">
        <div class="auth-card">
            <div class="logo">Create Your @user_id</div>
            <div class="subtitle">Choose a unique username for SQUIT up</div>
            <form onsubmit="createUserId(event)">
                <div class="form-group">
                    <label for="userid">@user_id</label>
                    <input type="text" id="userid" placeholder="Enter your unique @user_id" required>
                    <div id="useridError" class="error-message"></div>
                    <div id="useridSuccess" class="success-message"></div>
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="app-container">
        <div class="app-header">
            <div class="logo" style="font-size: 1.5rem;">SQUIT up</div>
            <div class="user-info">
                <div class="user-avatar" id="headerAvatar">U</div>
                <span id="headerUsername">@username</span>
                <button class="add-btn" onclick="showProfileModal()" title="Profile Settings">‚öôÔ∏è</button>
                <button class="add-btn" onclick="signOut()" title="Sign Out">üö™</button>
            </div>
        </div>

        <div class="app-body">
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        Direct Messages
                        <button class="add-btn" onclick="showAddFriendModal()" title="Add Friend">+</button>
                    </div>
                    <div id="dmList">
                        <!-- DM list will be populated here -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">
                        Friends Online
                    </div>
                    <div id="friendsList">
                        <!-- Friends list will be populated here -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">
                        Servers
                        <button class="add-btn" onclick="showCreateServerModal()" title="Create Server">+</button>
                    </div>
                    <div id="serversList">
                        <!-- Servers list will be populated here -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">
                        Friend Requests
                        <span id="friendRequestCount" style="background: #ed4245; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 8px;"></span>
                    </div>
                    <div id="friendRequestsList">
                        <!-- Friend requests will be populated here -->
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="content-header">
                    <span id="currentChannelName"># general</span>
                </div>
                <div class="content-body" id="messagesContainer">
                    <!-- Messages will be populated here -->
                </div>
                <div class="message-input-container">
                    <input type="text" class="message-input" id="messageInput" placeholder="Message #general" onkeypress="handleMessageInput(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addFriendModal')">&times;</button>
            <div class="modal-header">Add Friend</div>
            <form class="modal-form" onsubmit="sendFriendRequest(event)">
                <input type="text" class="modal-input" id="friendUserId" placeholder="Enter @user_id" required>
                <div id="friendRequestError" class="error-message"></div>
                <div id="friendRequestSuccess" class="success-message"></div>
                <button type="submit" class="modal-btn">Send Friend Request</button>
            </form>
        </div>
    </div>

    <!-- Create Server Modal -->
    <div id="createServerModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('createServerModal')">&times;</button>
            <div class="modal-header">Create Server</div>
            <form class="modal-form" onsubmit="createServer(event)">
                <input type="text" class="modal-input" id="serverName" placeholder="Server Name" required>
                <button type="submit" class="modal-btn">Create Server</button>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('profileModal')">&times;</button>
            <div class="modal-header">Profile Settings</div>
            <div class="profile-section">
                <h3>Banner</h3>
                <div class="profile-banner" id="profileBanner"></div>
                <button class="upload-btn" onclick="changeBanner()">Change Banner</button>
            </div>
            <div class="profile-section">
                <h3>Avatar</h3>
                <div class="profile-avatar-large" id="profileAvatarLarge">U</div>
                <button class="upload-btn" onclick="changeAvatar()">Change Avatar</button>
            </div>
            <div class="profile-section">
                <h3>User ID</h3>
                <p style="color: #8e9297; font-size: 14px;">Your @user_id cannot be changed once created</p>
                <input type="text" class="modal-input" id="profileUserId" disabled>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('squitup_users') || '{}');
        let friendRequests = JSON.parse(localStorage.getItem('squitup_friend_requests') || '{}');
        let friends = JSON.parse(localStorage.getItem('squitup_friends') || '{}');
        let messages = JSON.parse(localStorage.getItem('squitup_messages') || '{}');
        let servers = JSON.parse(localStorage.getItem('squitup_servers') || '{}');
        let currentChannel = 'general';
        let currentServerId = 'default';

        // Initialize app
        function init() {
            const savedUser = localStorage.getItem('squitup_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showAuthScreen();
            }
        }

        // Screen management
        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('useridScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'none';
        }

        function showUserIdScreen() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('useridScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('useridScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'flex';
            
            updateUI();
            loadMessages();
            loadFriends();
            loadFriendRequests();
            loadServers();
        }

        // Realistic Google OAuth simulation
        function simulateGoogleAuth() {
            // Create realistic Google OAuth popup
            const popup = window.open('', 'google-oauth', 'width=500,height=600,scrollbars=yes,resizable=yes');
            
            // Simulate Google OAuth page
            popup.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sign in - Google Accounts</title>
                    <style>
                        body { 
                            font-family: 'Google Sans', Roboto, Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            background: #fff;
                        }
                        .container { 
                            max-width: 400px; 
                            margin: 50px auto; 
                            text-align: center; 
                        }
                        .google-logo { 
                            font-size: 24px; 
                            color: #4285f4; 
                            margin-bottom: 20px; 
                            font-weight: 400;
                        }
                        h1 { 
                            font-size: 24px; 
                            font-weight: 400; 
                            color: #202124; 
                            margin-bottom: 8px;
                        }
                        p { 
                            color: #5f6368; 
                            font-size: 14px; 
                            margin-bottom: 30px;
                        }
                        .account-list { 
                            border: 1px solid #dadce0; 
                            border-radius: 8px; 
                            overflow: hidden;
                        }
                        .account { 
                            padding: 16px; 
                            border-bottom: 1px solid #dadce0; 
                            cursor: pointer; 
                            display: flex; 
                            align-items: center; 
                            gap: 12px;
                            transition: background 0.2s;
                        }
                        .account:hover { 
                            background: #f8f9fa; 
                        }
                        .account:last-child { 
                            border-bottom: none; 
                        }
                        .avatar { 
                            width: 32px; 
                            height: 32px; 
                            border-radius: 50%; 
                            background: #4285f4; 
                            color: white; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-weight: 500;
                        }
                        .account-info { 
                            text-align: left; 
                            flex: 1;
                        }
                        .name { 
                            font-weight: 500; 
                            color: #202124; 
                            font-size: 14px;
                        }
                        .email { 
                            color: #5f6368; 
                            font-size: 14px;
                        }
                        .add-account { 
                            padding: 16px; 
                            color: #1a73e8; 
                            cursor: pointer; 
                            font-size: 14px;
                        }
                        .add-account:hover { 
                            background: #f8f9fa; 
                        }
                        .loading { 
                            display: none; 
                            margin: 20px 0; 
                            color: #5f6368;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="google-logo">Google</div>
                        <h1>Choose an account</h1>
                        <p>to continue to SQUIT up</p>
                        
                        <div class="account-list">
                            <div class="account" onclick="selectAccount('john.doe@gmail.com', 'John Doe')">
                                <div class="avatar">J</div>
                                <div class="account-info">
                                    <div class="name">John Doe</div>
                                    <div class="email">john.doe@gmail.com</div>
                                </div>
                            </div>
                            <div class="account" onclick="selectAccount('sarah.smith@gmail.com', 'Sarah Smith')">
                                <div class="avatar">S</div>
                                <div class="account-info">
                                    <div class="name">Sarah Smith</div>
                                    <div class="email">sarah.smith@gmail.com</div>
                                </div>
                            </div>
                            <div class="account" onclick="selectAccount('mike.wilson@gmail.com', 'Mike Wilson')">
                                <div class="avatar">M</div>
                                <div class="account-info">
                                    <div class="name">Mike Wilson</div>
                                    <div class="email">mike.wilson@gmail.com</div>
                                </div>
                            </div>
                            <div class="add-account" onclick="addNewAccount()">
                                ‚ûï Use another account
                            </div>
                        </div>
                        
                        <div class="loading" id="loading">
                            <p>Signing you in...</p>
                        </div>
                    </div>
                    
                    <script>
                        function selectAccount(email, name) {
                            document.querySelector('.account-list').style.display = 'none';
                            document.getElementById('loading').style.display = 'block';
                            
                            setTimeout(() => {
                                window.opener.handleGoogleAuthSuccess(email, name);
                                window.close();
                            }, 2000);
                        }
                        
                        function addNewAccount() {
                            const email = prompt('Enter your Gmail address:');
                            if (email && email.includes('@gmail.com')) {
                                const name = email.split('@')[0].replace(/[._]/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());
                                selectAccount(email, name);
                            } else if (email) {
                                alert('Please enter a valid Gmail address');
                            }
                        }
                    </script>
                <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98d4f43562bc8584',t:'MTc2MDI1NDg3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
                </html>
            `);
            
            popup.document.close();
        }

        // Handle successful Google authentication
        window.handleGoogleAuthSuccess = function(email, name) {
            // Check if user already exists with this email
            const existingUser = Object.values(users).find(user => user.email === email);
            if (existingUser) {
                currentUser = existingUser;
                localStorage.setItem('squitup_current_user', JSON.stringify(currentUser));
                showApp();
            } else {
                // New user needs to create @user_id
                localStorage.setItem('squitup_temp_email', email);
                localStorage.setItem('squitup_temp_name', name);
                showUserIdScreen();
            }
        }

        // User ID creation with strict validation
        function createUserId(event) {
            event.preventDefault();
            
            const useridInput = document.getElementById('userid');
            const errorDiv = document.getElementById('useridError');
            const successDiv = document.getElementById('useridSuccess');
            const email = localStorage.getItem('squitup_temp_email');
            const name = localStorage.getItem('squitup_temp_name');
            
            let userid = useridInput.value.trim().toLowerCase();
            
            // Clear previous messages
            errorDiv.textContent = '';
            successDiv.textContent = '';
            
            // Validation rules
            if (userid.length < 3) {
                errorDiv.textContent = '@user_id must be at least 3 characters long';
                return;
            }
            
            if (userid.length > 20) {
                errorDiv.textContent = '@user_id must be less than 20 characters';
                return;
            }
            
            if (!/^[a-z0-9_]+$/.test(userid)) {
                errorDiv.textContent = '@user_id can only contain lowercase letters, numbers, and underscores';
                return;
            }
            
            if (userid.startsWith('_') || userid.endsWith('_')) {
                errorDiv.textContent = '@user_id cannot start or end with underscore';
                return;
            }
            
            // Check if user_id already exists (CRITICAL VALIDATION)
            if (users[userid]) {
                errorDiv.textContent = 'This @user_id is already taken. Please choose another one.';
                return;
            }
            
            // Create new user
            currentUser = {
                userid: userid,
                email: email,
                name: name,
                avatar: userid.charAt(0).toUpperCase(),
                banner: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                createdAt: Date.now()
            };
            
            // Save user to database
            users[userid] = currentUser;
            localStorage.setItem('squitup_users', JSON.stringify(users));
            localStorage.setItem('squitup_current_user', JSON.stringify(currentUser));
            localStorage.removeItem('squitup_temp_email');
            localStorage.removeItem('squitup_temp_name');
            
            successDiv.textContent = 'Account created successfully!';
            
            setTimeout(() => {
                showApp();
            }, 1000);
        }

        // Friend request system with validation
        function sendFriendRequest(event) {
            event.preventDefault();
            
            const friendUserIdInput = document.getElementById('friendUserId');
            const errorDiv = document.getElementById('friendRequestError');
            const successDiv = document.getElementById('friendRequestSuccess');
            
            let targetUserId = friendUserIdInput.value.trim().toLowerCase();
            
            // Clear previous messages
            errorDiv.textContent = '';
            successDiv.textContent = '';
            
            // Remove @ if user typed it
            if (targetUserId.startsWith('@')) {
                targetUserId = targetUserId.substring(1);
            }
            
            // Validation
            if (targetUserId === currentUser.userid) {
                errorDiv.textContent = 'You cannot send a friend request to yourself';
                return;
            }
            
            // Check if target user exists (CRITICAL VALIDATION)
            if (!users[targetUserId]) {
                errorDiv.textContent = 'User @' + targetUserId + ' does not exist';
                return;
            }
            
            // Check if already friends
            if (friends[currentUser.userid] && friends[currentUser.userid].includes(targetUserId)) {
                errorDiv.textContent = 'You are already friends with @' + targetUserId;
                return;
            }
            
            // Check if friend request already sent
            if (friendRequests[targetUserId] && friendRequests[targetUserId].some(req => req.from === currentUser.userid)) {
                errorDiv.textContent = 'Friend request already sent to @' + targetUserId;
                return;
            }
            
            // Check if there's a pending request from them
            if (friendRequests[currentUser.userid] && friendRequests[currentUser.userid].some(req => req.from === targetUserId)) {
                errorDiv.textContent = '@' + targetUserId + ' has already sent you a friend request. Check your friend requests.';
                return;
            }
            
            // Send friend request
            if (!friendRequests[targetUserId]) {
                friendRequests[targetUserId] = [];
            }
            
            friendRequests[targetUserId].push({
                from: currentUser.userid,
                timestamp: Date.now()
            });
            
            localStorage.setItem('squitup_friend_requests', JSON.stringify(friendRequests));
            
            successDiv.textContent = 'Friend request sent to @' + targetUserId + '!';
            friendUserIdInput.value = '';
            
            setTimeout(() => {
                closeModal('addFriendModal');
            }, 1500);
        }

        // Accept friend request
        function acceptFriendRequest(fromUserId) {
            // Add to friends list
            if (!friends[currentUser.userid]) {
                friends[currentUser.userid] = [];
            }
            if (!friends[fromUserId]) {
                friends[fromUserId] = [];
            }
            
            friends[currentUser.userid].push(fromUserId);
            friends[fromUserId].push(currentUser.userid);
            
            // Remove friend request
            friendRequests[currentUser.userid] = friendRequests[currentUser.userid].filter(req => req.from !== fromUserId);
            
            localStorage.setItem('squitup_friends', JSON.stringify(friends));
            localStorage.setItem('squitup_friend_requests', JSON.stringify(friendRequests));
            
            loadFriends();
            loadFriendRequests();
        }

        // Decline friend request
        function declineFriendRequest(fromUserId) {
            friendRequests[currentUser.userid] = friendRequests[currentUser.userid].filter(req => req.from !== fromUserId);
            localStorage.setItem('squitup_friend_requests', JSON.stringify(friendRequests));
            loadFriendRequests();
        }

        // Load and display friend requests
        function loadFriendRequests() {
            const container = document.getElementById('friendRequestsList');
            const countElement = document.getElementById('friendRequestCount');
            
            const userRequests = friendRequests[currentUser.userid] || [];
            
            if (userRequests.length === 0) {
                container.innerHTML = '<div style="color: #8e9297; font-size: 12px; padding: 8px;">No pending requests</div>';
                countElement.textContent = '';
                countElement.style.display = 'none';
            } else {
                countElement.textContent = userRequests.length;
                countElement.style.display = 'inline';
                
                container.innerHTML = userRequests.map(request => {
                    const fromUser = users[request.from];
                    return `
                        <div class="friend-request">
                            <div class="friend-request-info">
                                <div class="user-avatar">${fromUser.avatar}</div>
                                <span>@${fromUser.userid}</span>
                            </div>
                            <div class="friend-request-actions">
                                <button class="btn-accept" onclick="acceptFriendRequest('${request.from}')">‚úì</button>
                                <button class="btn-decline" onclick="declineFriendRequest('${request.from}')">‚úó</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Load and display friends
        function loadFriends() {
            const container = document.getElementById('friendsList');
            const dmContainer = document.getElementById('dmList');
            
            const userFriends = friends[currentUser.userid] || [];
            
            if (userFriends.length === 0) {
                container.innerHTML = '<div style="color: #8e9297; font-size: 12px; padding: 8px;">No friends yet</div>';
                dmContainer.innerHTML = '<div style="color: #8e9297; font-size: 12px; padding: 8px;">No conversations</div>';
            } else {
                // Friends list (online friends)
                container.innerHTML = userFriends.map(friendId => {
                    const friend = users[friendId];
                    return `
                        <div class="sidebar-item" onclick="openDM('${friendId}')">
                            <div class="online-indicator"></div>
                            <div class="user-avatar">${friend.avatar}</div>
                            <span>@${friend.userid}</span>
                        </div>
                    `;
                }).join('');
                
                // DM list (only friends you've talked to)
                const conversationFriends = userFriends.filter(friendId => {
                    const dmKey = [currentUser.userid, friendId].sort().join('_');
                    return messages[dmKey] && messages[dmKey].length > 0;
                });
                
                if (conversationFriends.length === 0) {
                    dmContainer.innerHTML = '<div style="color: #8e9297; font-size: 12px; padding: 8px;">No conversations</div>';
                } else {
                    dmContainer.innerHTML = conversationFriends.map(friendId => {
                        const friend = users[friendId];
                        return `
                            <div class="sidebar-item" onclick="openDM('${friendId}')">
                                <div class="user-avatar">${friend.avatar}</div>
                                <span>@${friend.userid}</span>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        // Open DM conversation
        function openDM(friendId) {
            currentChannel = `dm_${friendId}`;
            currentServerId = null;
            
            const friend = users[friendId];
            document.getElementById('currentChannelName').textContent = `@${friend.userid}`;
            document.getElementById('messageInput').placeholder = `Message @${friend.userid}`;
            
            loadMessages();
        }

        // Create server
        function createServer(event) {
            event.preventDefault();
            
            const serverName = document.getElementById('serverName').value.trim();
            if (!serverName) return;
            
            const serverId = 'server_' + Date.now();
            servers[serverId] = {
                name: serverName,
                owner: currentUser.userid,
                channels: ['general'],
                members: [currentUser.userid],
                createdAt: Date.now()
            };
            
            localStorage.setItem('squitup_servers', JSON.stringify(servers));
            document.getElementById('serverName').value = '';
            closeModal('createServerModal');
            loadServers();
        }

        // Load servers
        function loadServers() {
            const container = document.getElementById('serversList');
            
            const userServers = Object.entries(servers).filter(([id, server]) => 
                server.members.includes(currentUser.userid)
            );
            
            if (userServers.length === 0) {
                container.innerHTML = '<div style="color: #8e9297; font-size: 12px; padding: 8px;">No servers</div>';
            } else {
                container.innerHTML = userServers.map(([serverId, server]) => `
                    <div class="sidebar-item ${currentServerId === serverId ? 'active' : ''}" onclick="openServer('${serverId}')">
                        <span>${server.name}</span>
                    </div>
                `).join('');
            }
        }

        // Open server
        function openServer(serverId) {
            currentServerId = serverId;
            currentChannel = 'general';
            
            const server = servers[serverId];
            document.getElementById('currentChannelName').textContent = `# general`;
            document.getElementById('messageInput').placeholder = `Message #general`;
            
            loadMessages();
            loadServers(); // Refresh to update active state
        }

        // Message handling
        function handleMessageInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            let messageKey;
            if (currentChannel.startsWith('dm_')) {
                const friendId = currentChannel.replace('dm_', '');
                messageKey = [currentUser.userid, friendId].sort().join('_');
            } else {
                messageKey = currentServerId ? `${currentServerId}_${currentChannel}` : currentChannel;
            }
            
            if (!messages[messageKey]) {
                messages[messageKey] = [];
            }
            
            messages[messageKey].push({
                author: currentUser.userid,
                text: text,
                timestamp: Date.now()
            });
            
            localStorage.setItem('squitup_messages', JSON.stringify(messages));
            input.value = '';
            
            loadMessages();
            loadFriends(); // Refresh to update DM list
        }

        // Load messages
        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            
            let messageKey;
            if (currentChannel.startsWith('dm_')) {
                const friendId = currentChannel.replace('dm_', '');
                messageKey = [currentUser.userid, friendId].sort().join('_');
            } else {
                messageKey = currentServerId ? `${currentServerId}_${currentChannel}` : currentChannel;
            }
            
            const channelMessages = messages[messageKey] || [];
            
            if (channelMessages.length === 0) {
                container.innerHTML = '<div style="color: #8e9297; text-align: center; margin-top: 50px;">No messages yet. Start the conversation!</div>';
            } else {
                container.innerHTML = channelMessages.map(message => {
                    const author = users[message.author];
                    const time = new Date(message.timestamp).toLocaleTimeString();
                    
                    return `
                        <div class="message">
                            <div class="message-avatar">${author.avatar}</div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-author">@${author.userid}</span>
                                    <span class="message-time">${time}</span>
                                </div>
                                <div class="message-text">${message.text}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            container.scrollTop = container.scrollHeight;
        }

        // Profile management
        function showProfileModal() {
            document.getElementById('profileUserId').value = '@' + currentUser.userid;
            document.getElementById('profileAvatarLarge').textContent = currentUser.avatar;
            document.getElementById('profileBanner').style.background = currentUser.banner;
            document.getElementById('profileModal').style.display = 'flex';
        }

        function changeAvatar() {
            const newAvatar = prompt('Enter a single character for your avatar:', currentUser.avatar);
            if (newAvatar && newAvatar.length === 1) {
                currentUser.avatar = newAvatar.toUpperCase();
                users[currentUser.userid] = currentUser;
                localStorage.setItem('squitup_users', JSON.stringify(users));
                localStorage.setItem('squitup_current_user', JSON.stringify(currentUser));
                updateUI();
                document.getElementById('profileAvatarLarge').textContent = currentUser.avatar;
            }
        }

        function changeBanner() {
            const colors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
            ];
            
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            currentUser.banner = randomColor;
            users[currentUser.userid] = currentUser;
            localStorage.setItem('squitup_users', JSON.stringify(users));
            localStorage.setItem('squitup_current_user', JSON.stringify(currentUser));
            document.getElementById('profileBanner').style.background = randomColor;
        }

        // UI updates
        function updateUI() {
            document.getElementById('headerAvatar').textContent = currentUser.avatar;
            document.getElementById('headerUsername').textContent = '@' + currentUser.userid;
        }

        // Modal management
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Clear form data
            const modal = document.getElementById(modalId);
            const inputs = modal.querySelectorAll('input[type="text"]');
            inputs.forEach(input => {
                if (!input.disabled) input.value = '';
            });
            
            const errorDivs = modal.querySelectorAll('.error-message, .success-message');
            errorDivs.forEach(div => div.textContent = '');
        }

        function showAddFriendModal() {
            document.getElementById('addFriendModal').style.display = 'flex';
        }

        function showCreateServerModal() {
            document.getElementById('createServerModal').style.display = 'flex';
        }

        // Sign out
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('squitup_current_user');
                currentUser = null;
                showAuthScreen();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize app when page loads
        init();
    </script>
</body>
</html>
