<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURY - Real-Time Chat</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-black': '#000000', 
                        'chat-bg': '#111111', // Slightly off-black for chat area distinction
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Solid Black Background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white; /* Default text color is white */
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05); /* Very subtle transparent background */
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.5);
        }
        /* RAINBOW GRADIENT for the FURY title */
        .main-title {
            background: linear-gradient(90deg, #ff0000, #ff8000, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .button-google {
            background-color: #db4437; /* Google Red */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        .button-google:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        /* Custom scrollbar for message list */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: #111111;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4">

    <!-- Firebase SDKs (using type="module" for ES6 imports) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE AND CONFIGURATION ---
        let auth, db, userProfile = {};
        let isAuthReady = false;
        
        // Use provided global variables or fallback for local testing
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-fury-chat';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAzY-L_W8V7dOqg3M-G6y2e4aP7i",
            authDomain: "squit-up-auth.firebaseapp.com", // Keep this if using the existing project
            projectId: "squit-up-auth", // Keep this if using the existing project
            storageBucket: "squit-up-auth.appspot.com",
            messagingSenderId: "58591888443",
            appId: "1:58591888443:web:2a3e5e24c6d4f1638b80e"
        };
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- UI Element References ---
        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const usernameDisplay = document.getElementById('username-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const errorDisplay = document.getElementById('error-display');

        // --- INITIALIZATION AND AUTHENTICATION ---
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage('Firebase initialization failed. Check console for details.', 'error');
                return;
            }

            // Authentication listener to switch between screens
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userProfile.uid = user.uid;
                    // Prefer displayName from Google/provider, fallback to UID
                    userProfile.name = user.displayName || 'Fury User ' + user.uid.substring(0, 4);
                    // Use actual photoURL or simple placeholder
                    userProfile.photoURL = user.photoURL || 'https://placehold.co/150x150/111111/ffffff?text=' + (userProfile.name[0] || '?');
                    
                    userIdDisplay.textContent = `UID: ${user.uid}`;

                    // Update UI and start chat listener
                    usernameDisplay.textContent = userProfile.name;
                    showChatScreen();
                    
                    // Fetch or set user data in Firestore (Private profile data)
                    await ensureUserProfileExists(user);

                } else {
                    // Sign-out or initial state
                    userProfile = {};
                    showAuthScreen();
                    await initialSignIn();
                }
                isAuthReady = true;
            });
        });

        async function initialSignIn() {
            try {
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Auth Error during initial sign-in:", error);
            }
        }

        // --- Google Sign-In (The ONLY method) ---
        window.handleGoogleSignIn = async () => {
            errorDisplay.textContent = ''; 
            try {
                const provider = new GoogleAuthProvider();
                // We use sign-in with redirect for GitHub Pages environments to avoid CORS/popup issues
                // However, since we used popup successfully before, we'll keep that for simplicity unless errors occur.
                await signInWithPopup(auth, provider);
                // onAuthStateChanged listener handles the rest
            } catch (error) {
                handleAuthError(error);
            }
        };
        
        // --- Sign Out ---
        window.handleSignOut = async () => {
            try {
                await signOut(auth);
                showMessage('Signed out. Goodbye!', 'info');
            } catch (error) {
                console.error("Sign out error:", error);
            }
        };

        // --- UI TRANSITION LOGIC ---

        function showAuthScreen() {
            if (authScreen) authScreen.classList.remove('hidden');
            if (chatScreen) chatScreen.classList.add('hidden');
        }

        function showChatScreen() {
            if (authScreen) authScreen.classList.add('hidden');
            if (chatScreen) chatScreen.classList.remove('hidden');
            startMessageListener();
        }


        // --- CHAT LOGIC ---
        
        let unsubscribeMessages = null;

        function startMessageListener() {
            if (!db || !userProfile.uid || unsubscribeMessages) return;

            // Use a public collection for group chat
            const chatCollectionPath = `artifacts/${appId}/public/data/messages`;
            // Order by timestamp to maintain chat order
            const q = query(collection(db, chatCollectionPath), orderBy('timestamp', 'asc'));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const message = change.doc.data();
                    const messageId = change.doc.id;
                    
                    if (change.type === "added") {
                        addMessageToUI(message, messageId);
                    }
                });
                // Always scroll to the bottom when new messages arrive
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, (error) => {
                console.error("Error listening to messages:", error);
                showMessage("Could not load messages in real-time.", 'error');
            });
        }
        
        window.sendMessage = async () => {
            const text = messageInput.value.trim();
            if (text === "") return;

            if (!db || !auth.currentUser) {
                showMessage("You must be logged in to send a message.", 'error');
                return;
            }

            try {
                // Public data path
                const chatCollectionPath = `artifacts/${appId}/public/data/messages`;

                await addDoc(collection(db, chatCollectionPath), {
                    text: text,
                    timestamp: serverTimestamp(),
                    userId: auth.currentUser.uid,
                    userName: userProfile.name,
                    userPhoto: userProfile.photoURL 
                });

                messageInput.value = ''; // Clear input
                messageInput.focus();
            } catch (error) {
                console.error("Error sending message:", error);
                showMessage("Failed to send message.", 'error');
            }
        };

        // --- UI Rendering Helpers ---

        function addMessageToUI(message, messageId) {
            const isMe = message.userId === userProfile.uid;

            // Create main message wrapper
            const messageDiv = document.createElement('div');
            messageDiv.id = `msg-${messageId}`;
            messageDiv.className = `flex mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;

            // Determine bubble style and order (simple black/white theme)
            const bubbleClasses = isMe 
                ? 'bg-gray-800 text-white rounded-br-none' 
                : 'bg-gray-900 text-white rounded-tl-none';

            // Format timestamp
            const timeString = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';

            messageDiv.innerHTML = `
                <div class="flex max-w-xs md:max-w-md ${isMe ? 'flex-row-reverse' : 'flex-row'}">
                    <!-- User Avatar -->
                    <img class="w-8 h-8 rounded-full object-cover shadow-md mt-4 ${isMe ? 'ml-2' : 'mr-2'}" 
                         src="${message.userPhoto}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/150x150/111111/ffffff?text=U'" 
                         alt="${message.userName[0]}">
                    
                    <!-- Message Bubble -->
                    <div class="flex flex-col">
                        <!-- Sender Name -->
                        <p class="text-xs ${isMe ? 'text-right text-gray-400 mr-2' : 'text-left text-gray-300 ml-2'} font-semibold mb-0.5">
                            ${isMe ? 'You' : message.userName}
                        </p>
                        <div class="py-2 px-4 rounded-xl shadow-lg ${bubbleClasses}">
                            <p class="text-sm break-words">${message.text}</p>
                            <span class="block text-xs mt-1 text-gray-400 text-right">${timeString}</span>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
        }

        // --- PROFILE MANAGEMENT (PRIVATE DATA) ---

        async function ensureUserProfileExists(user) {
            if (!db || !user.uid) return;

            const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'info');
            try {
                const docSnap = await getDoc(userDocRef);

                if (!docSnap.exists()) {
                    await setDoc(userDocRef, {
                        email: user.email || 'N/A',
                        name: user.displayName || 'Guest',
                        photoURL: user.photoURL || '',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp(),
                    });
                } else {
                    await setDoc(userDocRef, { lastLogin: serverTimestamp() }, { merge: true });
                }
            } catch (error) {
                console.error("Error managing user profile in Firestore:", error);
            }
        }


        // --- GENERAL UTILITIES ---

        // Custom Message Box function (since alert() is forbidden)
        window.showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            const colorMap = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600',
            };

            messageBox.className = `fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-2xl transition-opacity duration-300 ${colorMap[type]}`;
            messageText.textContent = message;
            messageBox.classList.remove('hidden');

            // Hide after 4 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 4000);
        };
        
        function handleAuthError(error) {
            errorDisplay.textContent = '';
            let message = "An unknown error occurred.";

            switch (error.code) {
                case 'auth/popup-closed-by-user':
                    message = 'Google sign-in was canceled.';
                    break;
                case 'auth/unauthorized-domain':
                    message = 'Authorization blocked. Did you add fury.com to your Firebase Authorized Domains?';
                    break;
                default:
                    message = `Auth Error: ${error.message}`;
                    console.error(error);
            }
            errorDisplay.textContent = message;
        }

        // Allow pressing Enter key to send message
        window.checkKey = (event) => {
            if (event.key === 'Enter' && document.activeElement.id === 'message-input') {
                window.sendMessage();
            }
        };

    </script>

    <!-- ---------------------------------------------------- -->
    <!-- CHAT SCREEN (Hidden by default) -->
    <!-- ---------------------------------------------------- -->
    <div id="chat-screen" class="hidden w-full h-full max-w-3xl glass-card rounded-2xl flex flex-col p-0 overflow-hidden" style="max-height: 90vh;">
        
        <!-- Header -->
        <header class="bg-chat-bg p-4 flex justify-between items-center shadow-lg border-b border-white/10">
            <div>
                <!-- FURY Title with Rainbow Gradient -->
                <h1 class="main-title text-3xl font-extrabold">FURY</h1>
                <p id="username-display" class="text-sm text-gray-400"></p>
            </div>
            <div class="flex items-center space-x-4">
                <p id="user-id-display" class="text-xs text-gray-500 truncate max-w-20 sm:max-w-none"></p>
                <button onclick="handleSignOut()"
                        class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-150">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Messages Container -->
        <div id="messages-container" class="flex-grow p-4 overflow-y-auto bg-chat-bg">
            <p class="text-center text-gray-500 pt-10">Welcome to the FURY public chat. Start a conversation!</p>
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-chat-bg border-t border-white/10">
            <div class="flex items-center space-x-3">
                <input type="text" id="message-input" onkeydown="checkKey(event)" placeholder="Type a message..."
                       class="flex-grow px-5 py-3 rounded-xl bg-gray-800 text-white border-transparent focus:border-gray-500 focus:ring-2 focus:ring-gray-600 outline-none transition duration-150 ease-in-out placeholder-gray-400" />
                
                <button onclick="sendMessage()"
                        class="bg-white text-black hover:bg-gray-200 p-3 rounded-xl shadow-lg flex-shrink-0 transition duration-150">
                    <!-- Send Icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <!-- ---------------------------------------------------- -->
    <!-- AUTH SCREEN (Visible by default) -->
    <!-- ---------------------------------------------------- -->
    <div id="auth-screen" class="w-full max-w-sm sm:max-w-md text-center">
        <div class="glass-card p-8 md:p-10 rounded-3xl">

            <h1 class="main-title text-5xl md:text-6xl font-extrabold mb-2 leading-none">FURY</h1>
            <p class="text-gray-300 mb-8 text-lg">Connect with friends instantly.</p>

            <!-- Chat Icon Placeholder (White on dark background) -->
            <div class="mx-auto mb-6 w-20 h-20 rounded-full bg-gray-800 flex justify-center items-center shadow-lg border border-white/20">
                 <!-- Simple SVG Chat Icon -->
                 <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.677a9.986 9.986 0 01-1.253-5.591c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            </div>

            <h2 class="text-3xl font-semibold text-white mb-6">Welcome to FURY</h2>
            <p class="text-gray-400 mb-8">Please sign in with Google to continue.</p>

            <!-- Error Message Display -->
            <p id="error-display" class="text-center text-sm h-5 mb-4 text-red-400"></p>


            <!-- Sign In with Google Button -->
            <button onclick="handleGoogleSignIn()"
                    class="button-google w-full text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transform duration-150 ease-in-out flex items-center justify-center">
                <!-- Google Icon SVG -->
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M43.61 20.083H24V28.98H35.48c-0.55 3.32-2.31 5.92-5.48 7.63v5.82h7.49c4.39-3.95 6.89-9.87 6.89-16.75 0-1.15-0.1-2.26-0.3-3.32z" fill="#FFFFFF"/><path d="M24 44c6.33 0 11.66-2.11 15.54-5.74l-7.49-5.82c-2.07 1.39-4.71 2.2-8.05 2.2-6.19 0-11.41-3.15-13.43-7.83H2.9v5.99c4.09 7.97 12.3 13.5 21.1 13.5z" fill="#FFFFFF"/><path d="M10.57 28.16c-0.95-2.7-0.95-5.59 0-8.29V13.88H2.9c-2.73 5.37-2.73 11.69 0 17.06l7.67-4.14z" fill="#FFFFFF"/><path d="M24 10.15c3.48 0 6.62 1.2 9.09 3.49l6.5-6.5c-4.47-4.14-10.42-6.54-15.59-6.54-8.8 0-17.01 5.53-21.1 13.5l7.67 4.14c2.02-4.68 7.24-7.83 13.43-7.83z" fill="#FFFFFF"/></svg>
                Sign in with Google
            </button>

            <!-- Footer Note -->
            <p class="text-gray-600 text-xs mt-6">
                By signing in, you agree to our Terms of Service.
            </p>
        </div>
    </div>

    <!-- Custom Message Box (Hidden by default) -->
    <div id="message-box" class="fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-2xl transition-opacity duration-300 hidden">
        <p id="message-text" class="font-semibold"></p>
    </div>

</body>
</html>
