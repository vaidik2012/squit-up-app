import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, signInAnonymously, signInWithCustomToken, 
    onAuthStateChanged, GoogleAuthProvider, signInWithPopup, 
    signOut 
} from 'firebase/auth';
import { 
    getFirestore, doc, onSnapshot, collection, query, 
    where, addDoc, serverTimestamp, setDoc, getDocs 
} from 'firebase/firestore';
import { Send, LogOut, MessageSquare, Plus, User } from 'lucide-react';

// --- GLOBAL VARIABLES ---
// IMPORTANT: These variables are provided by the canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// --- END GLOBAL VARIABLES ---

// Utility function to handle exponential backoff for API calls (e.g., Gemini API)
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// --- FIREBASE INITIALIZATION AND HOOKS ---
const useFirebase = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    useEffect(() => {
        if (!firebaseConfig.apiKey) return;

        try {
            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestoreDb);
            setAuth(firebaseAuth);

            // 1. Initial Authentication Logic
            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(firebaseAuth, initialAuthToken);
                    } else {
                        await signInAnonymously(firebaseAuth);
                    }
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    try {
                        await signInAnonymously(firebaseAuth);
                    } catch (anonError) {
                        console.error("Anonymous sign-in also failed:", anonError);
                    }
                }
            };
            authenticate();

            // 2. Auth State Change Listener (CRITICAL FOR UI UPDATES)
            const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    setUserId(null);
                }
                setIsAuthReady(true);
            });

            return () => unsubscribe();

        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
        }
    }, []);

    return { db, auth, userId, isAuthReady };
};

// --- CHAT APP COMPONENTS ---

const Header = ({ userId, auth }) => {
    const handleSignOut = async () => {
        if (auth) {
            await signOut(auth);
        }
    };
    
    // Fallback display if userId is not available yet
    const displayId = userId ? `${userId.substring(0, 8)}...` : 'Connecting...';

    return (
        <div className="flex justify-between items-center p-4 bg-indigo-700 shadow-lg text-white">
            <h1 className="text-xl font-extrabold flex items-center">
                <MessageSquare className="w-5 h-5 mr-2"/>
                DirectChat
            </h1>
            <div className="flex items-center space-x-3">
                <span className="text-sm font-medium opacity-80 flex items-center">
                    <User className="w-4 h-4 mr-1"/> User ID: {userId ? displayId : 'Guest'}
                </span>
                {userId && (
                    <button 
                        onClick={handleSignOut}
                        className="p-2 rounded-full bg-indigo-500 hover:bg-red-500 transition duration-150 shadow-md flex items-center"
                        title="Sign Out"
                    >
                        <LogOut className="w-4 h-4"/>
                    </button>
                )}
            </div>
        </div>
    );
};

const ChatBubble = ({ message, currentUserId }) => {
    const isCurrentUser = message.senderId === currentUserId;
    const alignClass = isCurrentUser ? 'justify-end' : 'justify-start';
    const bubbleClass = isCurrentUser 
        ? 'bg-indigo-500 text-white rounded-bl-xl rounded-t-xl' 
        : 'bg-gray-200 text-gray-800 rounded-br-xl rounded-t-xl';

    const senderDisplay = isCurrentUser ? 'You' : `${message.senderId.substring(0, 8)}...`;
    const time = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

    return (
        <div className={`flex w-full my-2 ${alignClass}`}>
            <div className={`max-w-xs md:max-w-md lg:max-w-lg p-3 shadow-md ${bubbleClass}`}>
                <div className="font-semibold text-xs mb-1 opacity-90">
                    {senderDisplay}
                </div>
                <p className="text-sm break-words">
                    {message.text}
                </p>
                <div className="text-right text-xs mt-1 opacity-70">
                    {time}
                </div>
            </div>
        </div>
    );
};

const MessageList = ({ db, currentUserId, selectedChatId }) => {
    const [messages, setMessages] = useState([]);
    const messagesRef = selectedChatId 
        ? collection(db, 'artifacts', appId, 'public', 'data', 'chats', selectedChatId, 'messages')
        : null;

    useEffect(() => {
        if (!messagesRef) {
            setMessages([]);
            return;
        }

        // Use onSnapshot to listen for real-time updates
        const q = query(messagesRef);
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const newMessages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            })).sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis()); // Sort by timestamp

            setMessages(newMessages);
        }, (error) => {
            console.error("Error listening to messages:", error);
        });

        return () => unsubscribe();
    }, [messagesRef]);

    if (!selectedChatId) {
        return (
            <div className="flex-1 flex items-center justify-center text-gray-500 text-center p-8">
                Select or start a new chat to begin messaging.
            </div>
        );
    }

    return (
        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
            {messages.map(message => (
                <ChatBubble key={message.id} message={message} currentUserId={currentUserId} />
            ))}
            <div id="scroll-bottom-anchor"></div> {/* Anchor for auto-scrolling */}
        </div>
    );
};

const MessageInput = ({ db, currentUserId, selectedChatId }) => {
    const [messageText, setMessageText] = useState('');

    const sendMessage = async (e) => {
        e.preventDefault();
        if (!messageText.trim() || !selectedChatId || !currentUserId) return;

        const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', selectedChatId, 'messages');

        try {
            await addDoc(messagesRef, {
                text: messageText,
                timestamp: serverTimestamp(),
                senderId: currentUserId
            });
            setMessageText('');
        } catch (error) {
            console.error("Error sending message:", error);
        }
    };

    return (
        <div className="p-4 bg-white border-t border-gray-200">
            <form onSubmit={sendMessage} className="flex space-x-3">
                <input
                    type="text"
                    value={messageText}
                    onChange={(e) => setMessageText(e.target.value)}
                    placeholder={selectedChatId ? "Type a message..." : "Select a chat first"}
                    disabled={!selectedChatId}
                    className="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 disabled:bg-gray-100"
                />
                <button
                    type="submit"
                    disabled={!messageText.trim() || !selectedChatId}
                    className="p-3 bg-indigo-600 text-white rounded-xl shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300 flex items-center justify-center"
                >
                    <Send className="w-5 h-5"/>
                </button>
            </form>
        </div>
    );
};

const ChatSidebar = ({ db, currentUserId, setSelectedChatId }) => {
    const [chats, setChats] = useState([]);
    const [newChatPartnerId, setNewChatPartnerId] = useState('');
    const chatsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');

    // Listener for all chats the current user is a part of
    useEffect(() => {
        if (!currentUserId || !db) return;

        // Query for chats where the current user ID is in the 'participants' array
        const q = query(chatsRef, where('participants', 'array-contains', currentUserId));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const newChats = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setChats(newChats);
        }, (error) => {
            console.error("Error listening to chats:", error);
        });

        return () => unsubscribe();
    }, [currentUserId, db]);

    const startNewChat = async (e) => {
        e.preventDefault();
        if (!newChatPartnerId.trim() || newChatPartnerId === currentUserId) return;

        // 1. Define the sorted participant list for consistent chat ID generation
        const participants = [currentUserId, newChatPartnerId].sort();
        
        // 2. Check if chat already exists (optional, but good practice)
        // For simplicity, we'll just check if a document with that ID exists (less efficient than the query above, but simpler for creation)
        const chatQuery = query(
            chatsRef, 
            where('participants', 'array-contains', currentUserId)
        );
        const existingChats = await getDocs(chatQuery);

        const existingChat = existingChats.docs.find(doc => {
            const data = doc.data();
            return data.participants.includes(newChatPartnerId);
        });

        if (existingChat) {
            setSelectedChatId(existingChat.id);
            setNewChatPartnerId('');
            return;
        }

        // 3. Create a new chat document
        try {
            const newChatData = {
                participants: participants,
                createdAt: serverTimestamp(),
                // Display name for the chat (e.g., the other user's ID)
                name: `Chat with ${newChatPartnerId.substring(0, 8)}...`
            };

            const newChatRef = doc(chatsRef); // Let Firebase generate the ID
            await setDoc(newChatRef, newChatData);
            
            setSelectedChatId(newChatRef.id);
            setNewChatPartnerId('');
        } catch (error) {
            console.error("Error creating new chat:", error);
        }
    };

    return (
        <div className="w-full md:w-72 border-r border-gray-200 bg-white flex flex-col h-full">
            <div className="p-4 border-b border-gray-200">
                <form onSubmit={startNewChat} className="flex flex-col space-y-2">
                    <input
                        type="text"
                        value={newChatPartnerId}
                        onChange={(e) => setNewChatPartnerId(e.target.value)}
                        placeholder="Enter partner's full user ID"
                        className="p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"
                    />
                    <button
                        type="submit"
                        disabled={!newChatPartnerId.trim()}
                        className="w-full p-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-150 disabled:bg-gray-300 flex items-center justify-center text-sm font-semibold"
                    >
                        <Plus className="w-4 h-4 mr-1"/> Start New Chat
                    </button>
                </form>
            </div>
            
            <div className="flex-1 overflow-y-auto">
                {chats.length === 0 ? (
                    <p className="p-4 text-sm text-gray-500">No chats yet. Start one!</p>
                ) : (
                    chats.map(chat => {
                        // Find the other participant's ID for display
                        const otherParticipant = chat.participants.find(id => id !== currentUserId);
                        const chatDisplay = otherParticipant ? `Chat with ${otherParticipant.substring(0, 8)}...` : 'Self Chat';

                        return (
                            <div 
                                key={chat.id}
                                onClick={() => setSelectedChatId(chat.id)}
                                className="p-3 border-b border-gray-100 cursor-pointer hover:bg-indigo-50 transition duration-150"
                            >
                                <p className="font-medium text-sm text-gray-800">{chatDisplay}</p>
                                <p className="text-xs text-gray-500 truncate">Tap to open...</p>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );
};

// --- AUTH SCREEN ---

const AuthScreen = ({ auth, setIsAuthReady }) => {

    const handleGoogleSignIn = async () => {
        if (!auth) return;
        const provider = new GoogleAuthProvider();
        try {
            const result = await signInWithPopup(auth, provider);
            console.log("Google Sign-In Successful:", result.user.uid);
            // FIX: Since the onAuthStateChanged listener in useFirebase is handling 
            // the state update (setting userId), we just need to ensure the popup 
            // closes and the listener fires correctly. The listener will manage 
            // the subsequent UI change. We call setIsAuthReady to force a potential re-check.
            setIsAuthReady(true); 

        } catch (error) {
            // Handle errors, e.g., if the user closes the popup
            console.error("Google Sign-In Error:", error);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <h2 className="text-3xl font-bold mb-6 text-indigo-700">Welcome to DirectChat</h2>
                <p className="text-gray-600 mb-8">Sign in to start messaging with other users.</p>
                
                <button
                    onClick={handleGoogleSignIn}
                    className="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.02] flex items-center justify-center space-x-2"
                >
                    <svg className="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.343c-1.157 3.179-4.343 6-9.343 6-5.406 0-9.761-4.356-9.761-9.761s4.355-9.761 9.761-9.761c2.815 0 5.341 1.137 7.273 2.907l5.657-5.657C34.046 6.883 29.388 4 24 4c-11.052 0-20 8.948-20 20s8.948 20 20 20c11.048 0 20-8.952 20-20 0-1.341-.138-2.65-.389-3.917z"/>
                        <path fill="#FF3D00" d="M6.306 14.693l6.571 4.819C14.655 15.108 18.9 13 24 13c3.084 0 5.862 1.01 8.077 2.766l6.571-4.819C34.046 6.883 29.388 4 24 4 15.3 4 8.016 8.324 4 14.693h2.306z"/>
                        <path fill="#4CAF50" d="M24 44c5.108 0 9.761-2.108 13.041-5.657l-6.571-4.819C28.281 35.881 26.21 36 24 36c-5.152 0-9.845-3.882-11.516-9.088l-6.571 4.819C8.016 39.676 15.3 44 24 44z"/>
                        <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.343c-.875 2.569-2.583 4.887-4.851 6.368l6.571 4.819C40.919 36.882 44 32.518 44 28c0-1.341-.138-2.65-.389-3.917V20.083z"/>
                    </svg>
                    <span>Sign in with Google</span>
                </button>
            </div>
        </div>
    );
};

// --- MAIN APP ---

const App = () => {
    const { db, auth, userId, isAuthReady } = useFirebase();
    const [selectedChatId, setSelectedChatId] = useState(null);

    // Auto-scroll to the bottom of the message list whenever messages or chat ID change
    useEffect(() => {
        const anchor = document.getElementById('scroll-bottom-anchor');
        if (anchor) {
            anchor.scrollIntoView({ behavior: 'smooth' });
        }
    }, [selectedChatId, userId]); // Depend on userId to scroll after auth is ready

    if (!isAuthReady) {
        return (
            <div className="min-h-screen flex items-center justify-center text-indigo-700 bg-gray-100">
                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500"></div>
                <p className="ml-3 font-medium">Authenticating...</p>
            </div>
        );
    }

    if (!userId || !db || !auth) {
        return <AuthScreen auth={auth} setIsAuthReady={setIsAuthReady} />;
    }

    return (
        <div className="flex flex-col min-h-screen bg-gray-100 font-sans">
            <Header userId={userId} auth={auth} />
            <div className="flex flex-1 overflow-hidden">
                <ChatSidebar 
                    db={db} 
                    currentUserId={userId} 
                    setSelectedChatId={setSelectedChatId}
                />
                <div className="flex-1 flex flex-col">
                    <MessageList 
                        db={db} 
                        currentUserId={userId} 
                        selectedChatId={selectedChatId}
                    />
                    <MessageInput 
                        db={db} 
                        currentUserId={userId} 
                        selectedChatId={selectedChatId}
                    />
                </div>
            </div>
        </div>
    );
};

export default App;
