<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURY - Discord-like Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        .sidebar {
            width: 72px; /* Fixed width for Server/DM column */
            flex-shrink: 0;
        }
        .channel-list {
            width: 240px; /* Width for Channels/DM list */
            flex-shrink: 0;
        }
        /* Custom scrollbar for chat box */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
        /* Custom scrollbar for side panels */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #374151;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 h-screen">

    <!-- Main application container -->
    <div id="app-container" class="h-full">
        <!-- Content will be injected here -->
    </div>

    <!-- Modals (Outside app-container) -->
    <div id="modal-container"></div>


    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, serverTimestamp, getDoc, setDoc, setLogLevel, where, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        let app, db, auth;
        let userId = null;
        let currentUserProfile = null;
        let isAuthReady = false; 
        
        // State Management
        let currentView = { type: 'global', id: 'global_fury_chat', displayName: 'Global FURY Chat' }; // 'global', 'dm', or 'server'
        let messages = [];
        let directMessages = [];
        let friends = []; // { userId, displayName, onlineStatus, friendId }
        let friendRequests = []; // { senderId, senderDisplayName, requestId }

        // --- GLOBAL VARIABLES (Provided by environment or manually configured) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Custom Configuration (Provided by user - CRITICAL) ---
        const customFirebaseConfig = {
            apiKey: "AIzaSyB1zvVHaBrbzX5iA9fBVNGa_3sY1-WCSpY", 
            authDomain: "squit-up-auth.firebaseapp.com",
            projectId: "squit-up-auth",
            storageBucket: "squit-up-auth.firebasestorage.app",
            messagingSenderId: "586918898443",
            appId: "1:586918898443:web:c5a56eb24cd4f183d8600e",
            measurementId: "G-K4LHFHSNJC"
        };
        // Use the environment configuration if available, otherwise use the custom config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : customFirebaseConfig;
        
        // --- UTILITY FUNCTIONS ---

        /** Renders a simple custom modal for alerts/confirmations. */
        function renderModal(title, message, type = 'alert', onConfirm = null) {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                    <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-3">${title}</h3>
                        <p class="text-gray-300 mb-6">${message}</p>
                        <div class="flex justify-end space-x-3">
                            ${type === 'confirm' ? `<button id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition">Cancel</button>` : ''}
                            <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition">${type === 'alert' ? 'Close' : 'Confirm'}</button>
                        </div>
                    </div>
                </div>
            `;
            const closeModal = () => container.innerHTML = '';
            
            document.getElementById('modal-confirm').addEventListener('click', () => {
                if (type === 'confirm' && onConfirm) {
                    onConfirm();
                }
                closeModal();
            });
            
            if (type === 'confirm') {
                document.getElementById('modal-cancel').addEventListener('click', closeModal);
            }
        }

        /**
         * Generic function to retry an async function with exponential backoff.
         */
        async function fetchWithExponentialBackoff(apiCall, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (error.code && error.code.includes('api-key-not-valid') && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue;
                    }
                    throw error;
                }
            }
        }

        /** Renders the loading spinner. */
        function renderLoading(message = "Connecting...") {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center text-white bg-gray-900">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-t-4 border-red-500 border-opacity-25 rounded-full animate-spin"></div>
                        <p class="mt-4 text-lg text-gray-400">${message}</p>
                    </div>
                </div>
            `;
        }
        
        /** Renders the Sign-In screen. */
        function renderSignIn(errorMessage = '') {
            // ... (Sign In HTML content remains the same as previous step, for brevity it's omitted here) ...
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center bg-gray-900">
                    <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <div class="flex justify-center mb-6">
                            <div class="p-3 bg-red-500 rounded-full">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.111A9.502 9.502 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                        </div>
                        <h1 class="text-3xl font-extrabold text-red-500 mb-2">FURY</h1>
                        <p class="text-gray-400 mb-8">Connect with friends instantly.</p>
                        
                        <h2 class="text-2xl font-semibold text-white mb-4">Sign In</h2>
                        
                        <form id="email-password-form" class="space-y-4">
                            <input 
                                type="text" 
                                id="email-input" 
                                placeholder="Email or @user_id"
                                required 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <input 
                                type="password" 
                                id="password-input" 
                                placeholder="Password"
                                required 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <button id="email-signin-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-indigo-600/30">
                                Log In
                            </button>
                        </form>
                        
                        <div class="my-6 flex items-center">
                            <div class="flex-grow border-t border-gray-700"></div>
                            <span class="flex-shrink mx-4 text-gray-500">OR</span>
                            <div class="flex-grow border-t border-gray-700"></div>
                        </div>

                        <button id="google-signin-btn" class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-red-600/30">
                            <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.61 20.08v3.42H24V20.08h19.61z"/><path fill="#FF3D00" d="M6.3 33.15c.61 1.77 1.63 3.32 2.87 4.6l5.77-4.47c-.77-.48-1.44-1.07-1.95-1.78H6.3z"/><path fill="#4CAF50" d="M43.61 24.5v3.42H24v-3.42h19.61z"/><path fill="#1976D2" d="M12.94 37.75c3.08 3.52 7.7 5.75 12.87 5.75s9.79-2.23 12.87-5.75l-5.77-4.47c-2.34 2.1-5.32 3.42-9.1 3.42s-6.76-1.32-9.1-3.42L12.94 37.75z"/><path fill="#F44336" d="M24 8c-4.99 0-9.62 2.11-12.87 5.75l5.77 4.47c2.34-2.1 5.32-3.42 9.1-3.42s6.76-1.32 9.1-3.42l5.77-4.47C33.62 10.11 28.99 8 24 8z"/></svg>
                            Sign in with Google
                        </button>
                        
                        ${errorMessage ? `<p id="error-message" class="text-sm text-red-400 mt-4 font-semibold p-2 bg-gray-900 rounded-lg">${errorMessage}</p>` : ''}
                        
                        <p class="text-xs text-gray-600 mt-4">By signing in, you agree to our <a href="#" class="text-red-500 hover:underline">Terms of Service</a>.</p>
                    </div>
                </div>
            `;
            document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
            document.getElementById('email-password-form').addEventListener('submit', handleEmailPasswordSignIn);
        }

        /** Renders the Profile Setup screen. */
        function renderProfileSetup(errorMessage = '') {
            const user = auth.currentUser;
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center bg-gray-900">
                    <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <h1 class="text-2xl font-extrabold text-white mb-2">Welcome to FURY!</h1>
                        <p class="text-gray-400 mb-8">
                            Complete your profile to unlock manual login and set your chat identity.
                        </p>
                        
                        <p class="text-sm text-gray-400 mb-4 p-2 bg-gray-700 rounded-lg">
                            Your login email: <strong class="text-red-400">${user?.email || 'N/A'}</strong>
                        </p>
                        
                        <form id="profile-setup-form" class="space-y-4">
                            <!-- @user_id Input (Display Name) -->
                            <input 
                                type="text" 
                                id="user-id-input" 
                                placeholder="@user_id (e.g., @GamerTag)"
                                required 
                                pattern="^@[a-zA-Z0-9_]{3,15}$"
                                title="Must start with @ and contain 3-15 letters, numbers, or underscores."
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <!-- Password Input -->
                            <input 
                                type="password" 
                                id="new-password-input" 
                                placeholder="Set Password (min 6 chars)"
                                required 
                                minlength="6"
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <button id="setup-btn" type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-red-600/30">
                                Complete Setup
                            </button>
                        </form>
                        
                        ${errorMessage ? `<p id="error-message" class="text-sm text-red-400 mt-4 font-semibold p-2 bg-gray-900 rounded-lg">${errorMessage}</p>` : ''}
                        
                        <!-- Added Logout button for the fix -->
                        <button id="setup-logout-btn" class="text-sm text-gray-500 hover:text-red-500 mt-4 underline">
                            Cancel / Log Out
                        </button>

                    </div>
                </div>
            `;
            document.getElementById('profile-setup-form').addEventListener('submit', handleProfileSetup);
            document.getElementById('setup-logout-btn').addEventListener('click', handleSignOut);
        }

        // --- AUTHENTICATION HANDLERS ---

        /** Signs out the current user and sets their status to 'offline'. */
        async function handleSignOut() {
            try {
                if (userId) {
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
                    setDoc(userDocRef, { onlineStatus: 'offline' }, { merge: true }).catch(e => console.error("Error setting offline status:", e));
                }
                await signOut(auth);
                // After sign out, the onAuthStateChanged listener will call renderSignIn()
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        }

        /** Handles Profile Setup: Fixes credential issue and updates profile. */
        async function handleProfileSetup(e) {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                return renderModal("Error", "Session expired. Please sign in again.");
            }

            const userIdInput = document.getElementById('user-id-input').value.trim();
            const newPassword = document.getElementById('new-password-input').value;

            if (newPassword.length < 6) {
                return renderProfileSetup('Password must be at least 6 characters long.');
            }
            if (!userIdInput.match(/^@[a-zA-Z0-9_]{3,15}$/)) {
                return renderProfileSetup('Invalid @user_id format. Must start with @ and contain 3-15 letters, numbers, or underscores.');
            }

            renderLoading("Setting up profile...");

            try {
                // 1. Update the user's display name
                await updateProfile(user, { displayName: userIdInput });

                // 2. Set the password
                await updatePassword(user, newPassword);

                // 3. Update the Firestore profile
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', user.uid);
                await setDoc(userDocRef, {
                    displayName: userIdInput,
                    isSetupComplete: true,
                    lastActive: serverTimestamp(),
                }, { merge: true });

                // Success: Manually update profile state and render chat UI
                currentUserProfile = { ...currentUserProfile, displayName: userIdInput, isSetupComplete: true };
                currentView = { type: 'global', id: 'global_fury_chat', displayName: 'Global FURY Chat' };
                renderDashboard();
            } catch (error) {
                console.error("Profile Setup failed:", error);
                let message = 'Profile setup failed. Please try again.';
                
                if (error.code === 'auth/weak-password') {
                    message = 'Password is too weak. Choose a stronger one.';
                } else if (error.code === 'auth/requires-recent-login' || error.code === 'auth/credential-too-old') {
                    // CRITICAL FIX: Prompt sign out/in and re-render the sign-in page with a clear message.
                    handleSignOut().then(() => {
                        renderSignIn('Security check failed. Please sign in again immediately to complete your profile.');
                    });
                    return; // Stop execution here
                }
                renderProfileSetup(message);
            }
        }
        
        // --- CHAT AND DASHBOARD LOGIC (Simplified/Refactored) ---

        /** Renders a single message into the messages container. */
        function renderMessages() {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            const shouldScroll = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;

            container.innerHTML = ''; 
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-10 flex-grow flex items-center justify-center">
                        Say hello! Be the first to send a message to **#${currentView.displayName}**.
                    </div>
                `;
                return;
            }

            const fragment = document.createDocumentFragment();

            messages.forEach(message => {
                const isCurrentUser = message.senderId === userId;
                const senderDisplay = message.displayName || message.senderId.substring(0, 8); 

                const bubbleClass = isCurrentUser
                    ? 'bg-red-500 text-white self-end rounded-bl-xl rounded-t-xl'
                    : 'bg-gray-700 text-gray-200 self-start rounded-br-xl rounded-t-xl';
                
                const timestampDisplay = message.timestamp instanceof Date 
                    ? message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                    : '...';

                const messageElement = document.createElement('div');
                messageElement.className = `flex flex-col mb-4 max-w-xs md:max-w-md ${isCurrentUser ? 'items-end' : 'items-start'}`;
                messageElement.innerHTML = `
                    <div class="text-xs text-gray-400 mb-1 px-3">
                        ${isCurrentUser ? 'You' : senderDisplay}
                    </div>
                    <div class="p-3 shadow-md ${bubbleClass}">
                        ${message.text}
                        <span class="ml-4 text-xs opacity-70 block text-right mt-1">${timestampDisplay}</span>
                    </div>
                `;
                fragment.appendChild(messageElement);
            });
            
            container.appendChild(fragment);

            if (shouldScroll) {
               container.scrollTop = container.scrollHeight;
            }
        }

        /** Sends a message to the currently selected view (global or DM). */
        async function sendMessage(text) {
            if (!userId || !text.trim() || !db) return;

            try {
                let collectionRef;
                let chatTitle;

                if (currentView.type === 'global' || currentView.type === 'server') {
                    // Global/Server messages
                    const chatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentView.id);
                    collectionRef = collection(chatDocRef, 'messages');
                    chatTitle = currentView.displayName;
                } else if (currentView.type === 'dm') {
                    // DM messages
                    const dmId = currentView.id; 
                    const dmDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'dms', dmId);
                    collectionRef = collection(dmDocRef, 'messages');
                    chatTitle = `DM with ${currentView.displayName}`;
                } else {
                    return; // Should not happen
                }
                
                await addDoc(collectionRef, {
                    senderId: userId,
                    displayName: currentUserProfile.displayName, 
                    text: text.trim(),
                    timestamp: serverTimestamp(),
                });
                document.getElementById('message-input').value = '';
            } catch (error) {
                renderModal("Send Error", "Failed to send message. Please check console for details.");
                console.error("Error sending message:", error.message);
            }
        }

        /** Sets up the listener for the currently selected chat view. */
        function setupChatListener() {
            if (!userId || !db) return;
            
            // Clear any previous listener
            if (window.unsubscribeMessages) {
                window.unsubscribeMessages();
                window.unsubscribeMessages = null;
            }

            let messagesCollectionRef;

            if (currentView.type === 'global' || currentView.type === 'server') {
                const chatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentView.id);
                messagesCollectionRef = collection(chatDocRef, 'messages');
            } else if (currentView.type === 'dm') {
                 const dmDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'dms', currentView.id);
                 messagesCollectionRef = collection(dmDocRef, 'messages');
            } else {
                return;
            }
            
            const q = query(messagesCollectionRef);

            window.unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date()
                }));

                messages.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
                renderMessages(); 
            }, (error) => {
                console.error("Error listening to chat messages:", error.message);
            });
        }
        
        /** Renders the list of Direct Messages in the sidebar. */
        function renderDMsList() {
             const dmListContainer = document.getElementById('dm-list');
             if (!dmListContainer) return;

             dmListContainer.innerHTML = '';
             
             directMessages.forEach(dm => {
                 const isActive = currentView.type === 'dm' && currentView.id === dm.dmId;
                 const statusColor = dm.onlineStatus === 'online' ? 'bg-green-500' : 'bg-gray-500';

                 const listItem = document.createElement('li');
                 listItem.className = 'my-1';
                 listItem.innerHTML = `
                     <button data-id="${dm.dmId}" data-type="dm" data-name="${dm.displayName}"
                         class="w-full flex items-center p-2 rounded-lg transition duration-150 ${isActive ? 'bg-gray-700' : 'hover:bg-gray-700/50'}">
                         <div class="relative flex-shrink-0 mr-3">
                             <span class="inline-block w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-sm font-bold text-white">${dm.displayName.charAt(1).toUpperCase()}</span>
                             <span class="absolute right-0 bottom-0 block w-3 h-3 rounded-full ring-2 ring-gray-900 ${statusColor}"></span>
                         </div>
                         <span class="text-sm font-medium text-gray-300 whitespace-nowrap overflow-hidden text-ellipsis">${dm.displayName}</span>
                     </button>
                 `;
                 dmListContainer.appendChild(listItem);
             });
        }

        /** Listener for Direct Messages and Friend System. */
        function setupFriendsAndDmsListener() {
            if (!userId || !db) return;

            // 1. Listen for current user's friends list
            const friendsRef = collection(db, 'artifacts', appId, 'public', 'data', 'friends', userId, 'list');
            
            // NOTE: Firestore queries often require indexes if using 'where' and 'orderBy'. 
            // We fetch the friend list (which is small) and then fetch friend details.
            
            onSnapshot(friendsRef, async (snapshot) => {
                const friendIds = snapshot.docs.map(doc => doc.id);
                
                const newFriends = [];
                const newDMs = [];

                for (const friendId of friendIds) {
                    // Fetch friend's profile to get displayName and status
                    const friendProfileRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', friendId);
                    const profileSnap = await getDoc(friendProfileRef);

                    if (profileSnap.exists()) {
                        const profile = profileSnap.data();
                        const dmId = [userId, friendId].sort().join('_'); // Consistent DM ID
                        
                        newFriends.push({
                            userId: friendId,
                            displayName: profile.displayName,
                            onlineStatus: profile.onlineStatus,
                        });

                        newDMs.push({
                            dmId: dmId,
                            displayName: profile.displayName,
                            onlineStatus: profile.onlineStatus,
                            recipientId: friendId,
                        });
                    }
                }
                
                friends = newFriends;
                directMessages = newDMs;
                renderDMsList();

            }, (error) => {
                console.error("Error listening to friends list:", error.message);
            });

            // 2. Listen for incoming friend requests
            const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'requests', userId, 'incoming');
            onSnapshot(requestsRef, (snapshot) => {
                friendRequests = snapshot.docs.map(doc => ({
                    requestId: doc.id,
                    ...doc.data()
                }));
                updateFriendRequestButton();
            }, (error) => {
                console.error("Error listening to friend requests:", error.message);
            });
        }

        // --- DASHBOARD RENDERING ---

        /** Renders the main dashboard layout. */
        function renderDashboard() {
            const userDisplayId = currentUserProfile?.displayName || `@user_${userId.substring(0, 8)}`;
            const container = document.getElementById('app-container');
            
            container.innerHTML = `
                <div class="flex h-full text-white bg-gray-900 antialiased">
                    
                    <!-- Column 1: Server/DM Switcher (Small Fixed Bar) -->
                    <div class="sidebar bg-gray-900 flex flex-col items-center py-3 space-y-2 border-r border-gray-800">
                        <button id="signout-btn" class="group relative w-12 h-12 flex items-center justify-center rounded-2xl bg-gray-800 hover:bg-red-600 transition duration-200" title="Sign Out">
                             <svg class="w-6 h-6 text-red-500 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </button>

                        <div class="w-10 border-t border-gray-700"></div>

                        <!-- Global Chat Icon -->
                        <button data-id="global_fury_chat" data-type="global" data-name="Global FURY Chat" class="server-switch-btn w-12 h-12 flex items-center justify-center rounded-3xl bg-red-600 text-white font-bold transition duration-200 hover:rounded-2xl shadow-xl hover:shadow-red-600/30">
                            F
                        </button>
                    </div>

                    <!-- Column 2: DM/Channel List Sidebar -->
                    <div class="channel-list bg-gray-800 flex flex-col border-r border-gray-700">
                        <!-- Top Header (App Name / Search) -->
                        <div class="p-3 border-b border-gray-700 flex items-center justify-between">
                            <span class="text-xl font-bold text-white">Direct Messages</span>
                            <button id="add-friend-btn" class="text-gray-400 hover:text-green-500 transition duration-150 relative p-1 rounded-full hover:bg-gray-700" title="Add Friend">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                                <span id="friend-request-indicator" class="hidden absolute top-0 right-0 block h-3 w-3 rounded-full bg-red-500 ring-2 ring-gray-800"></span>
                            </button>
                        </div>
                        
                        <!-- DM List -->
                        <div class="flex-grow p-2 overflow-y-auto custom-scrollbar">
                             <h2 class="text-xs font-semibold uppercase text-gray-400 my-2 px-2">Direct Messages</h2>
                             <ul id="dm-list" class="space-y-1">
                                 <!-- DM list items will be rendered here -->
                             </ul>
                        </div>

                        <!-- User Info Bar -->
                        <div class="p-3 bg-gray-900 border-t border-gray-700 flex items-center">
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-sm font-semibold whitespace-nowrap overflow-hidden text-ellipsis text-red-400">${userDisplayId}</span>
                                <span class="text-xs text-gray-500">${auth.currentUser.email || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Chat Area -->
                    <div class="flex-grow flex flex-col">
                        <!-- Header -->
                        <header class="p-4 border-b border-gray-700 bg-gray-800 flex items-center justify-between">
                            <h2 id="chat-header-name" class="text-xl font-bold"># ${currentView.displayName}</h2>
                            <div class="text-sm text-gray-400">Your User ID: <span class="font-mono text-xs p-1 bg-gray-700 rounded-md select-all">${userId}</span></div>
                        </header>

                        <!-- Messages Body -->
                        <div id="messages-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                            <!-- Messages will be rendered here -->
                        </div>

                        <!-- Input Area -->
                        <form id="chat-form" class="p-4 border-t border-gray-700 bg-gray-800">
                            <div class="flex items-center space-x-3">
                                <input
                                    type="text"
                                    id="message-input"
                                    placeholder="Message # ${currentView.displayName}"
                                    class="flex-grow bg-gray-700 text-white p-3 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none transition duration-150"
                                >
                                <button
                                    type="submit"
                                    class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-xl transition duration-150 shadow-lg disabled:opacity-50"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Event Listeners for new UI elements
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                sendMessage(input.value);
            });
            document.getElementById('add-friend-btn').addEventListener('click', renderFriendModal);
            
            document.querySelectorAll('.server-switch-btn').forEach(button => {
                button.addEventListener('click', handleViewChange);
            });
            
            // Setup initial listeners
            setupChatListener(); // Start listening to the initial 'global' chat
            setupFriendsAndDmsListener(); // Start listening to friend list and requests
        }

        /** Handles switching between chat views (Global, DM). */
        function handleViewChange(e) {
            const button = e.currentTarget;
            const id = button.getAttribute('data-id');
            const type = button.getAttribute('data-type');
            const name = button.getAttribute('data-name');
            
            currentView = { id, type, displayName: name };

            const header = document.getElementById('chat-header-name');
            const input = document.getElementById('message-input');

            if (header) header.textContent = `# ${name}`;
            if (input) input.placeholder = `Message # ${name}`;

            // Re-render DM list to highlight active chat
            renderDMsList(); 
            // Restart chat listener for the new view
            setupChatListener(); 
        }

        /** Renders the Friend/DM management modal. */
        function renderFriendModal() {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                    <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg border border-gray-700">
                        <h3 class="text-2xl font-bold text-white mb-6">Friends & Requests</h3>
                        
                        <!-- Add Friend Section -->
                        <div class="mb-6 border-b border-gray-700 pb-4">
                            <h4 class="text-lg font-semibold text-red-400 mb-3">Send Friend Request (Use User ID)</h4>
                            <form id="send-request-form" class="flex space-x-2">
                                <input 
                                    type="text" 
                                    id="recipient-id-input" 
                                    placeholder="Enter full User ID to add"
                                    required 
                                    class="flex-grow bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                >
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                                    Send
                                </button>
                            </form>
                            <p id="request-message" class="text-sm mt-2 text-gray-400"></p>
                        </div>
                        
                        <!-- Friend Requests (Incoming) -->
                        <div class="mb-6 border-b border-gray-700 pb-4">
                            <h4 class="text-lg font-semibold text-white mb-3">Incoming Requests (${friendRequests.length})</h4>
                            <ul id="requests-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                ${friendRequests.length === 0 ? '<li class="text-sm text-gray-500">No pending friend requests.</li>' : ''}
                                <!-- Requests rendered here -->
                            </ul>
                        </div>
                        
                        <!-- Friends List -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-white mb-3">Friends List (${friends.length})</h4>
                            <ul id="friends-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                ${friends.length === 0 ? '<li class="text-sm text-gray-500">You have no friends yet.</li>' : ''}
                                <!-- Friends rendered here -->
                            </ul>
                        </div>

                        <button id="modal-close" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl transition">Close</button>
                    </div>
                </div>
            `;

            document.getElementById('modal-close').addEventListener('click', () => container.innerHTML = '');
            document.getElementById('send-request-form').addEventListener('submit', handleSendFriendRequest);
            
            // Render Requests
            const requestsList = document.getElementById('requests-list');
            if (friendRequests.length > 0) {
                requestsList.innerHTML = '';
                friendRequests.forEach(req => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between p-2 bg-gray-700 rounded-lg';
                    listItem.innerHTML = `
                        <span class="text-sm font-medium text-red-300">${req.senderDisplayName}</span>
                        <div class="space-x-2">
                            <button data-id="${req.requestId}" data-sender="${req.senderId}" data-name="${req.senderDisplayName}" class="accept-btn text-green-400 hover:text-green-300 font-semibold text-sm">Accept</button>
                            <button data-id="${req.requestId}" class="reject-btn text-red-400 hover:text-red-300 font-semibold text-sm">Reject</button>
                        </div>
                    `;
                    requestsList.appendChild(listItem);
                });

                document.querySelectorAll('.accept-btn').forEach(btn => btn.addEventListener('click', handleAcceptRequest));
                document.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', handleRejectRequest));
            }

            // Render Friends
            const friendsList = document.getElementById('friends-list');
            if (friends.length > 0) {
                 friendsList.innerHTML = '';
                 friends.forEach(friend => {
                     const statusColor = friend.onlineStatus === 'online' ? 'bg-green-500' : 'bg-gray-500';
                     const listItem = document.createElement('li');
                     listItem.className = 'flex items-center justify-between p-2 bg-gray-700 rounded-lg';
                     listItem.innerHTML = `
                         <div class="flex items-center">
                              <div class="w-2 h-2 rounded-full mr-2 ${statusColor}"></div>
                              <span class="text-sm font-medium text-gray-300">${friend.displayName}</span>
                         </div>
                         <button data-id="${friend.userId}" data-name="${friend.displayName}" class="dm-friend-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-xs rounded-lg transition">DM</button>
                     `;
                     friendsList.appendChild(listItem);
                 });
                 
                 document.querySelectorAll('.dm-friend-btn').forEach(btn => btn.addEventListener('click', (e) => {
                     // Close modal, switch view to DM
                     container.innerHTML = '';
                     const friendId = e.currentTarget.getAttribute('data-id');
                     const friendName = e.currentTarget.getAttribute('data-name');
                     const dmId = [userId, friendId].sort().join('_');
                     
                     currentView = { id: dmId, type: 'dm', displayName: friendName };
                     handleViewChange({ currentTarget: { getAttribute: (key) => key === 'id' ? dmId : key === 'type' ? 'dm' : friendName } });
                     
                     // Manually update the header since handleViewChange needs a DOM element
                     const header = document.getElementById('chat-header-name');
                     if (header) header.textContent = `@ ${friendName}`;
                     const input = document.getElementById('message-input');
                     if (input) input.placeholder = `Message @ ${friendName}`;
                 }));
            }

            updateFriendRequestButton(); // Ensure the indicator is correct
        }
        
        /** Sends a friend request. */
        async function handleSendFriendRequest(e) {
            e.preventDefault();
            const recipientId = document.getElementById('recipient-id-input').value.trim();
            const messageEl = document.getElementById('request-message');
            messageEl.className = 'text-sm mt-2 text-gray-400';

            if (recipientId === userId) {
                return messageEl.textContent = 'You cannot send a request to yourself.';
            }

            try {
                // 1. Check if recipient exists
                const recipientProfileRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', recipientId);
                const recipientSnap = await getDoc(recipientProfileRef);

                if (!recipientSnap.exists() || recipientSnap.data().isSetupComplete !== true) {
                    messageEl.textContent = 'User ID not found or profile not complete.';
                    messageEl.classList.add('text-yellow-400');
                    return;
                }
                
                // 2. Check if already friends
                const friendCheckRef = doc(db, 'artifacts', appId, 'public', 'data', 'friends', userId, 'list', recipientId);
                const friendCheckSnap = await getDoc(friendCheckRef);
                if (friendCheckSnap.exists()) {
                    messageEl.textContent = `${recipientSnap.data().displayName} is already your friend.`;
                    messageEl.classList.add('text-green-400');
                    return;
                }
                
                // 3. Check for pending request (sent or received)
                const outgoingRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', userId, 'outgoing', recipientId);
                const outgoingSnap = await getDoc(outgoingRef);
                if (outgoingSnap.exists()) {
                    messageEl.textContent = 'Request already sent and pending.';
                    messageEl.classList.add('text-yellow-400');
                    return;
                }

                // 4. Send the request (add to recipient's incoming list)
                const incomingRef = collection(db, 'artifacts', appId, 'public', 'data', 'requests', recipientId, 'incoming');
                await setDoc(doc(incomingRef, userId), { 
                    senderId: userId,
                    senderDisplayName: currentUserProfile.displayName,
                    timestamp: serverTimestamp()
                });
                
                // 5. Log the request (add to sender's outgoing list)
                await setDoc(outgoingRef, { 
                    recipientId: recipientId,
                    recipientDisplayName: recipientSnap.data().displayName,
                    timestamp: serverTimestamp()
                });

                messageEl.textContent = `Request sent to ${recipientSnap.data().displayName}!`;
                messageEl.classList.add('text-green-400');
                document.getElementById('recipient-id-input').value = '';

            } catch (error) {
                console.error("Error sending request:", error);
                messageEl.textContent = 'Error sending request. Please check console.';
                messageEl.classList.add('text-red-400');
            }
        }

        /** Handles accepting a friend request. */
        async function handleAcceptRequest(e) {
            const senderId = e.currentTarget.getAttribute('data-sender');
            const senderName = e.currentTarget.getAttribute('data-name');
            const requestId = e.currentTarget.getAttribute('data-id');

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Add sender to current user's friend list
                    const myFriendRef = doc(db, 'artifacts', appId, 'public', 'data', 'friends', userId, 'list', senderId);
                    transaction.set(myFriendRef, { 
                        displayName: senderName,
                        friendshipEstablished: serverTimestamp() 
                    });

                    // 2. Add current user to sender's friend list
                    const senderFriendRef = doc(db, 'artifacts', appId, 'public', 'data', 'friends', senderId, 'list', userId);
                    transaction.set(senderFriendRef, { 
                        displayName: currentUserProfile.displayName,
                        friendshipEstablished: serverTimestamp() 
                    });

                    // 3. Delete the incoming request
                    const incomingRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', userId, 'incoming', requestId);
                    transaction.delete(incomingRef);

                    // 4. Delete the sender's outgoing request
                    const outgoingRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', senderId, 'outgoing', userId);
                    transaction.delete(outgoingRef);
                });
                
                renderFriendModal(); // Re-render modal to reflect changes
            } catch (error) {
                console.error("Transaction failed (Accept Request):", error);
                renderModal("Error", "Failed to accept request. Please try again.");
            }
        }

        /** Handles rejecting a friend request. */
        async function handleRejectRequest(e) {
             const senderId = e.currentTarget.closest('li').querySelector('.accept-btn').getAttribute('data-sender');
             const requestId = e.currentTarget.getAttribute('data-id');
             
             try {
                 // Delete the incoming request
                 const incomingRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', userId, 'incoming', requestId);
                 await deleteDoc(incomingRef);

                 // Delete the sender's outgoing request
                 const outgoingRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', senderId, 'outgoing', userId);
                 await deleteDoc(outgoingRef);
                 
                 renderFriendModal(); // Re-render modal
             } catch (error) {
                 console.error("Error rejecting request:", error);
                 renderModal("Error", "Failed to reject request.");
             }
        }
        
        /** Updates the friend request indicator dot. */
        function updateFriendRequestButton() {
            const indicator = document.getElementById('friend-request-indicator');
            if (indicator) {
                if (friendRequests.length > 0) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }
        }


        // --- FIREBASE CORE INITIALIZATION ---

        /** CRITICAL: Ensures the profile exists and determines whether to render Setup or Dashboard. */
        async function initializeUserProfileAndRenderUI(uid) {
            renderLoading("Loading profile data...");
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', uid);
            const user = auth.currentUser;
            const defaultDisplay = user?.email ? `@${user.email.split('@')[0].replace(/[^a-zA-Z0-9_]/g, '')}` : `@user_${uid.substring(0, 8)}`;
            let isSetupComplete = false;

            try {
                const docSnap = await getDoc(userDocRef);
                
                if (!docSnap.exists()) {
                    // Profile does not exist, create it with setup incomplete
                    await setDoc(userDocRef, {
                        userId: uid,
                        displayName: user.displayName || defaultDisplay,
                        email: user?.email || '',
                        onlineStatus: 'online', 
                        isSetupComplete: false, 
                        lastActive: serverTimestamp(),
                        createdAt: serverTimestamp(),
                    });
                    currentUserProfile = { displayName: user.displayName || defaultDisplay, isSetupComplete: false, onlineStatus: 'online' };

                } else {
                    // Profile exists, update status and check setup state
                    currentUserProfile = docSnap.data();
                    isSetupComplete = currentUserProfile.isSetupComplete === true;
                    
                    await setDoc(userDocRef, {
                        onlineStatus: 'online',
                        lastActive: serverTimestamp(),
                    }, { merge: true });
                }
            } catch (error) {
                console.error("Error creating/updating user profile document (Public Path):", error.message);
                currentUserProfile = currentUserProfile || { displayName: defaultDisplay, isSetupComplete: false, onlineStatus: 'online' };
            }
            
            // --- IMMEDIATE RENDERING LOGIC ---
            if (currentUserProfile.isSetupComplete === true) {
                currentView = { type: 'global', id: 'global_fury_chat', displayName: 'Global FURY Chat' };
                renderDashboard(); 
            } else if (user && user.providerData.some(p => p.providerId === GoogleAuthProvider.PROVIDER_ID) && !user.isAnonymous) {
                // Only prompt setup for Google users who are incomplete
                renderProfileSetup();
            } else {
                 // For robustness, if not a Google user, assume ready for chat if authenticated.
                 currentView = { type: 'global', id: 'global_fury_chat', displayName: 'Global FURY Chat' };
                 renderDashboard(); 
            }
            
            // Start the real-time listener for user profile (for friend system)
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserProfile = docSnap.data();
                    if (document.getElementById('chat-header-name')) {
                         // Small UI update logic can go here if needed (e.g., status changes)
                    }
                }
            }, (error) => {
                console.error("Error listening to user's public profile:", error.message);
            });
        }

        /** Initializes Firebase and sets up the main authentication listener. */
        function initializeAppAndAuth() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing.");
                return renderLoading("Error: Firebase configuration missing.");
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 
            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                return renderLoading("Error initializing Firebase. Check your configuration values.");
            }

            renderLoading("Authenticating...");

            // Set up Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true; 

                if (user) {
                    userId = user.uid;
                    await initializeUserProfileAndRenderUI(userId); 
                } else {
                    userId = null;
                    currentUserProfile = null;
                    // Stop all listeners when logged out
                    if (window.unsubscribeMessages) window.unsubscribeMessages();
                    // Render the sign in screen
                    renderSignIn();
                }
            });

            // Attempt initial sign-in with custom token
            async function initialSignIn() {
                 if (initialAuthToken) {
                     try {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } catch (e) {
                         console.error("Custom token sign-in failed. User must sign in manually.", e);
                     }
                 }
            }

            initialSignIn();
        }

        // Start the whole application on window load
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
