<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQUIT: Chat Universe</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Base styling for dark, centered layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Custom dynamic style for the exciting SQUIT title */
        .exciting-title {
            text-shadow: 0 4px 10px rgba(134, 49, 255, 0.5);
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px #facc15, 0 0 10px #facc15, 0 0 15px #8b5cf6;
            }
            to {
                text-shadow: 0 0 10px #facc15, 0 0 20px #facc15, 0 0 30px #8b5cf6;
            }
        }

        .auth-container {
            z-index: 10;
        }
        
        /* Button hover effect */
        .button-pulse:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .button-pulse:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>

    <!-- Main Authentication Container (Centered on page) -->
    <div id="auth-container" class="auth-container w-full max-w-sm p-8 bg-gray-800 rounded-xl shadow-2xl transition-all duration-500">

        <!-- Title/Logo Area -->
        <h1 class="text-4xl font-extrabold text-yellow-400 mb-10 tracking-wider text-center exciting-title">
            SQUIT: Your <span class="text-indigo-400">ULTIMATE</span> Chat Universe! ðŸš€
        </h1>

        <!-- Loading State (Initially shown while Firebase initializes) -->
        <div id="loading-state" class="text-center text-gray-400">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block text-indigo-400" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading SQUIT...
        </div>

        <!-- Authentication Form (Hidden until Firebase ready or error occurs) -->
        <div id="auth-form" class="hidden">
            <div class="mb-6">
                <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                <input type="email" id="email" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Enter your email" required>
            </div>
            
            <div class="mb-8">
                <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                <input type="password" id="password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Enter your password" required>
            </div>

            <!-- Error Message Display Area -->
            <div id="error-message" class="text-red-400 text-sm mb-4 hidden p-2 bg-red-900 bg-opacity-30 rounded-lg"></div>

            <!-- Action Buttons -->
            <div class="flex flex-col space-y-4">
                <button onclick="handleLogin()" id="login-button" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-300 button-pulse">
                    Log In
                </button>
                <button onclick="handleRegister()" id="register-button" class="w-full py-3 border border-indigo-600 text-indigo-400 font-semibold rounded-lg hover:bg-indigo-900 transition duration-300 button-pulse">
                    Register New Account
                </button>
            </div>
        </div>

        <!-- Chat View (Simulated, shown after successful login) -->
        <div id="chat-view" class="hidden text-center p-6 bg-gray-900 rounded-lg">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Welcome to SQUIT!</h2>
            <p id="user-info" class="text-gray-300 mb-6"></p>
            <button onclick="handleLogout()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-300 button-pulse">
                Log Out
            </button>
        </div>

    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use Debug level for better error visibility in console
        setLogLevel('Debug');

        // Global Firebase instances and user state
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- Utility Functions ---

        /**
         * Simple function to display error messages in the UI.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        /**
         * Updates the UI based on the current user's state.
         * @param {object | null} user - The Firebase User object or null.
         */
        function updateUI(user) {
            const loadingState = document.getElementById('loading-state');
            const authForm = document.getElementById('auth-form');
            const chatView = document.getElementById('chat-view');
            const userInfo = document.getElementById('user-info');
            
            loadingState.classList.add('hidden'); // Hide loading regardless

            if (user) {
                // Logged in
                userId = user.uid;
                authForm.classList.add('hidden');
                chatView.classList.remove('hidden');
                
                const email = user.email || 'Anonymous User';
                userInfo.innerHTML = `You are logged in as: <span class="font-mono text-sm block mt-2 text-yellow-400 break-all">${email}</span><br>Your User ID is: <span class="font-mono text-xs block mt-1 text-gray-400 break-all">${userId}</span>`;

            } else {
                // Logged out
                userId = null;
                authForm.classList.remove('hidden');
                chatView.classList.add('hidden');
            }
        }

        // --- Authentication Handlers ---

        /**
         * Handles user registration with email and password.
         */
        window.handleRegister = async () => {
            if (!auth) {
                displayError("App not initialized. Cannot register.");
                return;
            }
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                displayError("Please enter both email and password.");
                return;
            }

            try {
                // Disable buttons during action
                document.getElementById('register-button').disabled = true;
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("Registration successful for user:", userCredential.user.uid);
            } catch (error) {
                console.error("Registration Error:", error.code, error.message);
                
                let friendlyMessage = "Registration failed. Please check your email format and ensure the password is at least 6 characters long.";
                if (error.code === 'auth/email-already-in-use') {
                    friendlyMessage = "This email is already registered. Try logging in.";
                } else if (error.code === 'auth/weak-password') {
                     friendlyMessage = "Password is too weak. Must be at least 6 characters.";
                }
                displayError(friendlyMessage);
            } finally {
                 document.getElementById('register-button').disabled = false;
            }
        };

        /**
         * Handles user login with email and password.
         */
        window.handleLogin = async () => {
            if (!auth) {
                displayError("App not initialized. Cannot log in.");
                return;
            }
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                displayError("Please enter both email and password.");
                return;
            }

            try {
                // Disable buttons during action
                document.getElementById('login-button').disabled = true;
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful for user:", userCredential.user.uid);
            } catch (error) {
                console.error("Login Error:", error.code, error.message);
                
                let friendlyMessage = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    friendlyMessage = "Invalid email or password.";
                }
                displayError(friendlyMessage);
            } finally {
                document.getElementById('login-button').disabled = false;
            }
        };

        /**
         * Handles user logout.
         */
        window.handleLogout = async () => {
             if (!auth) return;
            try {
                await signOut(auth);
                console.log("User logged out successfully.");
            } catch (error) {
                console.error("Logout Error:", error);
                displayError("Failed to log out.");
            }
        };

        // --- Initialization ---

        /**
         * Main function to initialize Firebase and set up auth listener.
         */
        async function initializeAppAndAuth() {
            const loadingState = document.getElementById('loading-state');
            
            try {
                // Retrieve global variables
                // Fallbacks are necessary in case the environment doesn't define them
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfigJson = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const firebaseConfig = JSON.parse(firebaseConfigJson);

                // CRITICAL CHECK: Check for invalid configuration (Fix for auth/invalid-api-key error)
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    loadingState.innerHTML = `
                        <p class="text-red-500 font-bold mb-4">
                            CRITICAL ERROR: Firebase API Key Missing.
                        </p>
                        <p class="text-sm text-gray-400">
                            The application failed to initialize because the provided 
                            Firebase configuration is invalid. Please ensure 
                            the environment configuration is correct.
                        </p>
                    `;
                    return; // Stop initialization and prevent further errors
                }

                // Initialize services
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set up real-time authentication listener
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    // Update UI whenever auth state changes (login/logout/token expiry)
                    updateUI(user); 
                });

                // Authenticate with the custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                
                // Final UI update based on the initial sign-in attempt
                updateUI(auth.currentUser);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                
                let errorMessage = `Error initializing the app: ${error.message}`;
                
                if (error.code === 'auth/invalid-api-key') {
                    errorMessage = "Firebase Error: Invalid API Key. Please check the provided configuration.";
                }

                // Display a permanent error if Firebase fails to initialize
                loadingState.classList.remove('hidden');
                loadingState.innerHTML = `<p class="text-red-500 font-bold">${errorMessage}</p>`;
            }
        }

        // Start the application initialization when the script loads
        initializeAppAndAuth();

    </script>
</body>
</html>
