<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURY - Realtime Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for dark theme and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Gray-900 */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; /* Gray-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Gray-500 */
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- React will render components here -->
    </div>

    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX/ES6 conversion -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Lucide Icons for React -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>

    <!-- Load Firebase Modules (v11.6.1 is a stable, modern version) -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        
        // Expose Firebase modules to the global scope for the Babel script
        window.firebase = { 
            initializeApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, 
            signInWithPopup, signOut, getFirestore, doc, getDoc, setDoc, updateDoc, 
            onSnapshot, collection, query, where, addDoc, serverTimestamp, deleteDoc,
            setLogLevel
        };
        
        // This is a simple signal to the main script that the imports are ready
        window.firebaseLoaded = true;
    </script>


    <script type="text/babel">
        // Ensure Lucide icons are accessible globally
        const { Send, LogOut, MessageSquare, Plus, User, Search, Hash } = lucide;

        // --- GLOBAL VARIABLES SETUP ---
        // MANDATORY: These variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        let app, auth, db;
        
        // Use an array to store modules, ensuring they are loaded before calling init
        const requiredFirebaseModules = ['initializeApp', 'getAuth', 'getFirestore']; 

        // Utility function for exponential backoff retry for API calls (Firebase)
        const useRetryableApi = (fn, maxRetries = 3) => {
            return React.useCallback(async (...args) => {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        return await fn(...args);
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            throw error;
                        }
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }, [fn, maxRetries]);
        };
        
        // CRITICAL FIX: Custom Promise-based sleep function to wait for Firebase imports
        const waitForFirebase = async () => {
            while (!window.firebaseLoaded || !window.firebase.getAuth) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        };


        // --- CUSTOM MODAL COMPONENT (Replaces alert/confirm) ---
        const Modal = ({ title, message, isOpen, onClose, isError = true }) => {
            if (!isOpen) return null;
            const bgColor = isError ? 'bg-red-900/50' : 'bg-green-900/50';
            const iconColor = isError ? 'text-red-400' : 'text-green-400';
            const buttonColor = isError ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
                    <div className="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <div className="text-center">
                            <div className={`mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColor}`}>
                                <MessageSquare className={`h-6 w-6 ${iconColor}`} />
                            </div>
                            <h3 className="mt-4 text-lg leading-6 font-medium text-white">{title}</h3>
                            <div className="mt-2">
                                <p className="text-sm text-gray-400 whitespace-pre-wrap break-words">{message}</p>
                            </div>
                        </div>
                        <div className="mt-5 sm:mt-6">
                            <button
                                type="button"
                                className={`inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 ${buttonColor} text-base font-medium text-white focus:outline-none transition-colors`}
                                onClick={onClose}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PROFILE SETUP COMPONENT ---
        const ProfileSetup = ({ currentUser, onProfileComplete, setModalState }) => {
            const [displayName, setDisplayName] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);

            React.useEffect(() => {
                // Pre-fill with a suggestion based on email if available
                if (currentUser && currentUser.email && !displayName) {
                    const suggestedName = '@' + currentUser.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '');
                    setDisplayName(suggestedName);
                }
            }, [currentUser]);


            const handleSetup = async () => {
                if (!displayName || !currentUser) {
                    setModalState({ visible: true, title: 'Error', message: 'Display name is required.', isError: true });
                    return;
                }

                const username = displayName.startsWith('@') ? displayName : `@${displayName}`;
                setIsLoading(true);

                try {
                    const userDocRef = firebase.doc(db, 'artifacts', appId, 'users', currentUser.uid);
                    
                    // Create the Firestore User Document
                    await firebase.setDoc(userDocRef, {
                        uid: currentUser.uid,
                        email: currentUser.email || 'N/A',
                        displayName: username,
                        createdAt: currentUser.metadata.creationTime ? new Date(currentUser.metadata.creationTime) : firebase.serverTimestamp(),
                        updatedAt: firebase.serverTimestamp(),
                        status: 'online',
                        isSetupComplete: true,
                    }, { merge: true });

                    onProfileComplete(); // Transition back to the main app component
                } catch (error) {
                    console.error("Profile Setup Error:", error);
                    setModalState({ visible: true, title: 'Setup Failed', message: `Could not complete profile setup. Error: ${error.message}`, isError: true });
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 p-4">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border border-indigo-700">
                        <div className="flex justify-center mb-6">
                            <div className="bg-red-600 p-3 rounded-full">
                                <MessageSquare className="h-8 w-8 text-white" />
                            </div>
                        </div>
                        <h1 className="text-3xl font-bold text-white mb-2">Welcome to FURY!</h1>
                        <p className="text-gray-400 mb-6">
                            Complete your profile to set your chat identity.
                        </p>

                        <div className="mb-4 text-left">
                            <label className="block text-sm font-medium text-gray-300 mb-1">Your login email:</label>
                            <input
                                type="email"
                                value={currentUser?.email || 'N/A'}
                                readOnly
                                className="w-full px-4 py-3 bg-gray-700 text-gray-300 rounded-lg focus:outline-none border border-gray-600"
                            />
                        </div>

                        <div className="mb-4 text-left">
                            <label htmlFor="displayName" className="block text-sm font-medium text-gray-300 mb-1">Chat Display Name (e.g., @developer_vdk)</label>
                            <div className="relative">
                                <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                                <input
                                    id="displayName"
                                    type="text"
                                    value={displayName.replace('@', '')}
                                    onChange={(e) => setDisplayName(e.target.value)}
                                    placeholder="username"
                                    className="w-full pl-8 pr-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:border-indigo-500 border border-gray-600"
                                    disabled={isLoading}
                                />
                            </div>
                        </div>
                        
                        <button
                            onClick={handleSetup}
                            className={`w-full py-3 rounded-lg font-semibold text-lg transition-all ${
                                isLoading ? 'bg-indigo-700 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-500/50'
                            } text-white`}
                            disabled={isLoading}
                        >
                            {isLoading ? 'Completing Setup...' : 'Complete Setup'}
                        </button>
                    </div>
                </div>
            );
        };


        // --- LOGIN COMPONENT ---
        const LoginScreen = ({ setAuthUserAndProfile, setModalState }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            
            const attemptLogin = React.useCallback(async (userCredential) => {
                if (!userCredential || !userCredential.user) return;
                
                const user = userCredential.user;
                
                // Fetch user profile data to check if setup is complete
                const userDocRef = firebase.doc(db, 'artifacts', appId, 'users', user.uid);
                const docSnap = await firebase.getDoc(userDocRef);

                let profileData;
                if (docSnap.exists()) {
                    profileData = docSnap.data();
                    if (!profileData.isSetupComplete) {
                        // User exists but setup is incomplete, ensure we mark for setup
                        setAuthUserAndProfile(user, { uid: user.uid, isSetupComplete: false });
                        return;
                    }
                } else {
                    // New user (e.g., first time Google sign-in)
                    setAuthUserAndProfile(user, { uid: user.uid, isSetupComplete: false });
                    return;
                }
                
                // Login successful and profile is complete
                setAuthUserAndProfile(user, profileData);
                setModalState({ visible: true, title: 'Success', message: 'Logged in successfully!', isError: false });
                
            }, [setAuthUserAndProfile, setModalState]);

            // Login with Email and Password
            const handleManualSignIn = useRetryableApi(async (e) => {
                e.preventDefault();
                if (!email || !password) {
                    setModalState({ visible: true, title: 'Error', message: 'Please enter both email and password.', isError: true });
                    return;
                }
                setIsLoading(true);
                try {
                    const userCredential = await firebase.signInWithEmailAndPassword(auth, email, password);
                    await attemptLogin(userCredential);
                } catch (error) {
                    console.error("Manual Sign-In Error:", error);
                    setModalState({ visible: true, title: 'Sign-In Failed', message: `Login failed: ${error.code} - ${error.message}`, isError: true });
                } finally {
                    setIsLoading(false);
                }
            });

            // Login with Google OAuth
            const handleGoogleSignIn = useRetryableApi(async () => {
                setIsLoading(true);
                try {
                    const provider = new firebase.GoogleAuthProvider();
                    const userCredential = await firebase.signInWithPopup(auth, provider);
                    await attemptLogin(userCredential);
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    // Check for specific error related to unauthorized domain
                    const message = error.code === 'auth/unauthorized-domain'
                        ? 'Sign-In domain is not authorized. Check your Firebase settings.'
                        : `Google Sign-In failed: ${error.code} - ${error.message}`;
                    setModalState({ visible: true, title: 'Sign-In Failed', message: message, isError: true });
                } finally {
                    setIsLoading(false);
                }
            });

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 p-4">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border border-indigo-700">
                        <div className="flex justify-center mb-6">
                            <div className="bg-red-600 p-3 rounded-full">
                                <MessageSquare className="h-10 w-10 text-white" />
                            </div>
                        </div>
                        <h1 className="text-4xl font-extrabold text-red-500 tracking-wider mb-2">FURY</h1>
                        <p className="text-gray-400 mb-8">Connect with friends instantly.</p>

                        <h2 className="text-2xl font-bold text-white mb-6">Sign In</h2>
                        
                        <form onSubmit={handleManualSignIn}>
                            <div className="mb-4">
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="Email"
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:border-indigo-500 border border-gray-600"
                                    disabled={isLoading}
                                />
                            </div>
                            <div className="mb-6">
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Password"
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:border-indigo-500 border border-gray-600"
                                    disabled={isLoading}
                                />
                            </div>
                            <button
                                type="submit"
                                className={`w-full py-3 mb-6 rounded-lg font-semibold text-lg transition-all ${
                                    isLoading ? 'bg-indigo-700 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-500/50'
                                } text-white`}
                                disabled={isLoading}
                            >
                                {isLoading ? 'Logging In...' : 'Log In'}
                            </button>
                        </form>

                        <div className="text-gray-500 mb-6">OR</div>

                        <button
                            onClick={handleGoogleSignIn}
                            className={`w-full py-3 rounded-lg font-semibold text-lg transition-all flex items-center justify-center space-x-2 ${
                                isLoading ? 'bg-red-700 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/50'
                            } text-white`}
                            disabled={isLoading}
                        >
                            <svg className="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M44.5 24c0-2.4-0.2-4.7-0.7-6.9H24v4.5h11.9c-0.5 2.5-1.9 4.8-4.1 6.3l-0.1 0.1 3.7 2.8c2.2-2.1 3.7-4.7 4.5-7.7z" fill="#4285F4"/>
                                <path d="M24 44.5c6.2 0 11.4-2 15.2-5.4l-3.7-2.8c-2.1 1.4-4.8 2.3-7.5 2.3-5.8 0-10.7-3.9-12.5-9.1l-0.1 0.1-3.6 2.8c1.7 3.4 4.8 5.7 8.9 6.5z" fill="#34A853"/>
                                <path d="M11.5 28.1c-0.5-1.4-0.8-2.9-0.8-4.1s0.3-2.7 0.8-4.1l-0.1-0.1-3.8-2.9c-1.2 2.3-1.9 4.8-1.9 7.1s0.7 4.8 1.9 7.1l3.8-2.9z" fill="#FBBC05"/>
                                <path d="M24 10.3c3.4 0 6.4 1.2 8.8 3.3l3.3-3.2c-4-3.7-8.9-6-12.1-6s-9.4 2.2-12.5 6.5l3.8 2.9c1.9-4 5.9-6.3 10.7-6.3z" fill="#EA4335"/>
                            </svg>
                            <span>Sign in with Google</span>
                        </button>

                        <p className="text-xs text-gray-500 mt-6">
                            By signing in, you agree to our <a href="#" className="text-red-400 hover:underline">Terms of Service</a>.
                        </p>
                    </div>
                </div>
            );
        };


        // --- DASHBOARD COMPONENT ---
        const Dashboard = ({ userProfile, signOutUser, userId }) => {
            const [messages, setMessages] = React.useState([]);
            const [messageText, setMessageText] = React.useState('');
            const [selectedChannelId, setSelectedChannelId] = React.useState('global-main-chat'); // Default to global chat
            const messageListRef = React.useRef(null);

            // --- Message Listener ---
            React.useEffect(() => {
                if (!db || !userProfile || !selectedChannelId) return;

                // Path: /artifacts/{appId}/public/data/messages/{channelId}/channelMessages
                const channelDocRef = firebase.doc(db, 'artifacts', appId, 'public', 'data', 'messages', selectedChannelId);
                const messagesQuery = firebase.query(
                    firebase.collection(channelDocRef, 'channelMessages'),
                    // Note: Sorting client-side to avoid index requirement errors
                );

                const unsubscribe = firebase.onSnapshot(messagesQuery, (snapshot) => {
                    const newMessages = [];
                    snapshot.forEach(doc => {
                        newMessages.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort client-side by timestamp
                    newMessages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                    setMessages(newMessages);
                }, (error) => {
                    console.error("Error listening to messages:", error);
                });

                return () => unsubscribe();
            }, [selectedChannelId]);


            // Scroll to bottom when messages update
            React.useEffect(() => {
                if (messageListRef.current) {
                    messageListRef.current.scrollTop = messageListRef.current.scrollHeight;
                }
            }, [messages]);


            const handleSendMessage = async (e) => {
                e.preventDefault();
                const trimmedText = messageText.trim();
                if (!trimmedText || !db || !userProfile) return;

                const senderId = userProfile.uid;
                const senderName = userProfile.displayName;

                try {
                    // Path: /artifacts/{appId}/public/data/messages/{channelId}/channelMessages
                    const channelDocRef = firebase.doc(db, 'artifacts', appId, 'public', 'data', 'messages', selectedChannelId);
                    const channelMessagesCollectionRef = firebase.collection(channelDocRef, 'channelMessages');

                    await firebase.addDoc(channelMessagesCollectionRef, {
                        senderId: senderId,
                        senderName: senderName,
                        text: trimmedText,
                        timestamp: firebase.serverTimestamp(),
                    });

                    setMessageText('');
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            };


            // --- UI/Rendering Components ---
            const MessageBubble = ({ message, isCurrentUser }) => {
                const bubbleColor = isCurrentUser ? 'bg-indigo-600' : 'bg-gray-700';
                const alignment = isCurrentUser ? 'self-end' : 'self-start';
                const senderName = isCurrentUser ? 'You' : message.senderName;
                
                // Format timestamp
                const date = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return (
                    <div className={`flex flex-col max-w-lg ${alignment} my-1`}>
                        <span className={`text-xs font-semibold ${isCurrentUser ? 'text-right text-gray-400' : 'text-indigo-400'} mb-0.5`}>
                            {senderName}
                        </span>
                        <div className={`px-4 py-2 rounded-xl text-white ${bubbleColor} shadow-md`}>
                            <p className="text-sm break-words">{message.text}</p>
                        </div>
                        <span className={`text-xs text-gray-500 mt-0.5 ${isCurrentUser ? 'text-right' : 'text-left'}`}>
                            {timeString}
                        </span>
                    </div>
                );
            };

            const ChannelButton = ({ id, name, isSelected, onClick }) => (
                <button
                    onClick={() => onClick(id)}
                    className={`w-full text-left p-3 rounded-lg flex items-center space-x-2 transition-colors ${
                        isSelected ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700'
                    }`}
                >
                    <Hash className="w-5 h-5" />
                    <span className="font-medium truncate">{name}</span>
                </button>
            );

            const UserDisplay = ({ name, status }) => (
                <div className="flex items-center space-x-3 p-2">
                    <div className={`w-3 h-3 rounded-full ${status === 'online' ? 'bg-green-500' : 'bg-gray-500'}`}></div>
                    <span className="text-sm text-gray-300 font-medium">{name}</span>
                </div>
            );

            const channels = [
                { id: 'global-main-chat', name: 'main-chat' },
                { id: 'global-dev-talk', name: 'dev-talk' },
            ];

            const otherUsers = [
                { name: '@JohnDoe', status: 'online' },
                { name: '@JaneS_Dev', status: 'away' },
                { name: '@Guest123', status: 'online' },
            ];


            return (
                <div className="flex h-screen bg-gray-900 text-white font-sans">
                    
                    {/* --- Left Sidebar (Servers/Channels) --- */}
                    <div className="w-64 flex flex-col bg-gray-800 border-r border-gray-700">
                        <div className="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h2 className="text-xl font-bold text-white">FURY</h2>
                            <button onClick={signOutUser} className="text-gray-400 hover:text-red-500 transition-colors">
                                <LogOut className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="p-3 flex-grow overflow-y-auto custom-scrollbar">
                            {/* Direct Messages Section */}
                            <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 mt-4">Direct Messages</h3>
                            <div className="space-y-1">
                                {otherUsers.slice(0, 2).map(u => (
                                    <UserDisplay key={u.name} name={u.name} status={u.status} />
                                ))}
                            </div>

                            {/* Channels Section */}
                            <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 mt-4">Global FURY Channels</h3>
                            <div className="space-y-1">
                                {channels.map(channel => (
                                    <ChannelButton
                                        key={channel.id}
                                        id={channel.id}
                                        name={channel.name}
                                        isSelected={selectedChannelId === channel.id}
                                        onClick={setSelectedChannelId}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* User Profile Footer */}
                        <div className="p-4 bg-gray-900 border-t border-gray-700 flex items-center justify-between">
                            <div className="flex items-center space-x-3 truncate">
                                <User className="w-6 h-6 text-indigo-400" />
                                <span className="text-sm font-semibold truncate" title={userProfile.displayName}>{userProfile.displayName}</span>
                            </div>
                        </div>
                    </div>

                    {/* --- Chat Panel (Main Content) --- */}
                    <div className="flex flex-col flex-grow">
                        {/* Header */}
                        <header className="p-4 border-b border-gray-700 bg-gray-800 shadow-md flex items-center space-x-2">
                            <Hash className="w-6 h-6 text-gray-400" />
                            <h1 className="text-lg font-semibold text-white">
                                {channels.find(c => c.id === selectedChannelId)?.name || 'Welcome'}
                            </h1>
                        </header>

                        {/* Message List */}
                        <div ref={messageListRef} className="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar bg-gray-900">
                            {messages.length === 0 ? (
                                <div className="text-center text-gray-500 pt-10">
                                    <p>Start the conversation! Be the first to send a message.</p>
                                </div>
                            ) : (
                                messages.map((message) => (
                                    <MessageBubble 
                                        key={message.id} 
                                        message={message} 
                                        isCurrentUser={message.senderId === userId}
                                    />
                                ))
                            )}
                        </div>

                        {/* Message Input */}
                        <footer className="p-4 border-t border-gray-700 bg-gray-800">
                            <form onSubmit={handleSendMessage} className="flex space-x-3">
                                <input
                                    type="text"
                                    value={messageText}
                                    onChange={(e) => setMessageText(e.target.value)}
                                    placeholder="Type a message..."
                                    className="flex-grow px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-700"
                                />
                                <button
                                    type="submit"
                                    className="p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50"
                                    disabled={!messageText.trim()}
                                >
                                    <Send className="w-6 h-6" />
                                </button>
                            </form>
                        </footer>
                    </div>
                </div>
            );
        };


        // --- MAIN APP COMPONENT ---
        function App() {
            // Auth State
            const [currentUser, setCurrentUser] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false); // True when onAuthStateChanged has run once
            const [userProfile, setUserProfile] = React.useState(null); // Firestore user data
            const [hasConfigError, setHasConfigError] = React.useState(false);

            // UI State
            const [isLoading, setIsLoading] = React.useState(true);
            const [modalState, setModalState] = React.useState({ visible: false, title: '', message: '', isError: true });

            // CRITICAL: Function to set both Auth User and Profile Data
            const setAuthUserAndProfile = React.useCallback((user, profile) => {
                setCurrentUser(user);
                setUserId(user ? user.uid : null);
                setUserProfile(profile);
                setIsAuthReady(true);
                setIsLoading(false);
            }, []);

            // Handle Auth Sign-out
            const signOutUser = useRetryableApi(async () => {
                try {
                    if (auth) {
                        await firebase.signOut(auth);
                    }
                    // Reset all state after sign out
                    setCurrentUser(null);
                    setUserId(null);
                    setUserProfile(null);
                    setIsAuthReady(true);
                    setIsLoading(false);
                    setModalState({ visible: true, title: 'Signed Out', message: 'You have been signed out successfully.', isError: false });
                } catch (error) {
                    console.error("Sign Out Error:", error);
                    setModalState({ visible: true, title: 'Sign Out Failed', message: `Could not sign out: ${error.message}`, isError: true });
                }
            });

            // CRITICAL: Handles profile data loading and state transition
            const checkAndFetchProfile = React.useCallback(async (user) => {
                if (!db || !user) {
                    setIsAuthReady(true);
                    setIsLoading(false);
                    return;
                }

                setIsLoading(true);
                console.log(`Checking profile for user: ${user.uid}`);

                try {
                    const userDocRef = firebase.doc(db, 'artifacts', appId, 'users', user.uid);
                    const docSnap = await firebase.getDoc(userDocRef);

                    if (docSnap.exists() && docSnap.data().isSetupComplete) {
                        // Profile exists and is complete -> Go to Dashboard
                        setAuthUserAndProfile(user, docSnap.data());
                        console.log("Profile found and complete. Loading dashboard.");
                    } else {
                        // Profile is missing or incomplete -> Go to Setup Screen
                        // Set the profile to incomplete to trigger the ProfileSetup component
                        setAuthUserAndProfile(user, { uid: user.uid, isSetupComplete: false }); 
                        console.log("Profile missing or incomplete. Redirecting to setup.");
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    setModalState({ visible: true, title: 'Data Error', message: `Failed to load user profile. Error: ${error.message}`, isError: true });
                    // Fallback: If data fails, still transition to setup screen (it might fix itself there)
                    setAuthUserAndProfile(user, { uid: user.uid, isSetupComplete: false });
                } finally {
                    setIsLoading(false); // Crucial to resolve the loading state
                }
            }, [setAuthUserAndProfile]);

            // --- Core Firebase Initialization and Auth Listener ---
            React.useEffect(() => {
                let unsubscribeAuth = () => {};
                
                const initializeFirebase = async () => {
                    await waitForFirebase(); // Wait for Firebase modules to load

                    try {
                        const firebaseConfig = JSON.parse(firebaseConfigRaw);

                        // CRITICAL: Check for valid Firebase Config (prevents API key error)
                        if (!firebaseConfig || !firebaseConfig.apiKey) {
                            console.error("FIREBASE CONFIG ERROR: apiKey is missing or config is invalid.");
                            setHasConfigError(true);
                            setIsLoading(false);
                            return;
                        }

                        // Initialize Firebase services
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.getAuth(app);
                        db = firebase.getFirestore(app);
                        firebase.setLogLevel('debug'); // Enable detailed console logging

                        // CRITICAL: Auth State Change Listener
                        unsubscribeAuth = firebase.onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                console.log("Auth state changed: Logged in.", user.uid);
                                // Don't set state directly here; let checkAndFetchProfile handle it
                                await checkAndFetchProfile(user); 
                            } else {
                                console.log("Auth state changed: Logged out or Anonymous.");
                                setAuthUserAndProfile(null, null);
                                setIsLoading(false);
                                
                                // Attempt silent anonymous sign-in if no token is available
                                if (!initialAuthToken) {
                                     try {
                                         await firebase.signInAnonymously(auth);
                                     } catch (anonError) {
                                         console.error("Anonymous Sign-In Failed:", anonError);
                                     }
                                }
                            }
                        }, (error) => {
                            console.error("onAuthStateChanged Error:", error);
                            setModalState({ visible: true, title: 'Auth Error', message: `Critical Authentication Error: ${error.message}`, isError: true });
                            setAuthUserAndProfile(null, null);
                            setIsLoading(false);
                        });

                        // Initial custom token sign-in attempt (MUST be before onAuthStateChanged returns)
                        if (initialAuthToken) {
                            try {
                                console.log("Attempting initial sign-in with custom token...");
                                // This signIn call will trigger the onAuthStateChanged listener above
                                await firebase.signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Custom Token Sign-In Failed:", error);
                                // If token fails, onAuthStateChanged will handle the subsequent anonymous or null state
                            }
                        }

                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        setModalState({ visible: true, title: 'Initialization Error', message: `Failed to initialize Firebase: ${error.message}`, isError: true });
                        setHasConfigError(true);
                        setIsLoading(false);
                    }
                };

                initializeFirebase();

                return () => {
                    unsubscribeAuth();
                };
            }, [checkAndFetchProfile, setAuthUserAndProfile]); // Run only once on mount

            // Handles the transition from ProfileSetup back to Dashboard
            const handleProfileComplete = React.useCallback(async () => {
                if (currentUser) {
                    await checkAndFetchProfile(currentUser);
                }
            }, [currentUser, checkAndFetchProfile]);


            // --- RENDERING LOGIC ---

            // 1. Config Error Screen (Highest Priority)
            if (hasConfigError) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 p-4">
                        <div className="text-center text-red-500">
                            <h1 className="text-3xl font-bold mb-4">Firebase Configuration Error</h1>
                            <p className="text-lg">Please ensure the Firebase configuration object includes a valid `apiKey`.</p>
                        </div>
                        <Modal
                            title={modalState.title}
                            message={modalState.message}
                            isOpen={modalState.visible}
                            onClose={() => setModalState({ ...modalState, visible: false })}
                            isError={modalState.isError}
                        />
                    </div>
                );
            }

            // 2. Loading/Authenticating Screen
            if (isLoading || !isAuthReady) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900">
                        <svg className="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p className="mt-4 text-white font-medium">
                            {currentUser ? 'Loading profile data...' : 'Authenticating...'}
                        </p>
                    </div>
                );
            }

            // 3. User is Authenticated, but Profile is Incomplete -> Profile Setup
            if (currentUser && userProfile && !userProfile.isSetupComplete) {
                return (
                    <>
                        <ProfileSetup
                            currentUser={currentUser}
                            onProfileComplete={handleProfileComplete}
                            setModalState={setModalState}
                        />
                        <Modal
                            title={modalState.title}
                            message={modalState.message}
                            isOpen={modalState.visible}
                            onClose={() => setModalState({ ...modalState, visible: false })}
                            isError={modalState.isError}
                        />
                    </>
                );
            }

            // 4. User is Authenticated and Profile is Complete -> Dashboard
            if (currentUser && userProfile && userProfile.isSetupComplete) {
                return (
                    <>
                        <Dashboard 
                            userProfile={userProfile} 
                            signOutUser={signOutUser} 
                            userId={currentUser.uid}
                        />
                        <Modal
                            title={modalState.title}
                            message={modalState.message}
                            isOpen={modalState.visible}
                            onClose={() => setModalState({ ...modalState, visible: false })}
                            isError={modalState.isError}
                        />
                    </>
                );
            }
            
            // 5. User is NOT Authenticated -> Login Screen
            return (
                <>
                    <LoginScreen setAuthUserAndProfile={setAuthUserAndProfile} setModalState={setModalState} />
                    <Modal
                        title={modalState.title}
                        message={modalState.message}
                        isOpen={modalState.visible}
                        onClose={() => setModalState({ ...modalState, visible: false })}
                        isError={modalState.isError}
                    />
                </>
            );
        }

        // Render the application after Firebase modules are guaranteed to be available
        window.onload = async () => {
            await waitForFirebase();
            const container = document.getElementById('app');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        };

    </script>
</body>
</html>
