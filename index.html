<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squit Up! Chat Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #12121e; /* Darker background */
            color: #e0e0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.3s;
        }
        .auth-container {
            background-color: #1a1a2e; /* Card background */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid #3f3f6e;
        }
        .app-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #8c8cd9; /* SQUIIIT UP! purple glow */
            text-shadow: 0 0 10px rgba(140, 140, 217, 0.7);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .subtitle {
            color: #a0a0c0;
            text-align: center;
            margin-bottom: 2rem;
        }
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            background-color: #4285f4;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        .btn-google:hover {
            background-color: #357ae8;
            transform: translateY(-1px);
        }
        .btn-google img {
            margin-right: 0.75rem;
        }
        .input-field {
            background-color: #2a2a4a;
            border: 1px solid #3f3f6e;
            color: #e0e0f0;
        }
        .message-box {
            background-color: #993333;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid #cc6666;
        }
        .dashboard-layout {
            display: grid;
            grid-template-columns: 280px 1fr; /* Sidebar and main content */
            height: 100vh;
            width: 100vw;
        }
        .sidebar {
            background-color: #1a1a2e;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #3f3f6e;
        }
        .main-content {
            background-color: #12121e;
            padding: 1rem;
            overflow-y: auto;
        }
        .chat-area {
            height: calc(100vh - 120px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            word-wrap: break-word;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .message-user {
            background-color: #8c8cd9;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .message-other {
            background-color: #2a2a4a;
            color: #e0e0f0;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .message-system {
            background-color: #3f3f6e;
            color: #a0a0c0;
            text-align: center;
            margin: 0 auto;
            padding: 0.5rem 1rem;
            font-style: italic;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #3f3f6e;
            border-top: 4px solid #8c8cd9;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Google Fonts Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged,
            signInAnonymously,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug');

        // Global Firebase variables
        let app, db, auth;
        let userId = null;
        let userProfile = null; // Stores the user's fetched profile including @user_id
        const provider = new GoogleAuthProvider();

        // --- Utility Functions ---
        
        // Custom Message Box UI instead of alert()
        function showMessageBox(message) {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
            }
        }
        function hideMessageBox() {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.classList.add('hidden');
                messageBox.textContent = '';
            }
        }

        // --- Core App State & Router ---

        const appState = {
            currentView: 'loading', // 'loading', 'auth', 'profile_setup', 'dashboard'
            loadingMessage: 'Initializing Firebase...',
            errorMessage: null,
            activeChat: null,
            isCheckingUserId: false,
        };

        const router = {
            setView(viewName) {
                appState.currentView = viewName;
                renderApp();
            },
            setError(message) {
                appState.errorMessage = message;
                showMessageBox(message);
                renderApp();
            },
            clearError() {
                appState.errorMessage = null;
                hideMessageBox();
            }
        };

        // --- Firebase Initialization and Auth ---

        async function initializeFirebase() {
            router.clearError();
            try {
                // Access global Canvas variables
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing or empty.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Try to sign in using the custom token provided by the canvas environment
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback: Sign in anonymously to allow reading public data (like checking unique user IDs)
                    await signInAnonymously(auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (user.isAnonymous) {
                            // User is signed in anonymously, show the Google sign-in prompt
                            router.setView('auth');
                        } else {
                            // User is signed in with Google, proceed to profile check
                            await checkUserProfile(user.uid, user.displayName, user.email);
                        }
                    } else {
                        // Not signed in, show the Google sign-in prompt
                        userId = null;
                        router.setView('auth');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Specifically detect the Firestore issue due to missing billing/rules
                if (error.code === 'failed-precondition' || (error.message && (error.message.includes('permission-denied') || error.message.includes('NOT_FOUND')))) {
                    router.setError("Database Error: Firestore is likely not enabled or security rules are too restrictive. Please enable Cloud Firestore in your Firebase console.");
                } else {
                    router.setError(`Initialization failed: ${error.message}`);
                }
            }
        }
        
        // --- Profile Management ---

        async function checkUserProfile(uid, displayName, email) {
            router.clearError();
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    // User profile exists, go to dashboard
                    userProfile = docSnap.data();
                    router.setView('dashboard');
                } else {
                    // User profile does NOT exist, go to setup
                    userProfile = {
                        uid,
                        displayName: displayName || 'New User',
                        email: email || '',
                        username: '', // Will be set in setup view
                        createdAt: Timestamp.now(),
                    };
                    router.setView('profile_setup');
                }
            } catch (error) {
                console.error("Error during user profile check:", error);
                router.setError("Error checking profile: Could not connect to database. Please ensure Cloud Firestore is enabled and rules are public.");
            }
        }
        
        async function checkUserIdAvailability(userIdToCheck) {
            if (!userIdToCheck) return false;
            
            appState.isCheckingUserId = true;
            renderApp();
            router.clearError();

            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where("username", "==", userIdToCheck.toLowerCase()));
            
            try {
                const querySnapshot = await getDocs(q);
                appState.isCheckingUserId = false;
                renderApp();
                return querySnapshot.empty; // Returns true if no matching documents are found
            } catch (error) {
                appState.isCheckingUserId = false;
                renderApp();
                console.error("Error checking user ID availability:", error);
                router.setError("Database Error: Cannot check user ID uniqueness. Ensure Cloud Firestore is enabled.");
                return false; // Assume not available on failure to prevent accidental creation
            }
        }
        
        async function completeProfileSetup() {
            const usernameInput = document.getElementById('setup-username');
            const username = usernameInput.value.trim().toLowerCase();
            
            if (!username || username.length < 3) {
                showMessageBox("User ID must be at least 3 characters long.");
                return;
            }

            if (!username.startsWith('@')) {
                showMessageBox("User ID must start with '@'.");
                return;
            }
            
            const available = await checkUserIdAvailability(username);

            if (appState.errorMessage) {
                // If checkUserIdAvailability set an error (database failure), stop here
                return;
            }

            if (!available) {
                showMessageBox("That @User ID is already taken. Please choose another.");
                return;
            }

            // User ID is unique and valid. Save the profile.
            try {
                userProfile.username = username;
                
                const docRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await setDoc(docRef, userProfile);
                
                router.setView('dashboard');
                
            } catch (error) {
                console.error("Error saving user profile:", error);
                router.setError("Database Write Error: Failed to save user profile. Ensure Firestore rules allow writing.");
            }
        }

        // --- Google Sign-In Handler ---

        window.handleGoogleSignIn = async function() {
            router.clearError();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest (checkUserProfile)
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                router.setError(`Sign-In Error: ${error.message}`);
            }
        }

        // --- Component Rendering ---

        function renderAuthView() {
            return `
                <div class="auth-container">
                    <h1 class="app-title">SQUIT UP!</h1>
                    <p class="subtitle">chatting and chilling lounge friends</p>
                    <h2 class="text-xl font-semibold mb-6 text-center text-white">CONNECT ACCOUNT</h2>
                    
                    <button onclick="handleGoogleSignIn()" class="btn-google w-full mb-4">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google Logo" />
                        Continue with Google
                    </button>
                    
                    <div id="message-box" class="message-box hidden"></div>

                    <p class="text-center text-sm mt-4 text-gray-400">
                        Sign in to connect with friends and communities.
                    </p>
                </div>
            `;
        }
        
        function renderProfileSetupView() {
            const isChecking = appState.isCheckingUserId;
            return `
                <div class="auth-container">
                    <h1 class="app-title">SQUIT UP!</h1>
                    <p class="subtitle">Final Step: Choose Your @User ID</p>
                    <h2 class="text-lg font-semibold mb-4 text-center text-white">Your Profile Name</h2>

                    <div class="mb-4">
                        <label for="setup-username" class="block text-sm font-medium mb-1 text-gray-400">@User ID (Unique)</label>
                        <input type="text" id="setup-username" placeholder="@yourname" class="input-field w-full px-4 py-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" value="@">
                    </div>
                    
                    <button onclick="completeProfileSetup()" ${isChecking ? 'disabled' : ''} 
                        class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-150 flex items-center justify-center ${isChecking ? 'opacity-50 cursor-not-allowed' : ''}">
                        ${isChecking ? '<div class="loader w-5 h-5 border-2 mr-2"></div>' : ''}
                        ${isChecking ? 'Checking...' : 'Complete Registration'}
                    </button>
                    
                    <div id="message-box" class="message-box hidden mt-4"></div>

                    <p class="text-center text-sm mt-4 text-gray-400">
                        Your @User ID is how friends will find you.
                    </p>
                </div>
            `;
        }

        function renderDashboardView() {
            return `
                <div class="dashboard-layout">
                    <!-- Sidebar -->
                    <div class="sidebar flex flex-col justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-6">SQUIT UP!</h2>
                            <p class="text-gray-400 text-sm">Welcome, <span class="text-indigo-400 font-semibold">${userProfile.username || userProfile.displayName}</span>!</p>
                            <div class="mt-6">
                                <h3 class="text-xs font-semibold uppercase text-gray-500 mb-2">Friends</h3>
                                <ul class="space-y-2">
                                    <li class="text-gray-300 hover:text-indigo-400 cursor-pointer transition duration-150">Add Friend</li>
                                    <li class="text-gray-300 hover:text-indigo-400 cursor-pointer transition duration-150">Friend Requests</li>
                                    <li class="text-gray-300 hover:text-indigo-400 cursor-pointer transition duration-150">My Servers</li>
                                </ul>
                            </div>
                        </div>
                        <button onclick="signOutUser()" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-150">
                            Logout
                        </button>
                    </div>

                    <!-- Main Content -->
                    <div class="main-content flex flex-col">
                        <header class="h-16 flex items-center border-b border-gray-700 mb-4">
                            <h2 class="text-xl font-bold text-white"># General Chat</h2>
                        </header>
                        <div class="chat-area flex-grow">
                            <!-- Placeholder Messages -->
                            <div class="message-system self-center">Welcome! This is where real-time chat messages will appear.</div>
                            <div class="message-other">
                                <span class="font-bold text-indigo-400">@System:</span> This chat is currently static until the database connection is fully established.
                            </div>
                            <div class="message-user self-end">
                                <span class="font-bold">Me (${userProfile.username}):</span> I successfully logged in!
                            </div>
                        </div>
                        <div class="message-input-area mt-4">
                            <input type="text" placeholder="Type a message..." class="input-field flex-grow px-4 py-2 rounded-l-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-r-lg transition duration-150">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoadingView() {
            return `
                <div class="auth-container flex flex-col items-center">
                    <h1 class="app-title">SQUIT UP!</h1>
                    <p class="subtitle mb-8">Loading...</p>
                    <div class="loader w-10 h-10"></div>
                    <p class="text-center text-sm mt-4 text-gray-400">${appState.loadingMessage}</p>
                    <div id="message-box" class="message-box ${appState.errorMessage ? '' : 'hidden'} mt-4">
                        ${appState.errorMessage || ''}
                    </div>
                </div>
            `;
        }
        
        function renderApp() {
            const appContainer = document.getElementById('app-container');
            let content = '';

            // Handle global error display first
            if (appState.errorMessage && appState.currentView !== 'loading') {
                showMessageBox(appState.errorMessage);
            } else if (appState.currentView !== 'loading') {
                hideMessageBox();
            }

            switch (appState.currentView) {
                case 'auth':
                    content = renderAuthView();
                    break;
                case 'profile_setup':
                    content = renderProfileSetupView();
                    break;
                case 'dashboard':
                    content = renderDashboardView();
                    break;
                case 'loading':
                default:
                    content = renderLoadingView();
                    break;
            }
            appContainer.innerHTML = content;
        }
        
        window.signOutUser = function() {
            router.clearError();
            auth.signOut().then(() => {
                userProfile = null;
                router.setView('auth');
            }).catch(error => {
                console.error("Sign out error:", error);
                router.setError("Could not sign out. Check console.");
            });
        }

        // Initialize on load
        window.onload = initializeFirebase;
    </script>
</head>
<body>
    <div id="app-container">
        <!-- Content will be rendered here by JavaScript -->
    </div>
</body>
</html>
