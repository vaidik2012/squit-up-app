<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squit Up! Chat Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #12121e; /* Darker background */
            color: #e0e0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.3s;
        }
        .auth-container {
            background-color: #1a1a2e; /* Card background */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid #3f3f6e;
        }
        .app-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #8c8cd9; /* SQUIIIT UP! purple glow */
            text-shadow: 0 0 10px rgba(140, 140, 217, 0.7);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .subtitle {
            color: #a0a0c0;
            text-align: center;
            margin-bottom: 2rem;
        }
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            background-color: #4285f4;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        .btn-google:hover {
            background-color: #357ae8;
            transform: translateY(-1px);
        }
        .btn-google img {
            margin-right: 0.75rem;
        }
        .input-field {
            background-color: #2a2a4a;
            border: 1px solid #3f3f6e;
            color: #e0e0f0;
        }
        .error-message {
            background-color: #993333;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid #cc6666;
        }
        .dashboard-layout {
            display: grid;
            grid-template-columns: 280px 1fr; /* Sidebar and main content */
            height: 100vh;
            width: 100vw;
        }
        .sidebar {
            background-color: #1a1a2e;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #3f3f6e;
            user-select: none;
        }
        .main-content {
            background-color: #12121e;
            padding: 1rem;
            overflow-y: auto;
        }
        .chat-area {
            height: calc(100vh - 120px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message-input-area {
            display: flex;
            padding-top: 10px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #1a1a2e;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 450px;
            border: 1px solid #3f3f6e;
        }
        .btn-register:disabled {
            background-color: #555588;
            cursor: not-allowed;
        }
        /* Custom styles for the WELCOME alert title */
        .modal-title-welcome {
            font-size: 1.5rem;
            font-weight: 800;
            color: #8c8cd9; /* SQUIIIT UP! purple glow */
            text-shadow: 0 0 5px rgba(140, 140, 217, 0.7);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        /* --- Sidebar Styles --- */
        .sidebar-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: left;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }
        .sidebar-item.friend-link {
            background-color: #2a2a4a;
            color: #e0e0f0;
        }
        .sidebar-item.friend-link:hover {
            background-color: #3f3f6e;
            transform: translateY(-1px);
        }
        .sidebar-item.friend-link .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .sidebar-item.friend-link .status-online {
            background-color: #34d399; /* Green */
        }
        .sidebar-item.friend-link .status-offline {
            background-color: #fca5a5; /* Red */
        }

        .sidebar-item.add-friend-btn {
            background-color: #000000;
            color: #ffffff;
            border: 1px solid #3f3f6e;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
            justify-content: center;
        }
        .sidebar-item.add-friend-btn:hover {
            background-color: #1a1a1a;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        .request-item {
            justify-content: space-between;
            background-color: #4a2a4a; /* Purple for requests */
            color: #f0e0ff;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        .request-item:hover {
            background-color: #5e3b5e;
            transform: translateY(-1px);
        }
        
        /* New style for the sidebar section headers (Pimping them up!) */
        .sidebar-section-header {
            color: #b3ccff; /* Bright light blue/periwinkle */
            font-weight: 700;
            text-shadow: 0 0 4px rgba(179, 204, 255, 0.5); /* Subtle glow */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #3f3f6e;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
    </style>
    <!-- Google Fonts Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut,
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            updateDoc,
            arrayUnion,
            arrayRemove,
            Timestamp,
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug');

        // --- HARDCODED FIREBASE CONFIGURATION ---
        const explicitFirebaseConfig = {
            apiKey: "AIzaSyB1zvVHaBrbzX5iA9fBVNGa_3sY1-WCSpY",
            authDomain: "squit-up-auth.firebaseapp.com",
            projectId: "squit-up-auth",
            storageBucket: "squit-up-auth.firebasestorage.app",
            messagingSenderId: "503910898443",
            appId: "1:503910898443:web:c5a56eb24cd4f183d8600e",
            measurementId: "G-K4LHFHSNJC"
        };
        // ------------------------------------------

        // Global Firebase variables
        let app, db, auth;
        let userId = null;
        let userDisplayName = 'Guest';
        let userProfile = null;
        let isAuthReady = false;
        let profileUniquenessListener = null;
        let profileListener = null; // Listener for the current user's profile updates
        
        // --- Utility Functions ---
        
        /**
         * Shows a custom modal alert.
         * @param {string} message - The content message.
         * @param {string} [title="Alert"] - The modal title.
         */
        function showCustomAlert(message, title = "Alert") {
            const container = document.getElementById('app-container');
            let modal = document.getElementById('custom-alert-modal');

            const titleClass = title === "WELCOME!" ? 'modal-title-welcome' : 'text-xl font-bold mb-4 text-white';

            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-alert-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 id="alert-title" class="text-xl font-bold mb-4 text-white"></h3>
                        <p id="alert-message" class="text-gray-300 mb-6"></p>
                        <button id="alert-ok-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-150">
                            OK
                        </button>
                    </div>
                `;
                container.appendChild(modal);
                document.getElementById('alert-ok-btn').onclick = () => modal.remove();
            }
            
            // Set the title and message
            const titleElement = document.getElementById('alert-title');
            titleElement.textContent = title;
            titleElement.className = titleClass;
            document.getElementById('alert-message').textContent = message;
            
            modal.style.display = 'flex';
        }

        // --- Core App State & Router ---

        const appState = {
            currentView: 'loading', // 'loading', 'auth', 'profile_setup', 'dashboard'
            user: null,
            loadingMessage: 'Initializing Firebase...',
            errorMessage: null,
            activeChat: null,
            isUserIdUnique: false,
            isIdConflict: false,
            pendingUserId: '',
            isSubmitting: false,
            
            // Friend Request State
            pendingFriendRequests: [], // Array of UIDs who sent a request
            friendsList: [], // Array of UIDs who are friends
            allProfiles: {}, // Map of UID -> {userId, displayName, status} for display
        };

        const router = {
            getView() { return appState.currentView; },
            setView(viewName) {
                if (appState.currentView === 'profile_setup' && profileUniquenessListener) {
                    profileUniquenessListener();
                    profileUniquenessListener = null;
                }
                // Cleanup the main profile listener when leaving dashboard
                if (appState.currentView === 'dashboard' && viewName !== 'dashboard' && profileListener) {
                    profileListener();
                    profileListener = null;
                }
                
                appState.currentView = viewName;
                renderApp();
            },
            setError(message) {
                appState.errorMessage = message;
                renderApp();
            },
            clearError() {
                appState.errorMessage = null;
                renderApp();
            }
        };

        // --- Firebase Initialization and Auth ---

        async function initializeFirebase() {
            try {
                const firebaseConfig = explicitFirebaseConfig;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                onAuthStateChanged(auth, async (user) => {
                    appState.user = user;
                    userId = user ? user.uid : null;
                    isAuthReady = true;

                    if (user) {
                        router.clearError();
                        await checkUserProfile(user);
                    } else {
                        router.setView('auth');
                    }
                    renderApp();
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                router.setError("Error initializing app. Check console for details.");
            }
        }

        // --- Firestore Functions ---

        /**
         * Real-time listener for the current user's profile data.
         * This handles friend requests, friend list, and status updates.
         */
        function setupUserProfileListener(uid) {
            // Unsubscribe existing listener if present
            if (profileListener) {
                profileListener();
            }

            const appId = explicitFirebaseConfig.projectId;
            const docRef = doc(db, `artifacts/${appId}/public/data/profiles/${uid}`);
            
            profileListener = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    userDisplayName = userProfile.userId || userProfile.displayName || 'User';
                    
                    // Update main app state properties
                    appState.pendingFriendRequests = userProfile.friendRequests || [];
                    appState.friendsList = userProfile.friends || [];
                    
                    // Fetch profile info for all friends/requesters
                    fetchProfilesByIds([...appState.pendingFriendRequests, ...appState.friendsList]);

                    renderApp();
                } else {
                    console.error("Profile not found for UID:", uid);
                    // Should theoretically not happen
                    router.setView('profile_setup');
                }
            }, (error) => {
                console.error("Error listening to user profile:", error);
                router.setError("Error loading profile data.");
            });
        }
        
        /**
         * Fetches profiles for a list of UIDs and updates allProfiles map in state.
         * @param {string[]} uids - Array of UIDs (friend UIDs and pending request UIDs).
         */
        async function fetchProfilesByIds(uids) {
            if (uids.length === 0) return;
            
            const uniqueUids = [...new Set(uids)];
            const appId = explicitFirebaseConfig.projectId;
            const profilesRef = collection(db, `artifacts/${appId}/public/data/profiles`);
            
            // Set up listeners for each unique profile
            uniqueUids.forEach(uidToListen => {
                const docRef = doc(profilesRef, uidToListen);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const profileData = docSnap.data();
                        appState.allProfiles = {
                            ...appState.allProfiles,
                            [uidToListen]: {
                                uid: uidToListen,
                                userId: profileData.userId,
                                displayName: profileData.displayName,
                                status: profileData.status || 'Offline' // Default status
                            }
                        };
                        renderApp();
                    } else {
                        // Profile was deleted or is invalid
                        appState.allProfiles = {
                            ...appState.allProfiles,
                            [uidToListen]: {
                                uid: uidToListen,
                                userId: 'Deleted User',
                                displayName: 'Deleted User',
                                status: 'Offline'
                            }
                        };
                        renderApp();
                    }
                });
            });
        }

        /**
         * Sends a friend request to a user by their @UserId.
         * @param {string} targetUserId - The @UserId of the recipient.
         */
        async function sendFriendRequest(targetUserId) {
            if (!userId) return showCustomAlert("You must be logged in to send friend requests.", "Error");
            if (targetUserId === userDisplayName) {
                return showCustomAlert("You can't send a friend request to yourself!", "Error");
            }
            if (appState.friendsList.includes(targetUserId)) {
                return showCustomAlert(`You are already friends with @${targetUserId}.`, "Error");
            }

            appState.isSubmitting = true;
            renderApp();

            try {
                const appId = explicitFirebaseConfig.projectId;
                const profilesRef = collection(db, `artifacts/${appId}/public/data/profiles`);
                
                // 1. Find the target UID by their unique @UserId
                const q = query(profilesRef, where("userId", "==", targetUserId.toLowerCase()));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showCustomAlert(`User @${targetUserId} not found.`, "Error");
                    return;
                }

                const targetUid = querySnapshot.docs[0].id;

                // 2. Check if a request is already pending (sent by me)
                // Since this uses arrayUnion, Firestore handles duplicate prevention, but checking the target's profile first is cleaner.
                const targetProfile = querySnapshot.docs[0].data();
                if (targetProfile.friendRequests && targetProfile.friendRequests.includes(userId)) {
                    showCustomAlert(`A friend request has already been sent to @${targetUserId}.`, "Info");
                    return;
                }
                
                // 3. Check if I already have a pending request from them (if so, this is a reciprocal acceptance scenario)
                if (appState.pendingFriendRequests.includes(targetUid)) {
                    // This means they sent a request to me, and I'm sending one to them.
                    // This scenario should be handled by the 'Accept Request' button, but we'll show a helpful message.
                    showCustomAlert(`@${targetUserId} has already sent you a request! Please accept it in the Pending Requests section.`, "Info");
                    return;
                }


                // 4. Send the request (add current user's UID to target's friendRequests array)
                const targetDocRef = doc(db, `artifacts/${appId}/public/data/profiles/${targetUid}`);
                await updateDoc(targetDocRef, {
                    friendRequests: arrayUnion(userId)
                });

                showCustomAlert(`Friend request sent to @${targetUserId}!`, "Success");

            } catch (error) {
                console.error("Error sending friend request:", error);
                showCustomAlert("Failed to send request due to a server error.", "Error");
            } finally {
                appState.isSubmitting = false;
                renderApp();
            }
        }
        
        /**
         * Accepts a friend request from a pending user.
         * @param {string} requesterUid - The UID of the user who sent the request.
         */
        async function acceptFriendRequest(requesterUid) {
            if (!userId) return;

            appState.isSubmitting = true;
            renderApp();

            try {
                const appId = explicitFirebaseConfig.projectId;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);
                const requesterDocRef = doc(db, `artifacts/${appId}/public/data/profiles/${requesterUid}`);

                // 1. Update current user's profile: remove request, add friend
                await updateDoc(userDocRef, {
                    friendRequests: arrayRemove(requesterUid),
                    friends: arrayUnion(requesterUid)
                });

                // 2. Update requester's profile: add current user as friend
                await updateDoc(requesterDocRef, {
                    friends: arrayUnion(userId)
                });
                
                const requesterUserId = appState.allProfiles[requesterUid]?.userId || 'User';

                showCustomAlert(`You are now friends with @${requesterUserId}!`, "Success");

            } catch (error) {
                console.error("Error accepting friend request:", error);
                showCustomAlert("Failed to accept request due to a server error.", "Error");
            } finally {
                appState.isSubmitting = false;
                renderApp();
            }
        }

        /**
         * Declines or removes a user from a list (request/friend).
         * @param {string} targetUid - The UID to remove.
         * @param {('request'|'friend')} type - Whether to remove a pending request or a friend.
         */
        async function removeUser(targetUid, type) {
            if (!userId) return;

            appState.isSubmitting = true;
            renderApp();

            try {
                const appId = explicitFirebaseConfig.projectId;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);
                const targetDocRef = doc(db, `artifacts/${appId}/public/data/profiles/${targetUid}`);
                const targetUserId = appState.allProfiles[targetUid]?.userId || 'User';

                if (type === 'request') {
                    // Remove the request from my own pending requests list
                    await updateDoc(userDocRef, {
                        friendRequests: arrayRemove(targetUid)
                    });
                    showCustomAlert(`Declined request from @${targetUserId}.`, "Info");
                } else if (type === 'friend') {
                    // 1. Remove friend from my list
                    await updateDoc(userDocRef, {
                        friends: arrayRemove(targetUid)
                    });
                    // 2. Remove me from their list
                    await updateDoc(targetDocRef, {
                        friends: arrayRemove(userId)
                    });
                    showCustomAlert(`You have unfriended @${targetUserId}.`, "Info");
                }

            } catch (error) {
                console.error(`Error removing ${type}:`, error);
                showCustomAlert(`Failed to process action due to a server error.`, "Error");
            } finally {
                appState.isSubmitting = false;
                renderApp();
            }
        }
        
        // --- Authentication Functions ---

        async function checkUserProfile(user) {
            const appId = explicitFirebaseConfig.projectId;
            const docRef = doc(db, `artifacts/${appId}/public/data/profiles/${user.uid}`);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    // Set status to Online and update timestamp when logging in
                    await setDoc(docRef, { 
                        status: 'Online', 
                        lastActive: Timestamp.now() 
                    }, { merge: true });
                    
                    userDisplayName = userProfile.userId || userProfile.displayName || 'User';
                    setupUserProfileListener(user.uid);
                    router.setView('dashboard');
                    showCustomAlert(`Welcome back, @${userDisplayName}!`, "WELCOME!");
                } else {
                    router.setView('profile_setup');
                }
            } catch (error) {
                console.error("Error checking user profile:", error);
                router.setError("Error accessing user data.");
            }
        }
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // Auth state change listener handles view routing
            } catch (error) {
                console.error("Google Sign-In Failed:", error);
                router.setError("Failed to sign in with Google. Check console for details.");
            }
        }
        
        async function handleSignOut() {
            try {
                if (userProfile && userId) {
                    const appId = explicitFirebaseConfig.projectId;
                    const docRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);
                    // Set status to Offline when logging out
                    await updateDoc(docRef, { status: 'Offline', lastActive: Timestamp.now() });
                }
                
                await signOut(auth);
                // Auth state change listener handles view routing
                showCustomAlert("You have been signed out.", "Goodbye!");
            } catch (error) {
                console.error("Sign-Out Failed:", error);
                router.setError("Failed to sign out. Please check your connection.");
            }
        }

        function listenForUserIdUniqueness(userId) {
            if (profileUniquenessListener) {
                profileUniquenessListener(); // Stop the old listener
            }

            if (!userId) {
                appState.isUserIdUnique = false;
                appState.isIdConflict = false;
                renderApp();
                return;
            }

            appState.pendingUserId = userId;
            const appId = explicitFirebaseConfig.projectId;
            const profilesRef = collection(db, `artifacts/${appId}/public/data/profiles`);
            
            // Query for any existing profile with the given userId
            const q = query(profilesRef, where("userId", "==", userId.toLowerCase()));
            
            profileUniquenessListener = onSnapshot(q, (snapshot) => {
                const isConflict = snapshot.docs.length > 0;
                
                // If there's a conflict, make sure it's not the current user's own profile being checked
                if (isConflict) {
                    const conflictingDocId = snapshot.docs[0].id;
                    if (conflictingDocId === appState.user.uid) {
                        // It's the current user's existing profile (shouldn't happen here, but safe guard)
                        appState.isIdConflict = false;
                        appState.isUserIdUnique = true;
                    } else {
                        // It's another user's profile
                        appState.isIdConflict = true;
                        appState.isUserIdUnique = false;
                    }
                } else {
                    // No conflict found
                    appState.isIdConflict = false;
                    appState.isUserIdUnique = true;
                }
                renderApp();
            }, (error) => {
                console.error("Error checking userId uniqueness:", error);
                // Assume unique in case of a temporary error to allow registration, but log it.
                appState.isUserIdUnique = true;
                appState.isIdConflict = false;
                renderApp();
            });
        }
        
        async function handleProfileSetup(event) {
            event.preventDefault();
            
            if (!appState.isUserIdUnique || appState.isIdConflict || !appState.pendingUserId) {
                showCustomAlert("Please choose a unique and valid @User ID.", "Error");
                return;
            }

            if (!appState.user) {
                router.setError("Authentication session lost. Please sign in again.");
                return;
            }
            
            appState.isSubmitting = true;
            renderApp();

            try {
                const appId = explicitFirebaseConfig.projectId;
                const docRef = doc(db, `artifacts/${appId}/public/data/profiles/${appState.user.uid}`);
                
                const newProfile = {
                    uid: appState.user.uid,
                    displayName: appState.user.displayName || 'Anon',
                    userId: appState.pendingUserId.toLowerCase(), // Store lowercase for querying
                    email: appState.user.email || 'N/A',
                    createdAt: Timestamp.now(),
                    status: 'Online',
                    lastActive: Timestamp.now(),
                    // Initialize empty arrays for friend features
                    friends: [],
                    friendRequests: [],
                };
                
                await setDoc(docRef, newProfile);
                
                // Success: clear state, setup listener, move to dashboard
                userProfile = newProfile;
                userDisplayName = newProfile.userId;
                appState.isSubmitting = false;
                appState.pendingUserId = '';
                
                if (profileUniquenessListener) {
                    profileUniquenessListener();
                    profileUniquenessListener = null;
                }

                setupUserProfileListener(appState.user.uid);
                router.setView('dashboard');
                showCustomAlert(`Welcome, @${userDisplayName}! Your profile is ready.`, "WELCOME!");

            } catch (error) {
                console.error("Error creating profile:", error);
                router.setError("Failed to complete registration. Please try again.");
            } finally {
                appState.isSubmitting = false;
                renderApp();
            }
        }
        
        // --- View Rendering ---

        function renderAuthView() {
            return `
                <div class="auth-container">
                    <h1 class="app-title">SQUIT UP!</h1>
                    <p class="subtitle">chatting and chilling lounge friends</p>
                    <h2 class="text-2xl font-semibold mb-6 text-center text-white">CONNECT ACCOUNT</h2>

                    ${appState.errorMessage ? `<div class="error-message">${appState.errorMessage}</div>` : ''}

                    <button class="btn-google w-full" onclick="window.handleGoogleSignIn()">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google Logo"/>
                        Continue with Google
                    </button>

                    <div class="mt-8 text-center text-gray-400 text-sm">
                        <p>Sign in to connect with friends and communities.</p>
                    </div>
                </div>
            `;
        }
        
        function renderProfileSetupView() {
            const inputId = 'profile-user-id';
            const statusColor = appState.isIdConflict ? 'text-red-500' : (appState.isUserIdUnique ? 'text-green-500' : 'text-gray-500');
            const statusMessage = appState.isIdConflict 
                ? 'This @User ID is taken.' 
                : (appState.isUserIdUnique && appState.pendingUserId.length > 0
                    ? 'Available!' 
                    : 'Choose a unique ID (e.g., @squit_dev)');
            const isButtonDisabled = !appState.isUserIdUnique || appState.isIdConflict || appState.pendingUserId.length < 3 || appState.isSubmitting;
            
            return `
                <div class="auth-container">
                    <h1 class="app-title">SQUIT UP!</h1>
                    <p class="subtitle">Final Step: Choose Your @User ID</p>
                    
                    ${appState.errorMessage ? `<div class="error-message">${appState.errorMessage}</div>` : ''}

                    <form onsubmit="window.handleProfileSetup(event)">
                        <label for="${inputId}" class="block text-sm font-medium mb-2 text-white">Your Profile Name</label>
                        
                        <div class="relative mb-2">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                            <input 
                                type="text" 
                                id="${inputId}" 
                                class="input-field w-full px-4 py-3 pl-8 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="unique_user_id"
                                value="${appState.pendingUserId}"
                                oninput="window.handleUserIdInput(this.value)"
                                required
                            >
                        </div>
                        <p class="text-xs font-medium ${statusColor} mb-6">${statusMessage}</p>

                        <button 
                            type="submit" 
                            class="btn-register w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-150"
                            ${isButtonDisabled ? 'disabled' : ''}
                        >
                            ${appState.isSubmitting ? 'Registering...' : 'Complete Registration'}
                        </button>
                    </form>

                    <p class="text-center text-gray-400 text-xs mt-4">
                        Your @User ID is how friends will find you.
                    </p>
                </div>
            `;
        }
        
        function handleUserIdInput(value) {
            // Basic sanitization
            const cleanValue = value.replace(/[^a-zA-Z0-9._]/g, '').toLowerCase();
            appState.pendingUserId = cleanValue;
            document.getElementById('profile-user-id').value = cleanValue;
            listenForUserIdUniqueness(cleanValue);
            renderApp(); // Re-render to update the button and status immediately
        }
        
        function renderLoadingView() {
            return `
                <div class="text-center">
                    <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent border-solid rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-indigo-300 font-semibold">${appState.loadingMessage}</p>
                </div>
            `;
        }

        function renderDashboardView() {
            const pendingRequests = appState.pendingFriendRequests
                .map(uid => appState.allProfiles[uid])
                .filter(profile => profile); // Filter out profiles that might not have loaded yet
            
            const friends = appState.friendsList
                .map(uid => appState.allProfiles[uid])
                .filter(profile => profile);

            return `
                <div class="dashboard-layout">
                    <!-- Sidebar -->
                    <div class="sidebar flex flex-col justify-between">
                        <div>
                            <!-- App Title and Logo -->
                            <div class="text-3xl font-bold text-white mb-6">
                                SQUIT UP!
                            </div>

                            <div class="mb-4">
                                <h3 class="text-xs font-semibold uppercase text-gray-400 mb-2">Direct Messages</h3>
                                <p class="text-sm text-gray-500 italic">Add friends to start chatting.</p>
                            </div>

                            <!-- Friend Requests Section -->
                            <h3 class="sidebar-section-header">Pending Requests (${pendingRequests.length})</h3>
                            <div id="pending-requests-list">
                                ${pendingRequests.length > 0 
                                    ? pendingRequests.map(profile => `
                                        <div class="request-item sidebar-item flex justify-between items-center bg-purple-900/50 hover:bg-purple-800/50">
                                            <span class="truncate pr-2">@${profile.userId}</span>
                                            <div class="flex space-x-2">
                                                <button onclick="window.acceptFriendRequest('${profile.uid}')" class="text-green-400 hover:text-green-300 font-bold">✓</button>
                                                <button onclick="window.removeUser('${profile.uid}', 'request')" class="text-red-400 hover:text-red-300 font-bold">✕</button>
                                            </div>
                                        </div>
                                    `).join('')
                                    : '<p class="text-sm text-gray-500 italic px-2">No pending requests.</p>'
                                }
                            </div>
                            
                            <!-- Friends List Section -->
                            <h3 class="sidebar-section-header">My Friends (${friends.length})</h3>
                            <div id="friends-list">
                                ${friends.length > 0
                                    ? friends.map(profile => `
                                        <button class="sidebar-item friend-link">
                                            <span class="status-indicator ${profile.status === 'Online' ? 'status-online' : 'status-offline'}"></span>
                                            <span class="truncate">@${profile.userId}</span>
                                        </button>
                                    `).join('')
                                    : '<p class="text-sm text-gray-500 italic px-2">No friends yet.</p>'
                                }
                            </div>
                            
                            <!-- Add Friend Button -->
                            <div class="mt-6">
                                <button onclick="window.showAddFriendModal()" class="sidebar-item add-friend-btn">
                                    Send Friend Request
                                </button>
                            </div>
                        </div>

                        <!-- User Profile/Sign Out Section -->
                        <div class="border-t border-gray-700 pt-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-sm font-bold mr-3">
                                        ${userDisplayName.charAt(1).toUpperCase()}
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold truncate">@${userDisplayName}</p>
                                        <p class="text-xs text-green-400">Online</p>
                                    </div>
                                </div>
                                <button onclick="window.handleSignOut()" class="text-gray-400 hover:text-red-500 transition duration-150" title="Sign Out">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chat/Content Area -->
                    <div class="main-content">
                        <div class="chat-header text-center p-4 border-b border-gray-700">
                            <h2 class="text-lg font-semibold text-indigo-400">@System - Welcome to SQUIT UP!</h2>
                            <p class="text-sm text-gray-400">Chat and friend features are active!</p>
                        </div>

                        <div class="chat-area flex-grow">
                            <!-- Chat messages will go here -->
                            <div class="flex flex-col h-full justify-end">
                                <p class="text-center text-gray-600 italic">Start a conversation by clicking on a friend in the sidebar.</p>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="message-input-area">
                            <input type="text" placeholder="Send a message..." class="input-field flex-grow px-4 py-3 rounded-l-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 border-r-0">
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-r-lg transition duration-150">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
                ${renderAddFriendModal()}
            `;
        }
        
        function renderAddFriendModal() {
            const modalId = 'add-friend-modal';
            const inputId = 'add-friend-user-id';
            
            return `
                <div id="${modalId}" class="modal-overlay hidden">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white">Send Friend Request</h3>
                            <button onclick="document.getElementById('${modalId}').classList.add('hidden')" class="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <form onsubmit="event.preventDefault(); window.submitAddFriendRequest()">
                            <label for="${inputId}" class="block text-sm font-medium mb-2 text-gray-300">@User ID of the friend:</label>
                            <div class="relative mb-4">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                                <input 
                                    type="text" 
                                    id="${inputId}" 
                                    class="input-field w-full px-4 py-3 pl-8 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="friend_user_id"
                                    required
                                >
                            </div>
                            <button 
                                type="submit" 
                                class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-150"
                                ${appState.isSubmitting ? 'disabled' : ''}
                            >
                                ${appState.isSubmitting ? 'Sending...' : 'Send Request'}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        function showAddFriendModal() {
            document.getElementById('add-friend-modal').classList.remove('hidden');
            document.getElementById('add-friend-user-id').value = '';
        }
        
        async function submitAddFriendRequest() {
            const inputElement = document.getElementById('add-friend-user-id');
            const targetUserId = inputElement.value.trim().toLowerCase();
            
            if (targetUserId) {
                document.getElementById('add-friend-modal').classList.add('hidden');
                await sendFriendRequest(targetUserId);
                inputElement.value = ''; // Clear input after submission attempt
            }
        }


        function renderApp() {
            const container = document.getElementById('app-container');
            let content = '';

            switch (router.getView()) {
                case 'auth':
                    content = renderAuthView();
                    break;
                case 'profile_setup':
                    content = renderProfileSetupView();
                    break;
                case 'dashboard':
                    content = renderDashboardView();
                    break;
                case 'loading':
                default:
                    content = renderLoadingView();
                    break;
            }

            container.innerHTML = content;
        }

        // Expose global functions needed by the HTML
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleSignOut = handleSignOut;
        window.handleProfileSetup = handleProfileSetup;
        window.handleUserIdInput = handleUserIdInput;
        window.showAddFriendModal = showAddFriendModal;
        window.submitAddFriendRequest = submitAddFriendRequest;
        window.sendFriendRequest = sendFriendRequest; // Exposed for internal use, though submitAddFriendRequest is for the modal
        window.acceptFriendRequest = acceptFriendRequest;
        window.removeUser = removeUser;
        window.showCustomAlert = showCustomAlert;

        // Initialize on load
        window.onload = initializeFirebase;
    </script>
</head>
<body class="bg-gray-900">
    <!-- The main application container -->
    <div id="app-container" class="w-full h-full">
        <!-- Content will be rendered here by JavaScript -->
    </div>
</body>
</html>
