<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURY - Realtime Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        /* Custom scrollbar for chat box */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #1f2937; /* gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 h-screen">

    <!-- Main application container -->
    <div id="app-container" class="h-full">
        <!-- Content will be injected here -->
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        let app, db, auth;
        let userId = null;
        let currentUserProfile = null; // Store fetched user profile data

        // --- GLOBAL VARIABLES (Provided by environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- UTILITY FUNCTIONS ---

        /**
         * Renders the loading spinner into the app container.
         */
        function renderLoading(message = "Connecting...") {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center text-white bg-gray-900">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-t-4 border-indigo-500 border-opacity-25 rounded-full animate-spin"></div>
                        <p class="mt-4 text-lg text-gray-400">${message}</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Sign-In screen.
         */
        function renderSignIn() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center bg-gray-900">
                    <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <div class="flex justify-center mb-6">
                            <div class="p-3 bg-red-500 rounded-full">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.111A9.502 9.502 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                        </div>
                        <h1 class="text-3xl font-extrabold text-red-500 mb-2">FURY</h1>
                        <p class="text-gray-400 mb-8">Connect with friends instantly.</p>
                        <h2 class="text-2xl font-semibold text-white mb-4">Welcome to FURY</h2>
                        <p class="text-gray-500 mb-6">Please sign in with Google to continue.</p>
                        <button id="google-signin-btn" class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-red-600/30">
                            <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.61 20.08v3.42H24V20.08h19.61z"/><path fill="#FF3D00" d="M6.3 33.15c.61 1.77 1.63 3.32 2.87 4.6l5.77-4.47c-.77-.48-1.44-1.07-1.95-1.78H6.3z"/><path fill="#4CAF50" d="M43.61 24.5v3.42H24v-3.42h19.61z"/><path fill="#1976D2" d="M12.94 37.75c3.08 3.52 7.7 5.75 12.87 5.75s9.79-2.23 12.87-5.75l-5.77-4.47c-2.34 2.1-5.32 3.42-9.1 3.42s-6.76-1.32-9.1-3.42L12.94 37.75z"/><path fill="#F44336" d="M24 8c-4.99 0-9.62 2.11-12.87 5.75l5.77 4.47c2.34-2.1 5.32-3.42 9.1-3.42s6.76 1.32 9.1 3.42l5.77-4.47C33.62 10.11 28.99 8 24 8z"/></svg>
                            Sign in with Google
                        </button>
                        <p class="text-xs text-gray-600 mt-4">By signing in, you agree to our <a href="#" class="text-red-500 hover:underline">Terms of Service</a>.</p>
                    </div>
                </div>
            `;
            document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
        }

        /**
         * Google Sign-In handler.
         */
        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                alert('Sign-in failed. Check the console for details.');
            }
        }

        /**
         * Signs out the current user.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                // Sign in anonymously immediately after sign out for continued Canvas access
                await signInAnonymously(auth); 
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        }

        // --- CRITICAL FIX FUNCTION ---

        /**
         * Checks if the user's profile document exists and creates it if missing.
         * @param {string} uid The current user ID.
         */
        async function ensureUserProfileExists(uid) {
            const userDocRef = doc(db, 'artifacts', appId, 'users', uid, 'user_profile', 'data');
            try {
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    // Document does not exist, CREATE IT. This is the fix for the infinite loading.
                    await setDoc(userDocRef, {
                        userId: uid,
                        displayName: `user_${uid.substring(0, 8)}`,
                        onlineStatus: 'online',
                        createdAt: serverTimestamp(),
                    });
                    console.log(`User profile created for: ${uid}`);
                }
            } catch (error) {
                console.error("Error ensuring user profile document:", error.message);
                // Log the error but continue. The onSnapshot listener below will pick up the new doc.
            }
        }

        // --- MAIN APP RENDER & LOGIC ---

        /**
         * Listens to the global chat for messages and updates the UI.
         */
        function startChatListeners() {
            if (!userId) return;

            // 1. Listen for Global Chat messages
            const globalChatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', 'global_fury_chat');
            const messagesRef = collection(globalChatRef, 'messages');
            
            // Note: We avoid orderBy here to prevent required index issues, and sort in memory.
            const q = query(messagesRef);

            onSnapshot(q, (snapshot) => {
                const msgs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date()
                }));

                // Sort in memory
                msgs.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
                renderMessages(msgs);
            }, (error) => {
                console.error("Error listening to global chat messages:", error.message);
            });
        }
        
        /**
         * Renders all messages into the chat body.
         * @param {Array<Object>} messages - Array of message objects.
         */
        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-10 flex-grow flex items-center justify-center">
                        Say hello! Be the first to send a message to **#global-fury-chat**.
                    </div>
                `;
                return;
            }

            // Iterate in reverse to append to the top (which is reversed in CSS for scroll-to-bottom)
            messages.slice().reverse().forEach(message => {
                const isCurrentUser = message.senderId === userId;
                const senderDisplay = currentUserProfile && isCurrentUser 
                    ? 'You' 
                    : message.senderId.substring(0, 8); 

                const bubbleClass = isCurrentUser
                    ? 'bg-indigo-500 text-white self-end rounded-bl-xl rounded-t-xl'
                    : 'bg-gray-700 text-gray-200 self-start rounded-br-xl rounded-t-xl';
                
                const timestampDisplay = message.timestamp instanceof Date 
                    ? message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                    : '...';

                const messageHTML = `
                    <div class="flex flex-col mb-4 max-w-xs md:max-w-md ${isCurrentUser ? 'items-end' : 'items-start'}">
                        <div class="text-xs text-gray-400 mb-1 px-3">
                            ${senderDisplay}
                        </div>
                        <div class="p-3 shadow-md ${bubbleClass}">
                            ${message.text}
                            <span class="ml-4 text-xs opacity-70 block text-right mt-1">${timestampDisplay}</span>
                        </div>
                    </div>
                `;
                container.innerHTML += messageHTML;
            });
            // Auto-scroll to the bottom (since we used flex-col-reverse)
            container.scrollTop = container.scrollHeight;
        }

        /**
         * Sends a message to the global chat room.
         */
        async function sendMessage(text) {
            if (!userId || !text.trim()) return;

            try {
                const globalChatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', 'global_fury_chat');
                const messagesCollectionRef = collection(globalChatRef, 'messages');
                
                await addDoc(messagesCollectionRef, {
                    senderId: userId,
                    text: text.trim(),
                    timestamp: serverTimestamp(),
                    type: 'text',
                });
                document.getElementById('message-input').value = '';
            } catch (error) {
                console.error("Error sending message:", error.message);
            }
        }


        /**
         * Renders the main chat UI after successful login and profile load.
         */
        function renderChatUI() {
            const userDisplayId = currentUserProfile?.displayName || `user_${userId.substring(0, 8)}`;
            const onlineStatus = currentUserProfile?.onlineStatus || 'offline';
            const statusColor = onlineStatus === 'online' ? 'bg-green-500' : 'bg-gray-500';

            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="flex h-full text-white bg-gray-900 antialiased">
                    
                    <!-- Sidebar (Left) -->
                    <div class="w-64 bg-gray-800 flex flex-col border-r border-gray-700">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h1 class="text-xl font-extrabold text-white text-red-500">FURY</h1>
                            <button id="signout-btn" class="text-gray-400 hover:text-white transition duration-150">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                        
                        <!-- Channels List -->
                        <nav class="flex-grow p-4 space-y-4 overflow-y-auto">
                            <div>
                                <h2 class="text-xs font-semibold uppercase text-gray-400 mb-2">Global Channels</h2>
                                <ul class="space-y-1">
                                    <li>
                                        <button class="w-full text-left p-2 rounded-lg transition duration-150 bg-indigo-600 text-white">
                                            #global-fury-chat
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </nav>

                        <!-- User Info Bar -->
                        <div class="p-4 bg-gray-700 border-t border-gray-700 flex items-center">
                            <div class="w-3 h-3 rounded-full mr-3 ${statusColor} border-2 border-gray-700"></div>
                            <div class="flex flex-col">
                                <span class="text-sm font-semibold">${userDisplayId}</span>
                                <span class="text-xs text-gray-400 capitalize">${onlineStatus}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area (Right) -->
                    <div class="flex-grow flex flex-col">
                        <!-- Header -->
                        <header class="p-4 border-b border-gray-700 bg-gray-800 flex items-center">
                            <h2 class="text-xl font-bold"># global-fury-chat</h2>
                        </header>

                        <!-- Messages Body -->
                        <div id="messages-container" class="flex-grow p-4 overflow-y-auto space-y-3 flex flex-col-reverse">
                            <!-- Messages will be rendered here by renderMessages -->
                        </div>

                        <!-- Input Area -->
                        <form id="chat-form" class="p-4 border-t border-gray-700 bg-gray-800">
                            <div class="flex items-center space-x-3">
                                <input
                                    type="text"
                                    id="message-input"
                                    placeholder="Message #global-fury-chat"
                                    class="flex-grow bg-gray-700 text-white p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none transition duration-150"
                                >
                                <button
                                    type="submit"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition duration-150 shadow-lg disabled:opacity-50"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup Event Listeners
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                sendMessage(input.value);
            });
            
            // Start listening for messages now that the container exists
            startChatListeners();
        }

        /**
         * Initializes Firebase and sets up the main authentication listener.
         */
        function initializeAppAndAuth() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config missing. Cannot initialize app.");
                return renderLoading("Error: Firebase configuration missing.");
            }

            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable detailed Firebase logging
            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                return renderLoading("Error initializing Firebase.");
            }

            // Initial rendering state
            renderLoading("Authenticating...");

            // Set up Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // --- STEP 1: CRITICAL FIX INTEGRATION ---
                    // Ensure profile exists before trying to load the UI
                    await ensureUserProfileExists(userId); 

                    // --- STEP 2: Start listening for user profile data (needed for the UI) ---
                    const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_profile', 'data');
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentUserProfile = docSnap.data();
                            // --- STEP 3: Render the app only after profile is loaded ---
                            renderChatUI();
                        } else {
                            // Even if it fails, it means the profile hasn't been created yet.
                            // The ensureUserProfileExists should have covered this.
                            console.error("User profile still missing after attempted creation.");
                            renderLoading("Loading FURY... (Profile Fetching)");
                        }
                    }, (error) => {
                        console.error("Error listening to user profile:", error.message);
                        renderLoading("Error loading profile. Check permissions.");
                    });

                } else {
                    userId = null;
                    currentUserProfile = null;
                    // If no user is logged in, show the sign-in screen
                    renderSignIn();
                }
            });

            // Initial sign-in attempt if a custom token is provided by the environment
            async function initialSignIn() {
                 if (initialAuthToken) {
                     try {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } catch (e) {
                         console.error("Custom token sign-in failed, falling back to anonymous:", e);
                         await signInAnonymously(auth);
                     }
                 } else {
                     await signInAnonymously(auth);
                 }
            }

            initialSignIn();
        }

        // Start the whole application on window load
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
