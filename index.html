<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURY - Real-Time Global Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use the 'Inter' font and enable custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827',
                        'secondary-dark': '#1F2937',
                        'accent-red': '#EF4444',
                        'accent-orange': '#F97316',
                        'fury-start': '#FF4500', // Deep Orange-Red
                        'fury-end': '#7FFF00',   // Chartreuse Green
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the gradient text effect */
        .fury-gradient-text {
            background-image: linear-gradient(90deg, var(--tw-color-fury-start) 0%, var(--tw-color-fury-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            filter: drop-shadow(0 4px 6px rgba(255, 69, 0, 0.4));
        }

        /* Basic container styling for the background */
        body {
            background-color: #0d0d0d;
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for message list */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4B5563; /* Gray-600 */
            border-radius: 4px;
        }

        #messages-container::-webkit-scrollbar-track {
            background-color: #1F2937; /* Secondary-dark */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-4xl h-[90vh] bg-secondary-dark shadow-2xl rounded-2xl flex flex-col transition-opacity duration-300">

        <!-- 2. Chat Screen (Authenticated State) - Now visible by default -->
        <div id="chat-screen" class="flex-1 flex flex-col h-full">
            <!-- Header -->
            <header class="p-4 border-b border-gray-700 flex justify-between items-center rounded-t-2xl bg-gray-800">
                <h1 class="text-3xl font-extrabold fury-gradient-text">FURY Chat</h1>
                <div class="flex items-center space-x-3">
                    <span id="user-display" class="text-sm font-semibold text-gray-300 bg-gray-700 py-1 px-3 rounded-full truncate max-w-[150px] sm:max-w-full">Authenticating...</span>
                    <button id="sign-out-button" class="px-4 py-2 bg-accent-red text-white text-sm font-medium rounded-xl hover:bg-red-600 transition duration-150 shadow-lg">Sign Out</button>
                </div>
            </header>

            <!-- Messages Container -->
            <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4 bg-primary-dark">
                <!-- Messages will be injected here -->
            </div>

            <!-- Message Input Form -->
            <form id="message-form" class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex space-x-3">
                <input type="text" id="message-input" placeholder="Type a message..." required
                       class="flex-1 p-3 bg-gray-700 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-accent-orange placeholder-gray-400 border border-transparent focus:border-accent-orange transition duration-150"
                       autocomplete="off">
                <button type="submit"
                        class="px-6 py-3 bg-fury-start text-white font-bold rounded-xl shadow-lg hover:bg-fury-end hover:shadow-xl transition-all duration-300">
                    Send
                </button>
            </form>
        </div>

        <!-- 3. Custom Modal for Errors/Messages -->
        <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 z-30 hidden items-center justify-center">
            <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700 transform scale-90 transition-transform duration-300">
                <h3 id="modal-title" class="text-xl font-bold text-white mb-3">Alert</h3>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition duration-150 hidden">Cancel</button>
                    <button id="modal-ok" class="px-4 py-2 bg-accent-red text-white font-medium rounded-xl hover:bg-red-600 transition duration-150">OK</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let authReady = false; // Flag to track successful authentication

        // --- Custom Modal Functions ---
        const customAlert = (title, message) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-cancel').classList.add('hidden');
            document.getElementById('modal-ok').onclick = () => {
                modal.classList.add('hidden');
            };
            modal.classList.remove('hidden');
        };

        // --- Firebase Initialization ---
        
        // Fallback configuration based on your project details
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCkp-U_L1NBy7dopqu3MA10Z1L3aTqsOPI",
            authDomain: "squit-up-auth.firebaseapp.com",
            projectId: "squit-up-auth",
            storageBucket: "squit-up-auth.appspot.com",
            messagingSenderId: "585918898443",
            appId: "1:585918898443:web:c5a39e824e4f1d3e8990e",
            measurementId: "G-K4LH9H5NJD"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-fury-app';
        let firebaseConfig = FALLBACK_FIREBASE_CONFIG; 
        
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Error parsing __firebase_config JSON:", e);
            customAlert("Configuration Error", "Could not parse Firebase configuration.");
            return;
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Global variables for UI elements
        const chatScreen = document.getElementById('chat-screen');
        const userDisplay = document.getElementById('user-display');
        const signOutButton = document.getElementById('sign-out-button');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');

        let currentUserId = null;
        let currentUserName = 'Anonymous';

        // --- Core Functions ---
        
        // Function to render messages in the container
        const renderMessages = (messages) => {
            messagesContainer.innerHTML = ''; // Clear previous messages
            
            // Sort messages locally by timestamp (descending) before display
            messages.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));

            messages.forEach(msg => {
                const isMine = msg.userId === currentUserId;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isMine ? 'justify-end' : 'justify-start'}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = `max-w-xs sm:max-w-md p-3 rounded-xl shadow-md ${
                    isMine 
                    ? 'bg-accent-red text-white rounded-br-none' 
                    : 'bg-gray-700 text-gray-100 rounded-tl-none'
                }`;
                
                // Display the sender's name if it's not the current user
                if (!isMine) {
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = msg.userName || 'Anonymous';
                    nameSpan.className = 'block text-xs font-semibold mb-1 text-accent-orange';
                    contentDiv.appendChild(nameSpan);
                }

                const textP = document.createElement('p');
                textP.textContent = msg.text;
                textP.className = 'break-words';
                contentDiv.appendChild(textP);

                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);
            });

            // Scroll to the bottom of the message list
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };
        
        // Function to set up the real-time message listener
        const setupMessageListener = (dbInstance) => {
            if (!currentUserId) return;

            // Path for public/global messages
            const messagesRef = collection(dbInstance, `artifacts/${appId}/public/data/messages`);
            const q = query(messagesRef);

            // Set up real-time listener
            onSnapshot(q, (snapshot) => {
                try {
                    const messages = [];
                    snapshot.forEach((doc) => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    renderMessages(messages);
                } catch (e) {
                    console.error("Error processing snapshot:", e);
                    // Log processing errors silently
                }
            }, (error) => {
                console.error("Firestore listen error:", error);
                // Log connection errors silently
            });
        };
        
        // Function to handle sending a new message
        const handleMessageSubmit = async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (text.length > 0 && currentUserId) {
                try {
                    const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesRef, {
                        text: text,
                        userId: currentUserId,
                        userName: currentUserName,
                        createdAt: serverTimestamp()
                    });
                    messageInput.value = ''; // Clear input after sending
                } catch (error) {
                    console.error("Error sending message:", error);
                    customAlert("Send Failed", "Could not send message. Check network and permissions.");
                }
            }
        };

        // --- Event Listeners and Auth Flow ---
        
        // Function to handle UI display after successful authentication
        const showChatScreen = (user) => {
            if (authReady) return; // Prevent multiple calls

            currentUserId = user.uid;
            currentUserName = user.isAnonymous ? 'Anonymous' : `User-${user.uid.substring(0, 8)}`;
            userDisplay.textContent = currentUserName;

            authReady = true;

            // Set up the real-time chat listener
            setupMessageListener(db);
        };


        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                showChatScreen(user);
            } else {
                // User is signed out or not authenticated yet
                chatScreen.classList.add('hidden'); // Hide chat screen if auth fails or signs out
                if (authReady) { // Only show alert if user was previously signed in
                    customAlert("Signed Out", "You have been signed out. Please refresh to sign in again.");
                }
                currentUserId = null;
                authReady = false;
            }
        });
        
        // Initial sign-in attempt (using custom token or anonymously)
        (async () => {
            userDisplay.textContent = 'Signing in...';
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                let signedIn = false;
                
                // 1. Try to sign in using the custom token
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        signedIn = true;
                    } catch (e) {
                        console.warn("Custom token sign-in failed, falling back to anonymous:", e);
                    }
                }
                
                // 2. If not signed in yet (or custom token failed), sign in anonymously
                if (!signedIn) {
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                // Catch critical initialization or anonymous sign-in failure and display modal
                console.error("CRITICAL AUTH ERROR:", error);
                customAlert("Critical Error", `Cannot connect to chat. Error: ${error.code}. Please check your Firebase settings.`);
                chatScreen.classList.add('hidden'); // Ensure chat screen is hidden on critical failure
            }
        })();

        // Sign Out function
        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged handler will deal with UI updates after sign out
            } catch (error) {
                console.error("Sign out error:", error);
                customAlert("Sign Out Failed", "Could not sign out. Please try again.");
            }
        });
        
        // Message submission listener
        messageForm.addEventListener('submit', handleMessageSubmit);
        
    </script>
</body>
</html>
