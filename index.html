<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squit! up - Connect with Friends</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .message-enter {
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .online-dot {
            animation: onlinePulse 2s infinite;
        }
        
        @keyframes onlinePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white font-sans">
    
    <div id="loginScreen" class="h-full flex items-center justify-center">
        <div class="text-center fade-in">
            <div class="mb-8">
                <h1 class="text-6xl font-bold bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent mb-4">
                    Squit! up
                </h1>
                <p class="text-xl text-gray-300">Connect with friends around the world</p>
            </div>
            
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md mx-auto border border-white/20">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üí¨</span>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">Welcome to Squit! up</h2>
                    <p class="text-gray-300">Start chatting with friends instantly!</p>
                </div>
                
                <div class="space-y-4">
                    <div class="text-left">
                        <label for="emailInput" class="block text-sm font-medium text-gray-300 mb-2">Enter your Email</label>
                        <input 
                            type="email" 
                            id="emailInput" 
                            placeholder="you@gmail.com" 
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            oninput="validateEmailInput()"
                        >
                        <p id="emailStatus" class="text-xs mt-2"></p>
                    </div>

                    <button onclick="checkEmail()" id="emailCheckBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Continue
                    </button>
                    
                    </div>
                
                <div class="mt-4 pt-4 border-t border-white/20">
                    <p class="text-xs text-blue-400 text-center">
                        üí° For this demo, we **simulate** the email check and user storage.
                    </p>
                </div>
            </div>
            
            <div class="mt-8 text-sm text-gray-400">
                <p>By signing in, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>

    <div id="passwordSetupScreen" class="h-full flex items-center justify-center" style="display: none;">
        <div class="text-center fade-in">
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md mx-auto border border-white/20">
                <div class="mb-6">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl" id="setupScreenIcon">üîë</span>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2" id="setupScreenTitle">Sign In</h2>
                    <p class="text-gray-300" id="setupScreenSubtitle">Please enter your password for <span id="currentEmailDisplay" class="font-medium text-blue-300"></span></p>
                </div>
                
                <div class="space-y-4">
                    <div id="loginForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                            <input 
                                type="password" 
                                id="loginPasswordInput" 
                                placeholder="Enter your password" 
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                oninput="validateLoginPassword()"
                            >
                            <p id="loginPasswordStatus" class="text-xs mt-1"></p>
                        </div>
                        <button onclick="performLogin()" id="performLoginBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Sign In
                        </button>
                    </div>

                    <div id="signupForm" class="space-y-4" style="display: none;">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Create Squit! up ID (@user_id)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                                <input 
                                    type="text" 
                                    id="signupUserIdInput" 
                                    placeholder="your_unique_id" 
                                    class="w-full bg-white/10 border border-white/20 rounded-lg pl-8 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    maxlength="20"
                                    oninput="validateSignupFields()"
                                >
                            </div>
                            <p id="signupUserIdStatus" class="text-xs mt-1 text-gray-400">Letters, numbers, and underscores only.</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Create Password</label>
                            <input 
                                type="password" 
                                id="signupPasswordInput" 
                                placeholder="Enter a secure password" 
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                minlength="6"
                                oninput="validateSignupFields()"
                            >
                            <p id="signupPasswordStatus" class="text-xs mt-1"></p>
                        </div>

                        <button onclick="performSignup()" id="performSignupBtn" class="w-full bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Create Account
                        </button>
                    </div>
                    
                    <button onclick="backToLogin()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-lg transition-all">
                        ‚Üê Back to Email Check
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="chatApp" class="h-full flex" style="display: none;">
        <div class="w-16 bg-gray-900 flex flex-col items-center py-3 space-y-2">
            <div class="w-12 h-12 bg-gradient-to-r from-pink-500 to-purple-600 rounded-2xl hover:rounded-xl transition-all duration-200 flex items-center justify-center cursor-pointer" onclick="switchToHome()" id="homeButton">
                <span class="text-xl">üí¨</span>
            </div>
            
            <div class="w-8 h-0.5 bg-gray-600 rounded-full"></div>
            
            <div id="serverList" class="space-y-2">
                </div>
            
            <div class="w-12 h-12 bg-gray-700 hover:bg-green-600 rounded-2xl hover:rounded-xl transition-all duration-200 flex items-center justify-center cursor-pointer text-green-400 hover:text-white" onclick="showCreateServer()">
                <span class="text-2xl">+</span>
            </div>
        </div>

        <div class="w-64 bg-gray-800 flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-lg font-bold" id="sidebarTitle">Squit! up</h1>
                <p class="text-sm text-gray-400" id="sidebarSubtitle">Connect with friends</p>
            </div>
            
            <div id="serverChannels" class="flex-1 p-4" style="display: none;">
                <div class="space-y-1" id="channelsList">
                    </div>
                <button onclick="showCreateChannel()" class="mt-4 w-full text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 px-3 rounded flex items-center justify-center">
                    <span class="mr-1">+</span> Create Channel
                </button>
            </div>

            <div id="dmSection" class="flex-1 flex flex-col">
                <div class="p-4 border-b border-gray-700">
                    <div class="flex items-center space-x-3 cursor-pointer" onclick="showProfile()">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center font-bold relative" id="userAvatar">
                            U
                        </div>
                        <div class="flex-1">
                            <div class="font-medium" id="userName">User</div>
                            <div class="text-xs text-gray-400" id="userIdDisplay">@user_id</div>
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 bg-green-500 rounded-full online-dot"></div>
                                <span class="text-xs text-gray-400">Online</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="showAddFriend()" class="flex-1 text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded">
                            Add Friends
                        </button>
                        <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 px-2">Sign Out</button>
                    </div>
                </div>
                
                <div class="flex-1 p-4">
                    <h3 class="text-sm font-semibold text-gray-400 mb-3">FRIENDS</h3>
                    <div id="friendsList" class="space-y-2">
                        <div class="text-sm text-gray-500 text-center py-4">
                            No friends yet.<br>Add friends to start chatting!
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-700">
                    <h3 class="text-sm font-semibold text-gray-400 mb-3">FRIEND REQUESTS</h3>
                    <div id="friendRequests" class="space-y-2">
                        <div class="text-sm text-gray-500 text-center">No pending requests</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col">
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">üí¨</span>
                        <h2 class="text-lg font-semibold" id="chatTitle">Select a friend to start chatting</h2>
                    </div>
                    <div class="text-sm text-gray-400" id="chatStatus">Ready to connect</div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesContainer">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="text-6xl mb-4">üí¨</div>
                        <h3 class="text-xl font-semibold mb-2">Welcome to Squit! up</h3>
                        <p>Add friends and start chatting!</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-700 bg-gray-800" id="messageInputArea" style="display: none;">
                <form onsubmit="sendMessage(event)" class="flex space-x-3">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Type a message..." 
                        class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        maxlength="500"
                    >
                    <button 
                        type="submit" 
                        class="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-all"
                    >
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="addFriendModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Add Friend</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Friend's ID</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                        <input 
                            type="text" 
                            id="friendIdInput" 
                            placeholder="friend_id" 
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-8 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                    </div>
                    <p id="friendIdStatus" class="text-xs mt-1 text-gray-400"></p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="sendFriendRequest()" id="sendFriendRequestBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Send Request
                    </button>
                    <button onclick="closeAddFriend()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-800 rounded-2xl max-w-2xl w-full mx-4 border border-gray-700 overflow-hidden">
            <div class="h-32 bg-gradient-to-r from-purple-600 to-pink-600 relative" id="profileBanner">
                <button onclick="changeBanner()" class="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-lg text-sm">
                    üì∑ Change Banner
                </button>
            </div>
            
            <div class="p-6 -mt-16 relative">
                <div class="flex items-end space-x-4 mb-6">
                    <div class="relative">
                        <div class="w-24 h-24 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center font-bold text-2xl border-4 border-gray-800" id="profileAvatar">
                            U
                        </div>
                        <button onclick="changeAvatar()" class="absolute -bottom-1 -right-1 bg-gray-700 hover:bg-gray-600 text-white p-1 rounded-full text-xs">
                            üì∑
                        </button>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold" id="profileName">User</h2>
                        <p class="text-gray-400" id="profileId">@user_id</p>
                    </div>
                    <button onclick="editProfile()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        Edit Profile
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">ABOUT ME</h3>
                        <p class="text-gray-300" id="profileBio">No bio set yet. Click "Edit Profile" to add one!</p>
                    </div>
                    
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">MEMBER SINCE</h3>
                        <p class="text-gray-300" id="profileJoinDate">Today</p>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button onclick="closeProfile()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Edit Profile</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Display Name</label>
                    <input 
                        type="text" 
                        id="editDisplayName" 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        maxlength="32"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Bio</label>
                    <textarea 
                        id="editBio" 
                        rows="3"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                        maxlength="190"
                        placeholder="Tell us about yourself..."
                    ></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                    <select id="editStatus" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="online">üü¢ Online</option>
                        <option value="away">üü° Away</option>
                        <option value="busy">üî¥ Do Not Disturb</option>
                        <option value="invisible">‚ö´ Invisible</option>
                    </select>
                </div>
                <div class="flex space-x-3">
                    <button onclick="saveProfile()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Save Changes
                    </button>
                    <button onclick="closeEditProfile()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="createServerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Create Your Server</h3>
            <div class="space-y-4">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 cursor-pointer" onclick="changeServerIcon()" id="serverIconPreview">
                        <span class="text-2xl" id="serverIconText">üéÆ</span>
                    </div>
                    <button onclick="changeServerIcon()" class="text-sm text-blue-400 hover:text-blue-300">Change Icon</button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Server Name</label>
                    <input 
                        type="text" 
                        id="serverNameInput" 
                        placeholder="My Awesome Server" 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        maxlength="50"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description (Optional)</label>
                    <textarea 
                        id="serverDescInput" 
                        rows="2"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                        maxlength="120"
                        placeholder="What's your server about?"
                    ></textarea>
                </div>
                <div class="flex space-x-3">
                    <button onclick="createServer()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Create Server
                    </button>
                    <button onclick="closeCreateServer()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="createChannelModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Create Channel</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Channel Type</label>
                    <select id="channelTypeSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="text">üí¨ Text Channel</option>
                        <option value="voice">üîä Voice Channel</option>
                        <option value="announcement">üì¢ Announcement</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Channel Name</label>
                    <input 
                        type="text" 
                        id="channelNameInput" 
                        placeholder="general" 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        maxlength="30"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description (Optional)</label>
                    <input 
                        type="text" 
                        id="channelDescInput" 
                        placeholder="Channel description..." 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        maxlength="100"
                    >
                </div>
                <div class="flex space-x-3">
                    <button onclick="createChannel()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Create Channel
                    </button>
                    <button onclick="closeCreateChannel()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- Simulated User Data & State ---
        let currentUser = null;
        let tempEmail = '';
        let currentChatTarget = null; // User ID or Channel ID currently active
        let currentServer = 'home'; // 'home' for DMs, or Server ID for a server
        
        // This array simulates a database of existing users. 
        const users = [
            // Note: Use 'test@gmail.com' and password 'password123' to simulate an existing user login.
            { email: 'test@gmail.com', password: 'password123', id: 'testuser', displayName: 'Test User', joinDate: 'Jan 1, 2024', bio: 'I am the test user!', status: 'online' },
            { email: 'existing@gmail.com', password: 'securepass', id: 'existingid', displayName: 'Existing Friend', joinDate: 'Mar 15, 2024', bio: 'Ready to chat!', status: 'away' }
        ];

        // This object simulates a persistent store for friends, requests, and chat history
        const userState = {
            'testuser': {
                friends: ['existingid'],
                requestsSent: [],
                requestsReceived: [],
                chats: {
                    'existingid': [
                        { senderId: 'existingid', content: 'Hey, welcome to Squit! up!', timestamp: Date.now() - 60000 },
                        { senderId: 'testuser', content: 'Thanks! Just testing the chat.', timestamp: Date.now() }
                    ]
                }
            },
            'existingid': {
                friends: ['testuser'],
                requestsSent: [],
                requestsReceived: [],
                chats: {
                    'testuser': [
                        { senderId: 'existingid', content: 'Hey, welcome to Squit! up!', timestamp: Date.now() - 60000 },
                        { senderId: 'testuser', content: 'Thanks! Just testing the chat.', timestamp: Date.now() }
                    ]
                }
            }
        };

        const servers = [];
        const serverIconOptions = ['üéÆ', 'üíª', 'üí°', 'üåü', '‚òï', 'üöÄ'];
        let currentServerIconIndex = 0;


        // --- Utility Functions ---

        /** Toggles visibility of screen elements */
        function showScreen(screenId) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('passwordSetupScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'none';
            
            if (screenId) {
                document.getElementById(screenId).style.display = 'flex';
            }
        }

        /** Handles email input validation and button state. */
        function validateEmailInput() {
            const emailInput = document.getElementById('emailInput');
            const emailStatus = document.getElementById('emailStatus');
            const emailCheckBtn = document.getElementById('emailCheckBtn');
            const email = emailInput.value.trim();
            
            // Regex to check for a valid email ending in @gmail.com
            const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;

            if (email === '') {
                emailStatus.textContent = '';
                emailCheckBtn.disabled = true;
            } else if (!gmailRegex.test(email)) {
                emailStatus.textContent = '‚ùå Please enter a valid @gmail.com address.';
                emailStatus.className = 'text-xs mt-2 text-red-400';
                emailCheckBtn.disabled = true;
            } else {
                // Email format is correct, enable the button
                emailStatus.textContent = '‚úÖ Email format looks good. Click Continue.';
                emailStatus.className = 'text-xs mt-2 text-green-400';
                emailCheckBtn.disabled = false;
            }
        }
        
        /** Checks if email exists in the simulated database and proceeds to next step. */
        function checkEmail() {
            const email = document.getElementById('emailInput').value.trim();
            tempEmail = email;

            const userExists = users.find(u => u.email === email);
            
            document.getElementById('currentEmailDisplay').textContent = tempEmail;

            if (userExists) {
                // Existing user - show login form
                document.getElementById('setupScreenIcon').textContent = 'üîë';
                document.getElementById('setupScreenTitle').textContent = 'Welcome Back!';
                document.getElementById('setupScreenSubtitle').innerHTML = `Please enter your password for <span class="font-medium text-blue-300">${tempEmail}</span>`;
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('loginPasswordInput').value = ''; 
                document.getElementById('performLoginBtn').disabled = true;
                document.getElementById('loginPasswordStatus').textContent = ''; // Clear status message
            } else {
                // New user - show signup form (ID and Password creation)
                document.getElementById('setupScreenIcon').textContent = 'üìù';
                document.getElementById('setupScreenTitle').textContent = 'Create Your Account';
                document.getElementById('setupScreenSubtitle').innerHTML = `Finish setting up your profile for <span class="font-medium text-blue-300">${tempEmail}</span>`;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
                document.getElementById('signupUserIdInput').value = email.split('@')[0];
                document.getElementById('signupPasswordInput').value = ''; 
                document.getElementById('performSignupBtn').disabled = true;
                validateSignupFields();
            }
            
            showScreen('passwordSetupScreen');
        }

        function backToLogin() {
            showScreen('loginScreen');
        }

        // --- Signup/New User Logic (ID & Password Creation) ---

        /** Validates user ID and password for new accounts */
        function validateSignupFields() {
            const idInput = document.getElementById('signupUserIdInput');
            const passwordInput = document.getElementById('signupPasswordInput');
            const idStatus = document.getElementById('signupUserIdStatus');
            const passwordStatus = document.getElementById('signupPasswordStatus');
            const signupBtn = document.getElementById('performSignupBtn');
            
            const userId = idInput.value.trim().toLowerCase();
            const password = passwordInput.value;
            let isIdValid = false;
            let isPasswordValid = false;
            
            // 1. Validate User ID format and availability
            const idRegex = /^[a-z0-9_]{3,20}$/; // 3-20 chars, lowercase letters, numbers, underscore
            const idExists = users.some(u => u.id === userId);

            if (!idRegex.test(userId)) {
                idStatus.textContent = '‚ùå ID must be 3-20 characters, lowercase, numbers, or underscores.';
                idStatus.className = 'text-xs mt-1 text-red-400';
            } else if (idExists) {
                idStatus.textContent = `‚ùå The ID @${userId} is already taken.`;
                idStatus.className = 'text-xs mt-1 text-red-400';
            } else {
                idStatus.textContent = `‚úÖ The ID @${userId} is available.`;
                idStatus.className = 'text-xs mt-1 text-green-400';
                isIdValid = true;
            }
            
            // 2. Validate Password strength
            if (password.length < 6) {
                passwordStatus.textContent = '‚ùå Password must be at least 6 characters long.';
                passwordStatus.className = 'text-xs mt-1 text-red-400';
            } else {
                passwordStatus.textContent = '‚úÖ Password looks good.';
                passwordStatus.className = 'text-xs mt-1 text-green-400';
                isPasswordValid = true;
            }

            // 3. Enable/Disable button
            signupBtn.disabled = !(isIdValid && isPasswordValid);
        }

        /** Performs new user registration */
        function performSignup() {
            const userId = document.getElementById('signupUserIdInput').value.trim().toLowerCase();
            const password = document.getElementById('signupPasswordInput').value;

            // Final check just in case
            if (!userId || !password || users.some(u => u.id === userId)) {
                alert("Signup failed: Invalid ID or password. Please re-check the fields.");
                return;
            }

            const newUser = {
                email: tempEmail,
                password: password, // In a real app, this would be hashed!
                id: userId,
                displayName: userId.charAt(0).toUpperCase() + userId.slice(1), // Default Display Name
                joinDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                bio: 'A new Squit! up user!',
                status: 'online',
            };

            users.push(newUser);
            userState[userId] = { friends: [], requestsSent: [], requestsReceived: [], chats: {} };
            currentUser = newUser;
            
            alert(`üéâ Success! Account created for ${newUser.displayName}. You are now logged in.`);
            initializeChatApp();
        }


        // --- Login/Existing User Logic ---

        /** Validates password input for existing users */
        function validateLoginPassword() {
            const passwordInput = document.getElementById('loginPasswordInput');
            const loginBtn = document.getElementById('performLoginBtn');
            
            // Simple check: just ensure there's a password entered
            loginBtn.disabled = (passwordInput.value.length === 0);
        }
        
        /** Performs existing user login */
        function performLogin() {
            const password = document.getElementById('loginPasswordInput').value;
            const existingUser = users.find(u => u.email === tempEmail);

            if (existingUser && existingUser.password === password) {
                currentUser = existingUser;
                alert(`üëã Welcome back, ${currentUser.displayName}!`);
                initializeChatApp();
            } else {
                document.getElementById('loginPasswordStatus').textContent = '‚ùå Invalid password. Please try again.';
                document.getElementById('loginPasswordStatus').className = 'text-xs mt-1 text-red-400';
            }
        }
        
        /** Logs out the current user and returns to the login screen */
        function logout() {
            if (currentUser && confirm(`Are you sure you want to sign out, ${currentUser.displayName}?`)) {
                currentUser = null;
                tempEmail = '';
                currentChatTarget = null;
                currentServer = 'home';
                document.getElementById('emailInput').value = '';
                validateEmailInput(); // Clear status messages
                showScreen('loginScreen');
            }
        }

        // --- Chat App Initialization and State Management ---

        /** Initializes the main chat application interface */
        function initializeChatApp() {
            if (!currentUser) return;

            // Update user info in the sidebar
            document.getElementById('userAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = currentUser.displayName;
            document.getElementById('userIdDisplay').textContent = `@${currentUser.id}`;
            
            // Load DMs and friend requests
            renderFriendsList();
            renderFriendRequests();
            renderServerList();
            
            // Switch to the DM screen (Home)
            switchToHome();
            showScreen('chatApp');
        }

        /** Renders the list of friends in the DM sidebar */
        function renderFriendsList() {
            const friendsListContainer = document.getElementById('friendsList');
            friendsListContainer.innerHTML = '';
            
            const friendIDs = userState[currentUser.id].friends;

            if (friendIDs.length === 0) {
                friendsListContainer.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        No friends yet.<br>Add friends to start chatting!
                    </div>`;
                return;
            }
            
            friendIDs.forEach(friendId => {
                const friend = users.find(u => u.id === friendId);
                if (!friend) return; // Should not happen in a real app

                const friendElement = document.createElement('div');
                friendElement.className = 'flex items-center space-x-3 p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                friendElement.setAttribute('onclick', `openDM('${friend.id}', '${friend.displayName}')`);
                
                friendElement.innerHTML = `
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-sm font-semibold relative">
                        ${friend.displayName.charAt(0).toUpperCase()}
                        <div class="w-2 h-2 ${friend.status === 'online' ? 'bg-green-500 online-dot' : 'bg-yellow-500'} rounded-full absolute bottom-0 right-0"></div>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-sm">${friend.displayName}</div>
                        <div class="text-xs text-gray-400">@${friend.id}</div>
                    </div>
                `;
                friendsListContainer.appendChild(friendElement);
            });
        }

        /** Renders the list of friend requests */
        function renderFriendRequests() {
            const requestsContainer = document.getElementById('friendRequests');
            requestsContainer.innerHTML = '';

            const requests = userState[currentUser.id].requestsReceived;

            if (requests.length === 0) {
                requestsContainer.innerHTML = '<div class="text-sm text-gray-500 text-center">No pending requests</div>';
                return;
            }

            requests.forEach(senderId => {
                const sender = users.find(u => u.id === senderId);
                if (!sender) return;

                const requestElement = document.createElement('div');
                requestElement.className = 'p-2 border border-gray-700 rounded-lg space-y-2';
                requestElement.innerHTML = `
                    <div class="flex items-center justify-between text-sm">
                        <span class="font-medium">${sender.displayName}</span>
                        <span class="text-gray-400">@${sender.id}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="handleFriendRequest('${sender.id}', 'accept')" class="flex-1 text-xs bg-green-600 hover:bg-green-700 py-1 rounded">Accept</button>
                        <button onclick="handleFriendRequest('${sender.id}', 'decline')" class="flex-1 text-xs bg-red-600 hover:bg-red-700 py-1 rounded">Decline</button>
                    </div>
                `;
                requestsContainer.appendChild(requestElement);
            });
        }
        
        // --- Friend Management Logic ---

        /** Shows the Add Friend modal */
        function showAddFriend() {
            document.getElementById('addFriendModal').style.display = 'flex';
            document.getElementById('friendIdInput').value = '';
            document.getElementById('friendIdStatus').textContent = '';
        }

        /** Closes the Add Friend modal */
        function closeAddFriend() {
            document.getElementById('addFriendModal').style.display = 'none';
        }

        /** Simulates sending a friend request */
        function sendFriendRequest() {
            const friendIdInput = document.getElementById('friendIdInput');
            const friendId = friendIdInput.value.trim().toLowerCase().replace('@', '');
            const friendIdStatus = document.getElementById('friendIdStatus');
            
            // Validation
            if (friendId === currentUser.id) {
                friendIdStatus.textContent = '‚ùå You can\'t add yourself!';
                friendIdStatus.className = 'text-xs mt-1 text-red-400';
                return;
            }
            
            const targetUser = users.find(u => u.id === friendId);
            
            if (!targetUser) {
                friendIdStatus.textContent = `‚ùå User @${friendId} not found.`;
                friendIdStatus.className = 'text-xs mt-1 text-red-400';
                return;
            }

            if (userState[currentUser.id].friends.includes(friendId)) {
                friendIdStatus.textContent = `‚úÖ @${friendId} is already your friend.`;
                friendIdStatus.className = 'text-xs mt-1 text-green-400';
                return;
            }

            if (userState[currentUser.id].requestsSent.includes(friendId)) {
                friendIdStatus.textContent = `‚ö†Ô∏è You already sent a request to @${friendId}.`;
                friendIdStatus.className = 'text-xs mt-1 text-yellow-400';
                return;
            }
            
            // Simulated sending the request
            if (!userState[targetUser.id]) {
                // Initialize userState for the target if it wasn't already in the initial setup (e.g. if new user was created)
                userState[targetUser.id] = { friends: [], requestsSent: [], requestsReceived: [], chats: {} };
            }
            userState[currentUser.id].requestsSent.push(friendId);
            userState[targetUser.id].requestsReceived.push(currentUser.id);
            
            friendIdStatus.textContent = `üöÄ Friend request sent to @${friendId}! (Check "existingid" for the request)`;
            friendIdStatus.className = 'text-xs mt-1 text-green-400';
        }

        /** Handles accepting or declining a friend request */
        function handleFriendRequest(senderId, action) {
            // Remove from received list
            userState[currentUser.id].requestsReceived = userState[currentUser.id].requestsReceived.filter(id => id !== senderId);

            // Remove from sender's sent list
            userState[senderId].requestsSent = userState[senderId].requestsSent.filter(id => id !== currentUser.id);

            if (action === 'accept') {
                // Add to friends lists
                userState[currentUser.id].friends.push(senderId);
                userState[senderId].friends.push(currentUser.id);

                // Create initial chat entry
                userState[currentUser.id].chats[senderId] = [{ senderId: 'system', content: `You and ${senderId} are now connected! Say hello!`, timestamp: Date.now() }];
                userState[senderId].chats[currentUser.id] = [{ senderId: 'system', content: `You and ${currentUser.id} are now connected! Say hello!`, timestamp: Date.now() }];

                alert(`Friend request from @${senderId} accepted!`);
            } else {
                alert(`Friend request from @${senderId} declined.`);
            }

            // Re-render UI
            renderFriendsList();
            renderFriendRequests();
        }

        // --- Chat/Message Logic ---

        /** Opens a direct message chat with a specific user */
        function openDM(userId, displayName) {
            currentChatTarget = userId;
            currentServer = 'home';

            // Update UI to DM state
            document.getElementById('sidebarTitle').textContent = 'Direct Messages';
            document.getElementById('sidebarSubtitle').textContent = 'Your friends list';
            document.getElementById('serverChannels').style.display = 'none';
            document.getElementById('dmSection').style.display = 'flex';
            
            // Update Chat Header
            document.getElementById('chatTitle').textContent = displayName;
            document.getElementById('chatStatus').textContent = `@${userId}`;
            document.getElementById('messageInputArea').style.display = 'flex';

            renderMessages(userId);
        }

        /** Renders messages for the current chat target (DM or Channel) */
        function renderMessages(targetId) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            let messages = [];

            if (currentServer === 'home') {
                // DM chat
                if (!userState[currentUser.id].chats[targetId]) {
                    userState[currentUser.id].chats[targetId] = [];
                }
                messages = userState[currentUser.id].chats[targetId];
            } else {
                // Server Channel chat - simulation only
                const server = servers.find(s => s.id === currentServer);
                const channel = server ? server.channels.find(c => c.id === targetId) : null;
                messages = channel ? channel.messages : [];
                if (!channel) return;
            }

            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">üëã</div>
                            <p>Start your conversation with ${document.getElementById('chatTitle').textContent}!</p>
                        </div>
                    </div>`;
                return;
            }

            messages.forEach(msg => {
                const isMine = msg.senderId === currentUser.id;
                const sender = users.find(u => u.id === msg.senderId) || { displayName: 'System', id: 'system' };
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isMine ? 'justify-end' : 'justify-start'} message-enter`;
                
                const bubbleClass = isMine 
                    ? 'bg-purple-600 text-white rounded-tr-none' 
                    : 'bg-gray-700 text-white rounded-tl-none';

                let senderName = sender.displayName;
                if (msg.senderId === 'system') {
                    senderName = '<span class="text-yellow-400">System Message</span>';
                }

                messageDiv.innerHTML = `
                    <div class="max-w-xl w-auto">
                        <div class="text-xs ${isMine ? 'text-right text-gray-400' : 'text-left text-gray-300'} mb-1 font-semibold">
                            ${senderName}
                            <span class="font-normal text-gray-500 ml-2">${new Date(msg.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="px-4 py-2 rounded-xl ${bubbleClass} shadow-md break-words">
                            ${msg.content}
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
            });
            
            // Scroll to the bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /** Sends a message to the current chat target */
        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChatTarget) return;

            const newMessage = {
                senderId: currentUser.id,
                content: content,
                timestamp: Date.now()
            };

            if (currentServer === 'home') {
                // DM Chat
                // Add message to current user's chat history
                if (!userState[currentUser.id].chats[currentChatTarget]) {
                    userState[currentUser.id].chats[currentChatTarget] = [];
                }
                userState[currentUser.id].chats[currentChatTarget].push(newMessage);

                // Simulate adding message to recipient's chat history
                if (!userState[currentChatTarget] || !userState[currentChatTarget].chats) {
                    // For a brand new user created in the demo that hasn't initialized userState[targetId]
                    // This is a safety check and might be overkill in a real application with a proper database
                    const targetUser = users.find(u => u.id === currentChatTarget);
                    if (targetUser && !userState[targetUser.id]) {
                         userState[targetUser.id] = { friends: [], requestsSent: [], requestsReceived: [], chats: {} };
                    }
                }
                if (userState[currentChatTarget] && !userState[currentChatTarget].chats[currentUser.id]) {
                    userState[currentChatTarget].chats[currentUser.id] = [];
                }
                if (userState[currentChatTarget]) {
                    userState[currentChatTarget].chats[currentUser.id].push(newMessage);
                }
                
            } else {
                // Server Channel Chat
                const server = servers.find(s => s.id === currentServer);
                const channel = server.channels.find(c => c.id === currentChatTarget);
                channel.messages.push(newMessage);
            }

            input.value = '';
            renderMessages(currentChatTarget);
        }

        // --- Profile Management Logic ---

        /** Populates and shows the Profile modal */
        function showProfile() {
            document.getElementById('profileName').textContent = currentUser.displayName;
            document.getElementById('profileId').textContent = `@${currentUser.id}`;
            document.getElementById('profileAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
            document.getElementById('profileBio').textContent = currentUser.bio || 'No bio set yet. Click "Edit Profile" to add one!';
            document.getElementById('profileJoinDate').textContent = currentUser.joinDate;
            
            document.getElementById('profileModal').style.display = 'flex';
        }

        /** Closes the Profile modal */
        function closeProfile() {
            document.getElementById('profileModal').style.display = 'none';
        }

        /** Populates and shows the Edit Profile modal */
        function editProfile() {
            document.getElementById('editDisplayName').value = currentUser.displayName;
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editStatus').value = currentUser.status;
            
            closeProfile();
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        /** Closes the Edit Profile modal */
        function closeEditProfile() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        /** Saves changes made in the Edit Profile modal */
        function saveProfile() {
            const newDisplayName = document.getElementById('editDisplayName').value.trim();
            const newBio = document.getElementById('editBio').value.trim();
            const newStatus = document.getElementById('editStatus').value;

            // Simple validation
            if (!newDisplayName) {
                alert("Display Name cannot be empty.");
                return;
            }

            // Update local object
            currentUser.displayName = newDisplayName;
            currentUser.bio = newBio;
            currentUser.status = newStatus;

            // Update UI elements
            document.getElementById('userName').textContent = currentUser.displayName;
            document.getElementById('userAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
            
            // Re-render DMs to update display names
            renderFriendsList();
            
            // Close modal
            closeEditProfile();
            alert("Profile saved successfully!");
        }

        // Dummy functions for image/banner changes
        function changeBanner() {
            alert("Simulated: Changing banner image...");
        }
        function changeAvatar() {
            alert("Simulated: Changing avatar image...");
        }

        // --- Server and Channel Logic (Simulated) ---

        /** Switches the sidebar to the DM/Home view */
        function switchToHome() {
            currentServer = 'home';
            currentChatTarget = null;
            
            // Sidebar updates
            document.getElementById('sidebarTitle').textContent = 'Squit! up';
            document.getElementById('sidebarSubtitle').textContent = 'Connect with friends';
            document.getElementById('serverChannels').style.display = 'none';
            document.getElementById('dmSection').style.display = 'flex';

            // Main chat area updates
            document.getElementById('chatTitle').textContent = 'Select a friend to start chatting';
            document.getElementById('chatStatus').textContent = 'Ready to connect';
            document.getElementById('messageInputArea').style.display = 'none';
            document.getElementById('messagesContainer').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="text-6xl mb-4">üí¨</div>
                        <h3 class="text-xl font-semibold mb-2">Welcome to Squit! up</h3>
                        <p>Add friends and start chatting!</p>
                    </div>
                </div>
            `;
            
            // Highlight the home button
            document.querySelectorAll('#serverList > div').forEach(el => el.classList.remove('bg-gray-700', 'rounded-xl'));
            document.getElementById('homeButton').classList.add('bg-purple-600', 'rounded-xl');
        }

        /** Switches the sidebar to a server view */
        function switchToServer(serverId) {
            currentServer = serverId;
            const server = servers.find(s => s.id === serverId);
            if (!server) return;
            
            currentChatTarget = server.channels[0].id; // Auto-select first channel

            // Sidebar updates
            document.getElementById('sidebarTitle').textContent = server.name;
            document.getElementById('sidebarSubtitle').textContent = server.desc;
            document.getElementById('dmSection').style.display = 'none';
            document.getElementById('serverChannels').style.display = 'flex';
            
            // Render channels
            renderChannels(server);

            // Update Chat Header & Messages
            const firstChannel = server.channels[0];
            if (firstChannel) {
                openChannel(firstChannel.id, firstChannel.name, firstChannel.type);
            }
            
            // Highlight the selected server button
            document.querySelectorAll('#serverList > div').forEach(el => el.classList.remove('bg-gray-700', 'rounded-xl'));
            document.getElementById(serverId).classList.add('bg-gray-700', 'rounded-xl');
            document.getElementById('homeButton').classList.remove('bg-purple-600', 'rounded-xl');
        }

        /** Renders the list of servers */
        function renderServerList() {
            const serverListContainer = document.getElementById('serverList');
            serverListContainer.innerHTML = ''; // Clear existing list
            
            servers.forEach(server => {
                const serverElement = document.createElement('div');
                serverElement.id = server.id;
                serverElement.className = 'w-12 h-12 bg-gray-700 hover:bg-purple-600 rounded-2xl hover:rounded-xl transition-all duration-200 flex items-center justify-center cursor-pointer text-white font-medium text-xl';
                serverElement.setAttribute('onclick', `switchToServer('${server.id}')`);
                serverElement.textContent = server.icon || server.name.charAt(0);
                serverListContainer.appendChild(serverElement);
            });
        }

        /** Renders channels for the current server */
        function renderChannels(server) {
            const channelsListContainer = document.getElementById('channelsList');
            channelsListContainer.innerHTML = '';

            server.channels.forEach(channel => {
                const icon = channel.type === 'voice' ? 'üîä' : channel.type === 'announcement' ? 'üì¢' : 'üí¨';
                const channelElement = document.createElement('div');
                channelElement.className = 'flex items-center space-x-2 p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300 hover:text-white text-sm';
                channelElement.setAttribute('onclick', `openChannel('${channel.id}', '${channel.name}', '${channel.type}')`);
                channelElement.innerHTML = `
                    <span>${icon}</span>
                    <span class="font-medium">${channel.name}</span>
                `;
                channelsListContainer.appendChild(channelElement);
            });
        }

        /** Opens a channel chat */
        function openChannel(channelId, channelName, channelType) {
            currentChatTarget = channelId;
            
            // Update Chat Header
            const icon = channelType === 'voice' ? 'üîä' : channelType === 'announcement' ? 'üì¢' : 'üí¨';
            document.getElementById('chatTitle').innerHTML = `${icon} ${channelName}`;
            document.getElementById('chatStatus').textContent = currentServer;
            document.getElementById('messageInputArea').style.display = (channelType === 'voice' || channelType === 'announcement') ? 'none' : 'flex';
            
            renderMessages(channelId);

            // Highlight channel
            document.querySelectorAll('#channelsList > div').forEach(el => el.classList.remove('bg-gray-700', 'text-white'));
            const selectedChannel = Array.from(document.getElementById('channelsList').children).find(el => el.textContent.includes(channelName));
            if (selectedChannel) {
                selectedChannel.classList.add('bg-gray-700', 'text-white');
            }
        }

        /** Modal functions for Server Creation */
        function showCreateServer() {
            document.getElementById('createServerModal').style.display = 'flex';
            document.getElementById('serverNameInput').value = '';
            document.getElementById('serverDescInput').value = '';
            currentServerIconIndex = 0;
            document.getElementById('serverIconText').textContent = serverIconOptions[currentServerIconIndex];
        }
        function closeCreateServer() {
            document.getElementById('createServerModal').style.display = 'none';
        }
        function changeServerIcon() {
            currentServerIconIndex = (currentServerIconIndex + 1) % serverIconOptions.length;
            document.getElementById('serverIconText').textContent = serverIconOptions[currentServerIconIndex];
        }
        function createServer() {
            const name = document.getElementById('serverNameInput').value.trim();
            const desc = document.getElementById('serverDescInput').value.trim();
            const icon = document.getElementById('serverIconText').textContent;

            if (!name) {
                alert("Server name is required.");
                return;
            }

            const newServerId = 'server_' + (servers.length + 1);

            const newServer = {
                id: newServerId,
                name: name,
                desc: desc || 'A newly created Squit! up server.',
                icon: icon,
                ownerId: currentUser.id,
                channels: [
                    { id: newServerId + '_general', name: 'general', type: 'text', messages: [{ senderId: 'system', content: `Welcome to the ${name} server!`, timestamp: Date.now() }] },
                    { id: newServerId + '_voice', name: 'Voice Chat', type: 'voice', messages: [] }
                ]
            };

            servers.push(newServer);
            renderServerList();
            closeCreateServer();
            switchToServer(newServerId);
            alert(`Server "${name}" created successfully!`);
        }

        /** Modal functions for Channel Creation */
        function showCreateChannel() {
            if (currentServer === 'home') {
                alert("You can only create channels within a server. Create a server first!");
                return;
            }
            document.getElementById('createChannelModal').style.display = 'flex';
            document.getElementById('channelNameInput').value = '';
            document.getElementById('channelDescInput').value = '';
            document.getElementById('channelTypeSelect').value = 'text';
        }
        function closeCreateChannel() {
            document.getElementById('createChannelModal').style.display = 'none';
        }
        function createChannel() {
            const name = document.getElementById('channelNameInput').value.trim().toLowerCase().replace(/\s/g, '-');
            const type = document.getElementById('channelTypeSelect').value;
            const desc = document.getElementById('channelDescInput').value.trim();
            
            if (!name) {
                alert("Channel name is required.");
                return;
            }

            const server = servers.find(s => s.id === currentServer);
            if (!server) {
                alert("Error: No active server selected.");
                return;
            }
            if (server.channels.some(c => c.name === name)) {
                alert(`A channel named "${name}" already exists.`);
                return;
            }

            const newChannelId = currentServer + '_' + name;
            const newChannel = { 
                id: newChannelId, 
                name: name, 
                type: type, 
                messages: [{ senderId: 'system', content: `Channel "${name}" (${type}) was created.`, timestamp: Date.now() }] 
            };

            server.channels.push(newChannel);
            renderChannels(server);
            closeCreateChannel();
            openChannel(newChannelId, name, type);
            alert(`Channel #${name} created successfully!`);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('loginScreen');
        });

    </script>
</body>
</html>