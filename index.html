<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURY - Realtime Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        /* Custom scrollbar for chat box */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #1f2937; /* gray-800 */
        }
        /* Custom scrollbar for sidebar */
        #users-list::-webkit-scrollbar {
            width: 6px;
        }
        #users-list::-webkit-scrollbar-thumb {
            background-color: #374151; /* gray-700 */
            border-radius: 3px;
        }
        #users-list::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 h-screen">

    <!-- Main application container -->
    <div id="app-container" class="h-full">
        <!-- Content will be injected here -->
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithEmailAndPassword, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, serverTimestamp, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        let app, db, auth;
        let userId = null;
        let currentUserProfile = null; // Store fetched user profile data
        let isAuthReady = false; 
        let totalUserCount = 0; 

        // --- GLOBAL VARIABLES (Provided by environment or manually configured) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Custom Configuration (Provided by user - CRITICAL) ---
        const customFirebaseConfig = {
            apiKey: "AIzaSyB1zvVHaBrbzX5iA9fBVNGa_3sY1-WCSpY", 
            authDomain: "squit-up-auth.firebaseapp.com",
            projectId: "squit-up-auth",
            storageBucket: "squit-up-auth.firebasestorage.app",
            messagingSenderId: "586918898443",
            appId: "1:586918898443:web:c5a56eb24cd4f183d8600e",
            measurementId: "G-K4LHFHSNJC"
        };
        // -------------------------------------------------------------------------------

        // Use the environment configuration if available, otherwise use the custom config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : customFirebaseConfig;
        
        // --- UTILITY FUNCTIONS ---

        /**
         * Generic function to retry an async function with exponential backoff.
         */
        async function fetchWithExponentialBackoff(apiCall, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (error.code && error.code.includes('api-key-not-valid') && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue; 
                    }
                    throw error; 
                }
            }
        }

        /**
         * Renders the loading spinner into the app container.
         */
        function renderLoading(message = "Connecting...") {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center text-white bg-gray-900">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-t-4 border-red-500 border-opacity-25 rounded-full animate-spin"></div>
                        <p class="mt-4 text-lg text-gray-400">${message}</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Sign-In screen with Email/Password and Google options.
         */
        function renderSignIn(errorMessage = '') {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center bg-gray-900">
                    <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <div class="flex justify-center mb-6">
                            <div class="p-3 bg-red-500 rounded-full">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.111A9.502 9.502 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                        </div>
                        <h1 class="text-3xl font-extrabold text-red-500 mb-2">FURY</h1>
                        <p class="text-gray-400 mb-8">Connect with friends instantly.</p>
                        
                        <h2 class="text-2xl font-semibold text-white mb-4">Sign In</h2>
                        
                        <form id="email-password-form" class="space-y-4">
                            <input 
                                type="text" 
                                id="email-input" 
                                placeholder="Email or @user_id"
                                required 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <input 
                                type="password" 
                                id="password-input" 
                                placeholder="Password"
                                required 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <button id="email-signin-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-indigo-600/30">
                                Log In
                            </button>
                        </form>
                        
                        <div class="my-6 flex items-center">
                            <div class="flex-grow border-t border-gray-700"></div>
                            <span class="flex-shrink mx-4 text-gray-500">OR</span>
                            <div class="flex-grow border-t border-gray-700"></div>
                        </div>

                        <button id="google-signin-btn" class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-red-600/30">
                            <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.61 20.08v3.42H24V20.08h19.61z"/><path fill="#FF3D00" d="M6.3 33.15c.61 1.77 1.63 3.32 2.87 4.6l5.77-4.47c-.77-.48-1.44-1.07-1.95-1.78H6.3z"/><path fill="#4CAF50" d="M43.61 24.5v3.42H24v-3.42h19.61z"/><path fill="#1976D2" d="M12.94 37.75c3.08 3.52 7.7 5.75 12.87 5.75s9.79-2.23 12.87-5.75l-5.77-4.47c-2.34 2.1-5.32 3.42-9.1 3.42s-6.76-1.32-9.1-3.42L12.94 37.75z"/><path fill="#F44336" d="M24 8c-4.99 0-9.62 2.11-12.87 5.75l5.77 4.47c2.34-2.1 5.32-3.42 9.1-3.42s6.76-1.32 9.1-3.42l5.77-4.47C33.62 10.11 28.99 8 24 8z"/></svg>
                            Sign in with Google
                        </button>
                        
                        ${errorMessage ? `<p id="error-message" class="text-sm text-red-400 mt-4 font-semibold p-2 bg-gray-900 rounded-lg">${errorMessage}</p>` : ''}
                        
                        <p class="text-xs text-gray-600 mt-4">By signing in, you agree to our <a href="#" class="text-red-500 hover:underline">Terms of Service</a>.</p>
                    </div>
                </div>
            `;
            // Attach event listeners after rendering
            document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
            document.getElementById('email-password-form').addEventListener('submit', handleEmailPasswordSignIn);
        }

        /**
         * Renders the Profile Setup screen for new Google users.
         */
        function renderProfileSetup(errorMessage = '') {
            const user = auth.currentUser;
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="h-full flex items-center justify-center bg-gray-900">
                    <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <h1 class="text-2xl font-extrabold text-white mb-2">Welcome to FURY!</h1>
                        <p class="text-gray-400 mb-8">
                            Complete your profile to unlock manual login and set your chat identity.
                        </p>
                        
                        <p class="text-sm text-gray-400 mb-4 p-2 bg-gray-700 rounded-lg">
                            Your login email: <strong class="text-red-400">${user?.email || 'N/A'}</strong>
                        </p>
                        
                        <form id="profile-setup-form" class="space-y-4">
                            <!-- @user_id Input (Display Name) -->
                            <input 
                                type="text" 
                                id="user-id-input" 
                                placeholder="@user_id (e.g., @GamerTag)"
                                required 
                                pattern="^@[a-zA-Z0-9_]{3,15}$"
                                title="Must start with @ and contain 3-15 letters, numbers, or underscores."
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <!-- Password Input -->
                            <input 
                                type="password" 
                                id="new-password-input" 
                                placeholder="Set Password (min 6 chars)"
                                required 
                                minlength="6"
                                class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                            >
                            <button id="setup-btn" type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-red-600/30">
                                Complete Setup
                            </button>
                        </form>
                        
                        ${errorMessage ? `<p id="error-message" class="text-sm text-red-400 mt-4 font-semibold p-2 bg-gray-900 rounded-lg">${errorMessage}</p>` : ''}
                    </div>
                </div>
            `;
            // Attach event listener after rendering
            document.getElementById('profile-setup-form').addEventListener('submit', handleProfileSetup);
        }

        /**
         * Handles the profile setup: sets display name and password.
         */
        async function handleProfileSetup(e) {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                renderSignIn("Session expired. Please sign in again.");
                return;
            }

            const userIdInput = document.getElementById('user-id-input').value.trim();
            const newPassword = document.getElementById('new-password-input').value;

            if (newPassword.length < 6) {
                return renderProfileSetup('Password must be at least 6 characters long.');
            }

            if (!userIdInput.match(/^@[a-zA-Z0-9_]{3,15}$/)) {
                return renderProfileSetup('Invalid @user_id format. Must start with @ and contain 3-15 letters, numbers, or underscores.');
            }

            renderLoading("Setting up profile...");

            try {
                // 1. Update the user's display name in Firebase Auth
                await updateProfile(user, { displayName: userIdInput });

                // 2. Set the password for this account (allows non-Google login later)
                await updatePassword(user, newPassword);

                // 3. Update the Firestore profile to mark setup as complete and use the new display name
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', user.uid);
                await setDoc(userDocRef, {
                    displayName: userIdInput,
                    isSetupComplete: true,
                    lastActive: serverTimestamp(),
                }, { merge: true });

                // Success: Manually update profile state and render chat UI to ensure immediate transition
                currentUserProfile = { ...currentUserProfile, displayName: userIdInput, isSetupComplete: true };
                renderChatUI(); 
            } catch (error) {
                console.error("Profile Setup failed:", error);
                let message = 'Profile setup failed. Please try again.';
                if (error.code === 'auth/weak-password') {
                    message = 'Password is too weak. Choose a stronger one.';
                } else if (error.code === 'auth/requires-recent-login') {
                    message = 'Please log out and log back in before completing setup.';
                } else if (error.code === 'auth/credential-too-old') {
                    message = 'Please log out and log back in before completing setup (credential too old).';
                }
                renderProfileSetup(message);
            }
        }
        
        /**
         * Parses Firebase errors for user-friendly display.
         */
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Invalid email format.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    return 'Invalid email or password.';
                case 'auth/popup-closed-by-user':
                    return 'Sign-in window was closed. Please try again.';
                case 'auth/unauthorized-domain':
                    return 'Error: Unauthorized domain. Check your Firebase settings.';
                case 'auth/api-key-not-valid':
                    return 'Configuration Error: Invalid Firebase API Key.';
                case 'auth/email-already-in-use':
                    return 'Email is already registered. Try logging in manually.';
                default:
                    return `Authentication failed: ${errorCode}. Check console.`;
            }
        }

        /**
         * Email/Password Sign-In handler.
         */
        async function handleEmailPasswordSignIn(e) {
            e.preventDefault();
            const input = document.getElementById('email-input').value; 
            const password = document.getElementById('password-input').value;
            
            // Simplified logic: Assume input is email if it contains '@', otherwise append a placeholder domain.
            const email = input.includes('@') ? input : input + '@furychat.com'; 

            if (!email || !password) {
                 return renderSignIn('Please enter both email and password.');
            }

            renderLoading("Logging in...");

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // AuthStateChanged listener will handle the rest (rendering chat UI)

            } catch (error) {
                console.error("Email/Password Sign-In failed:", error);
                
                const userFriendlyMessage = getAuthErrorMessage(error.code);
                renderSignIn(userFriendlyMessage); 
            }
        }

        /**
         * Google Sign-In handler with Exponential Backoff.
         */
        async function signInWithGoogle() {
            renderLoading("Opening Google Sign-In...");
            
            try {
                const provider = new GoogleAuthProvider();
                await fetchWithExponentialBackoff(async () => {
                    return await signInWithPopup(auth, provider);
                });
                // AuthStateChanged listener will be triggered upon success
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                
                let userFriendlyMessage = getAuthErrorMessage(error.code);
                renderSignIn(userFriendlyMessage); 
            }
        }

        /**
         * Signs out the current user and sets their status to 'offline'.
         */
        async function handleSignOut() {
            try {
                if (userId) {
                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
                    // Do not wait for this update to complete to ensure fast sign-out
                    setDoc(userDocRef, { onlineStatus: 'offline' }, { merge: true }).catch(e => console.error("Error setting offline status:", e));
                }
                await signOut(auth);
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        }

        /**
         * CRITICAL: Ensures the profile exists and determines whether to render Setup or Chat UI immediately.
         */
        async function initializeUserProfileAndRenderUI(uid) {
            renderLoading("Loading profile data...");
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', uid);
            const user = auth.currentUser;
            const defaultDisplay = user?.email ? user.email.split('@')[0] : `user_${uid.substring(0, 8)}`;
            let isSetupComplete = false;

            try {
                const docSnap = await getDoc(userDocRef);
                
                if (!docSnap.exists()) {
                    // Profile does not exist, create it with setup incomplete
                    await setDoc(userDocRef, {
                        userId: uid,
                        displayName: user.displayName || defaultDisplay,
                        email: user?.email || '',
                        onlineStatus: 'online', 
                        isSetupComplete: false, 
                        lastActive: serverTimestamp(),
                        createdAt: serverTimestamp(),
                    });
                    currentUserProfile = { displayName: user.displayName || defaultDisplay, isSetupComplete: false, onlineStatus: 'online' };

                } else {
                    // Profile exists, update status and check setup state
                    currentUserProfile = docSnap.data();
                    isSetupComplete = currentUserProfile.isSetupComplete === true;
                    
                    await setDoc(userDocRef, {
                        onlineStatus: 'online',
                        lastActive: serverTimestamp(),
                    }, { merge: true });
                }
            } catch (error) {
                console.error("Error creating/updating user profile document (Public Path):", error.message);
                // Set to incomplete as a fallback if Firestore operation fails
                currentUserProfile = currentUserProfile || { displayName: defaultDisplay, isSetupComplete: false, onlineStatus: 'online' };
            }
            
            // --- IMMEDIATE RENDERING LOGIC (The Fix) ---
            if (currentUserProfile.isSetupComplete === true) {
                renderChatUI(); 
            } else if (user && user.providerData.some(p => p.providerId === GoogleAuthProvider.PROVIDER_ID)) {
                // Only prompt setup for Google users who are incomplete
                renderProfileSetup();
            } else {
                // If the user signed in with email/password (and somehow profile is incomplete), go straight to chat.
                // NOTE: Real-world app would enforce completeness, but for robustness here, we render chat.
                 renderChatUI(); 
            }
            
            // Start the real-time listener for subsequent updates (e.g., status changes by other users)
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserProfile = docSnap.data();
                    // We only re-render the chat if the profile became complete OR if status changed
                    if (document.getElementById('messages-container')) {
                         // Only update UI elements if we are already in the chat view
                         updateSidebarUserCount(totalUserCount);
                    }
                }
            }, (error) => {
                console.error("Error listening to user's public profile:", error.message);
            });
        }


        // --- USER COUNTING LOGIC ---

        /**
         * Listens to ALL user profiles (in the public collection) to get the total count and list of active users.
         */
        function startUserCountListener() {
            if (!db) return; // Ensure DB is initialized
            const publicProfilesRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_profiles');
            
            onSnapshot(publicProfilesRef, (snapshot) => {
                const onlineUsers = [];
                snapshot.forEach(doc => {
                    const profile = doc.data();
                    
                    if (profile.onlineStatus === 'online') {
                        onlineUsers.push(profile);
                    }
                });

                totalUserCount = snapshot.size; 
                
                updateSidebarUserCount(totalUserCount);
                renderOnlineUsersList(onlineUsers);

            }, (error) => {
                console.error("Error listening to public user profiles:", error.message);
            });
        }
        
        /**
         * Renders the total user count in the sidebar.
         */
        function updateSidebarUserCount(count) {
            const countElement = document.getElementById('user-count');
            if (countElement) {
                countElement.textContent = `Registered Users (${count})`;
            }
        }
        
        /**
         * Renders the list of online users in the sidebar.
         */
        function renderOnlineUsersList(users) {
            const listContainer = document.getElementById('users-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            
            const activeUsers = users.filter(user => user.userId !== userId);

            if (activeUsers.length === 0) {
                 listContainer.innerHTML = `<li class="text-sm text-gray-500 p-2">No other users currently active.</li>`;
                return;
            }

            activeUsers.forEach(user => {
                const statusColor = 'bg-green-500'; 
                
                const listItem = document.createElement('li');
                listItem.className = "flex items-center p-2 rounded-lg hover:bg-gray-700 transition duration-150 cursor-pointer";
                listItem.innerHTML = `
                    <div class="flex-shrink-0 w-2 h-2 rounded-full mr-2 ${statusColor}"></div>
                    <span class="text-sm text-gray-300 font-medium">${user.displayName}</span>
                `;
                listContainer.appendChild(listItem);
            });
        }


        // --- CHAT LOGIC ---

        /**
         * Listens to the global chat for messages and updates the UI.
         */
        function startChatListeners() {
            if (!userId || !isAuthReady || !db) return;

            const globalChatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', 'global_fury_chat');
            const messagesRef = collection(globalChatRef, 'messages');
            
            const q = query(messagesRef);

            onSnapshot(q, (snapshot) => {
                const msgs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date()
                }));

                msgs.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
                renderMessages(msgs);
            }, (error) => {
                console.error("Error listening to global chat messages:", error.message);
            });
        }
        
        /**
         * Renders all messages into the chat body.
         */
        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            // Check if user is near the bottom before clearing content
            const shouldScroll = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;

            container.innerHTML = ''; 
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-10 flex-grow flex items-center justify-center">
                        Say hello! Be the first to send a message to **#global-fury-chat**.
                    </div>
                `;
                container.style.display = 'flex';
                container.style.flexDirection = 'column-reverse';
                container.style.justifyContent = 'center';
                return;
            } else {
                container.style.display = 'block'; 
            }

            const fragment = document.createDocumentFragment();

            messages.forEach(message => {
                const isCurrentUser = message.senderId === userId;
                const senderDisplay = message.displayName || message.senderId.substring(0, 8); 

                const bubbleClass = isCurrentUser
                    ? 'bg-red-500 text-white self-end rounded-bl-xl rounded-t-xl'
                    : 'bg-gray-700 text-gray-200 self-start rounded-br-xl rounded-t-xl';
                
                const timestampDisplay = message.timestamp instanceof Date 
                    ? message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                    : '...';

                const messageElement = document.createElement('div');
                messageElement.className = `flex flex-col mb-4 max-w-xs md:max-w-md ${isCurrentUser ? 'items-end' : 'items-start'}`;
                messageElement.innerHTML = `
                    <div class="text-xs text-gray-400 mb-1 px-3">
                        ${isCurrentUser ? 'You' : senderDisplay}
                    </div>
                    <div class="p-3 shadow-md ${bubbleClass}">
                        ${message.text}
                        <span class="ml-4 text-xs opacity-70 block text-right mt-1">${timestampDisplay}</span>
                    </div>
                `;
                fragment.appendChild(messageElement);
            });
            
            container.appendChild(fragment);

            // Auto-scroll to the bottom if the user was already near the bottom
            if (shouldScroll) {
               container.scrollTop = container.scrollHeight;
            }
        }

        /**
         * Sends a message to the global chat room.
         */
        async function sendMessage(text) {
            if (!userId || !text.trim() || !isAuthReady || !currentUserProfile || !db) return;

            try {
                const globalChatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', 'global_fury_chat');
                const messagesCollectionRef = collection(globalChatRef, 'messages');
                
                await addDoc(messagesCollectionRef, {
                    senderId: userId,
                    displayName: currentUserProfile.displayName, 
                    text: text.trim(),
                    timestamp: serverTimestamp(),
                    type: 'text',
                });
                document.getElementById('message-input').value = '';
            } catch (error) {
                console.error("Error sending message:", error.message);
            }
        }


        /**
         * Renders the main chat UI after successful login and profile load.
         */
        function renderChatUI() {
            const userDisplayId = currentUserProfile?.displayName || `@user_${userId.substring(0, 8)}`;
            const onlineStatus = currentUserProfile?.onlineStatus || 'offline';
            const statusColor = onlineStatus === 'online' ? 'bg-green-500' : 'bg-gray-500';

            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="flex h-full text-white bg-gray-900 antialiased">
                    
                    <!-- Sidebar (Left) -->
                    <div class="w-64 bg-gray-800 flex flex-col border-r border-gray-700">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h1 class="text-xl font-extrabold text-red-500">FURY</h1>
                            <button id="signout-btn" class="text-gray-400 hover:text-white transition duration-150" title="Sign Out">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                        
                        <!-- Channels and User List -->
                        <div class="flex-grow flex flex-col p-4 overflow-y-auto" style="min-height: 0;">
                            <!-- Channels List -->
                            <div class="mb-6">
                                <h2 class="text-xs font-semibold uppercase text-gray-400 mb-2">Global Channels</h2>
                                <ul class="space-y-1">
                                    <li>
                                        <button class="w-full text-left p-2 rounded-lg transition duration-150 bg-red-600 hover:bg-red-500 text-white">
                                            #global-fury-chat
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <!-- User Count and List -->
                            <div class="flex-grow flex flex-col overflow-hidden">
                                <h2 id="user-count" class="text-xs font-semibold uppercase text-gray-400 mb-2">Registered Users (0)</h2>
                                <ul id="users-list" class="space-y-1 overflow-y-auto">
                                    <!-- Online users will be rendered here -->
                                </ul>
                            </div>
                        </div>

                        <!-- User Info Bar -->
                        <div class="p-4 bg-gray-700 border-t border-gray-700 flex items-center">
                            <div class="flex-shrink-0 w-3 h-3 rounded-full mr-3 ${statusColor} border-2 border-gray-700"></div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-sm font-semibold whitespace-nowrap overflow-hidden text-ellipsis">${userDisplayId}</span>
                                <span class="text-xs text-gray-400 capitalize">${onlineStatus} (Email: ${auth.currentUser.email || 'N/A'})</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area (Right) -->
                    <div class="flex-grow flex flex-col">
                        <!-- Header -->
                        <header class="p-4 border-b border-gray-700 bg-gray-800 flex items-center">
                            <h2 class="text-xl font-bold"># global-fury-chat</h2>
                        </header>

                        <!-- Messages Body -->
                        <div id="messages-container" class="flex-grow p-4 overflow-y-auto" style="display: block;">
                            <!-- Messages will be rendered here by renderMessages -->
                        </div>

                        <!-- Input Area -->
                        <form id="chat-form" class="p-4 border-t border-gray-700 bg-gray-800">
                            <div class="flex items-center space-x-3">
                                <input
                                    type="text"
                                    id="message-input"
                                    placeholder="Message #global-fury-chat"
                                    class="flex-grow bg-gray-700 text-white p-3 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none transition duration-150"
                                >
                                <button
                                    type="submit"
                                    class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-xl transition duration-150 shadow-lg disabled:opacity-50"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup Event Listeners
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                sendMessage(input.value);
            });

            // Start all listeners
            startChatListeners();
            startUserCountListener();
        }
        
        // --- Initialization ---

        /**
         * Initializes Firebase and sets up the main authentication listener.
         */
        function initializeAppAndAuth() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing.");
                return renderLoading("Error: Firebase configuration missing.");
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 
            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                return renderLoading("Error initializing Firebase. Check your configuration values.");
            }

            renderLoading("Authenticating...");

            // Set up Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true; 

                if (user) {
                    userId = user.uid;
                    // FIX: This function now handles loading the profile and rendering the correct UI immediately.
                    await initializeUserProfileAndRenderUI(userId); 
                } else {
                    // User is null (not signed in), show the Sign-in screen.
                    userId = null;
                    currentUserProfile = null;
                    renderSignIn();
                }
            });

            // If a custom token exists from the environment, try to use it first
            async function initialSignIn() {
                 if (initialAuthToken) {
                     try {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } catch (e) {
                         console.error("Custom token sign-in failed. User must sign in manually.", e);
                     }
                 }
            }

            initialSignIn();
        }

        // Start the whole application on window load
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
