<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squit! up - Connect with friends</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f1140 0%, #4a2375 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .gradient-text {
            background-image: linear-gradient(to right, #ff8c00, #ff2d55, #bd10e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background: rgba(45, 23, 79, 0.8);
            backdrop-filter: blur(10px);
        }
        .google-button {
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        .google-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .message-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        /* Style for the scrollbar in the messages container */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #7b4397; /* Purple for thumb */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        /* Style for the custom error message box */
        #error-message-box {
            background: #e53e3e;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            word-break: break-all;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-lg p-4 sm:p-6 md:p-8">

        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-1 gradient-text">Squit! up</h1>
        <p class="text-center text-gray-300 mb-8 sm:mb-10">Real-Time Global Chat</p>
        
        <!-- Login/Auth Card (Initial View) -->
        <div id="login-view" class="card rounded-2xl shadow-2xl p-6 sm:p-8 w-full transition-opacity duration-500">
            <div class="text-center mb-6">
                <div class="w-20 h-20 mx-auto rounded-full p-2 bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center mb-4">
                    <!-- Chat Icon (Simple SVG) -->
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.13C2.473 15.21 3 13.208 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold mb-2">Welcome to Squit! up</h2>
                <p class="text-sm text-gray-400">Please sign in to start chatting instantly.</p>
            </div>

            <!-- Error Message Box -->
            <div id="error-message-box"></div>

            <!-- Google Sign-in Button -->
            <button id="google-signin-btn" class="google-button w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 transition duration-150">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20h-2V18h2V20zM24 4C13.8 4 5.2 12.2 4.1 23H0v2h4.1C5.2 35.8 13.8 44 24 44c10.2 0 18.8-8.2 19.9-19h-4.1c-.9 9.3-8.8 16.4-18 16.4-10.2 0-18.4-8.2-18.4-18.4S13.8 5.6 24 5.6c4.6 0 8.8 1.8 11.9 4.8l2.9-2.8c-4.1-3.9-9.5-6.2-14.8-6.2-10.2 0-18.8 8.2-19.9 19H0v2h4.1c1.1 10.8 9.7 19 19.9 19 10.2 0 18.8-8.2 19.9-19h-4.1c-.9-9.3-8.8-16.4-18-16.4z" fill="#4285F4"/><path d="M44.5 24h-2V22h2V24zM24 4C13.8 4 5.2 12.2 4.1 23H0v2h4.1C5.2 35.8 13.8 44 24 44c10.2 0 18.8-8.2 19.9-19h-4.1c-.9 9.3-8.8 16.4-18 16.4-10.2 0-18.4-8.2-18.4-18.4S13.8 5.6 24 5.6c4.6 0 8.8 1.8 11.9 4.8l2.9-2.8c-4.1-3.9-9.5-6.2-14.8-6.2-10.2 0-18.8 8.2-19.9 19H0v2h4.1c1.1 10.8 9.7 19 19.9 19 10.2 0 18.8-8.2 19.9-19h-4.1c-.9-9.3-8.8-16.4-18-16.4z" fill="#34A853"/><path d="M44.5 28h-2V26h2V28zM24 4C13.8 4 5.2 12.2 4.1 23H0v2h4.1C5.2 35.8 13.8 44 24 44c10.2 0 18.8-8.2 19.9-19h-4.1c-.9 9.3-8.8 16.4-18 16.4-10.2 0-18.4-8.2-18.4-18.4S13.8 5.6 24 5.6c4.6 0 8.8 1.8 11.9 4.8l2.9-2.8c-4.1-3.9-9.5-6.2-14.8-6.2-10.2 0-18.8 8.2-19.9 19H0v2h4.1c1.1 10.8 9.7 19 19.9 19 10.2 0 18.8-8.2 19.9-19h-4.1c-.9-9.3-8.8-16.4-18-16.4z" fill="#FBBC05"/><path d="M44.5 32h-2V30h2V32zM24 4C13.8 4 5.2 12.2 4.1 23H0v2h4.1C5.2 35.8 13.8 44 24 44c10.2 0 18.8-8.2 19.9-19h-4.1c-.9 9.3-8.8 16.4-18 16.4-10.2 0-18.4-8.2-18.4-18.4S13.8 5.6 24 5.6c4.6 0 8.8 1.8 11.9 4.8l2.9-2.8c-4.1-3.9-9.5-6.2-14.8-6.2-10.2 0-18.8 8.2-19.9 19H0v2h4.1c1.1 10.8 9.7 19 19.9 19 10.2 0 18.8-8.2 19.9-19h-4.1c-.9-9.3-8.8-16.4-18-16.4z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
        </div>

        <!-- Chat View (Hidden initially) -->
        <div id="chat-view" class="card rounded-2xl shadow-2xl p-6 sm:p-8 w-full h-[80vh] flex flex-col transition-opacity duration-500 hidden opacity-0">
            <header class="flex justify-between items-center pb-4 border-b border-gray-700 mb-4">
                <div class="flex items-center">
                    <img id="user-avatar" src="https://placehold.co/40x40/5a67d8/ffffff?text=U" alt="User Avatar" class="w-10 h-10 rounded-full mr-3 border-2 border-green-400">
                    <div>
                        <p id="welcome-message" class="text-lg font-bold">Welcome, User!</p>
                        <p id="user-id-display" class="text-xs text-gray-400 truncate max-w-[200px]">ID: Loading...</p>
                    </div>
                </div>
                <button id="signout-btn" class="text-sm px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg transition duration-150">
                    Sign Out
                </button>
            </header>
            
            <div id="messages-container" class="flex-grow overflow-y-auto space-y-3 p-2 custom-scrollbar">
                <!-- Chat messages will be dynamically added here -->
                <div id="loading-indicator" class="text-center text-gray-500 pt-10">
                    <p>Loading messages...</p>
                </div>
            </div>

            <footer class="mt-4 pt-4 border-t border-gray-700">
                <form id="message-form" class="flex space-x-3">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-3 rounded-xl bg-gray-800 border border-purple-500 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 text-white placeholder-gray-400" required>
                    <button type="submit" id="send-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-150">
                        Send
                    </button>
                </form>
            </footer>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            limit, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // NOTE: setLogLevel is imported from firebase/app-check.js, but it's typically used from the main firebase/app.js or similar for the base SDK in newer versions. For simplicity in this single-file setup, we'll keep the existing import structure and assume it works, but focusing on the config is the key fix.
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
        
        // --- GLOBAL VARIABLES (Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;
        let db;
        let userId = null;
        let userName = 'Anonymous';
        let userAvatar = 'https://placehold.co/40x40/5a67d8/ffffff?text=U';
        let isFirebaseReady = false;

        // --- UI UTILITY FUNCTIONS ---
        function setView(isLoggedIn) {
            const loginView = document.getElementById('login-view');
            const chatView = document.getElementById('chat-view');

            if (isLoggedIn) {
                loginView.classList.add('hidden', 'opacity-0');
                chatView.classList.remove('hidden');
                setTimeout(() => chatView.classList.remove('opacity-0'), 10);
            } else {
                chatView.classList.add('hidden', 'opacity-0');
                loginView.classList.remove('hidden', 'opacity-0');
            }
        }

        function showAuthError(message) {
            const errorBox = document.getElementById('error-message-box');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('error-message-box').style.display = 'none';
        }

        function createMessageElement(message) {
            const container = document.createElement('div');
            const isMe = message.uid === userId;
            
            container.classList.add('flex', isMe ? 'justify-end' : 'justify-start');

            // Set user info and style based on sender
            const avatarHtml = `
                <img src="${message.avatar || 'https://placehold.co/40x40/5a67d8/ffffff?text=U'}" 
                     alt="${message.name.charAt(0)}" 
                     onerror="this.src='https://placehold.co/40x40/5a67d8/ffffff?text=${(message.name || 'U').charAt(0)}'"
                     class="w-8 h-8 rounded-full ${isMe ? 'order-2 ml-2' : 'order-1 mr-2'}">
            `;
            
            const content = document.createElement('div');
            content.classList.add('flex', 'flex-col', isMe ? 'items-end' : 'items-start', isMe ? 'order-1' : 'order-2');
            
            // Sender Name (Only for others)
            const nameEl = document.createElement('span');
            nameEl.textContent = isMe ? 'You' : message.name;
            nameEl.classList.add('text-xs', 'font-semibold', isMe ? 'text-green-300' : 'text-purple-300', 'mb-1');
            
            // Message Bubble
            const bubble = document.createElement('p');
            bubble.textContent = message.text;
            bubble.classList.add('message-bubble', 'text-sm', isMe ? 'bg-purple-600' : 'bg-gray-700');
            
            content.appendChild(nameEl);
            content.appendChild(bubble);

            // Handle avatar positioning
            if (isMe) {
                container.appendChild(content);
                container.innerHTML += avatarHtml;
            } else {
                container.innerHTML += avatarHtml;
                container.appendChild(content);
            }

            return container;
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        // --- FIRESTORE LOGIC ---
        
        // Firestore path for public messages
        const getMessagesCollectionPath = () => `/artifacts/${appId}/public/data/messages`;

        /**
         * Sends a new message to the Firestore database.
         * @param {string} text - The message content.
         */
        async function sendMessage(text) {
            if (!userId || !text.trim() || !isFirebaseReady) return;

            try {
                // Add the new message document to the 'messages' collection
                await addDoc(collection(db, getMessagesCollectionPath()), {
                    text: text.trim(),
                    createdAt: serverTimestamp(), // Use server timestamp for consistency
                    uid: userId,
                    name: userName,
                    avatar: userAvatar,
                });

                document.getElementById('message-input').value = ''; // Clear input
                scrollToBottom();
            } catch (error) {
                console.error("Error writing new message to Firestore: ", error);
            }
        }

        /**
         * Sets up a real-time listener for messages in the public chat.
         */
        function loadMessages() {
            if (!isFirebaseReady) return;
            
            const messagesRef = collection(db, getMessagesCollectionPath());
            
            // For Canvas to work without manual index creation, we use onSnapshot 
            // on the base collection and sort client-side.
            const q = query(messagesRef);

            // Set up the real-time listener
            onSnapshot(q, (snapshot) => {
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = ''; // Clear existing messages
                document.getElementById('loading-indicator').classList.add('hidden');

                let messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Client-side sort to ensure correct order
                messages.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                messages.forEach(message => {
                    if (message.text) { // Simple filter for valid messages
                        const messageEl = createMessageElement(message);
                        messagesContainer.appendChild(messageEl);
                    }
                });

                scrollToBottom();
            }, (error) => {
                console.error("Error listening to messages:", error);
                document.getElementById('messages-container').innerHTML = '<div class="text-center text-red-400 pt-10">Error loading messages. See console for details.</div>';
            });
        }


        // --- AUTHENTICATION & INITIALIZATION LOGIC ---

        // Handle Google Sign-In
        async function signIn() {
            if (!isFirebaseReady) {
                showAuthError("Firebase not initialized. Check console for config errors.");
                return;
            }
            hideAuthError();
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                const errorMessage = error.message.includes('auth/api-key-not-valid')
                    ? "API Key Error: Check your Firebase configuration settings."
                    : `Sign-In Failed: ${error.message}`;
                showAuthError(errorMessage);
                console.error("Google Sign-In Error:", error.code, error.message);
            }
        }

        // Handle Sign Out
        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        // Main Initialization Logic
        window.onload = async () => {
            // Check for Firebase Config
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                const message = "Firebase API Key is missing. This happens when the app is run outside of a configured environment. Please ensure __firebase_config is set.";
                console.error(message);
                showAuthError(message);
                // Disable sign-in button if config is missing
                document.getElementById('google-signin-btn').disabled = true;
                document.getElementById('google-signin-btn').classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            hideAuthError();
            isFirebaseReady = true;

            // Set debug log level for development
            setLogLevel('debug');

            // 1. Initialize Firebase App and Services
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // 2. Initial Authentication (Canvas Specific)
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    // Fallback to anonymous sign-in if no custom token is provided
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                // This catch handles errors with the initial sign-in attempt (e.g., if token is bad or Firebase is misconfigured)
                console.error("Initial Authentication Error:", error);
                const errorMessage = error.message.includes('auth/api-key-not-valid')
                    ? "Initial Auth Error: Check your Firebase configuration API Key."
                    : `Initial Auth Failed: ${error.message}`;
                showAuthError(errorMessage);
            }
            
            // 3. Set up Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Update global user variables
                    userId = user.uid;
                    // Use a default name if displayName or email is not available (e.g., for anonymous users)
                    userName = user.displayName || user.email || 'Friend';
                    // If the user has a long email/ID, truncate the displayed name for better UI
                    const displayUserName = userName.split('@')[0];

                    userAvatar = user.photoURL || `https://placehold.co/40x40/5a67d8/ffffff?text=${displayUserName.charAt(0)}`;
                    
                    // Update chat header UI
                    document.getElementById('welcome-message').textContent = `Welcome, ${displayUserName}!`;
                    document.getElementById('user-id-display').textContent = `ID: ${user.uid}`;
                    const avatarEl = document.getElementById('user-avatar');
                    avatarEl.src = userAvatar;
                    avatarEl.onerror = () => avatarEl.src = `https://placehold.co/40x40/5a67d8/ffffff?text=${displayUserName.charAt(0)}`;

                    setView(true);
                    loadMessages(); // Start listening for chat messages
                } else {
                    // Clear user variables and hide chat
                    userId = null;
                    setView(false);
                    hideAuthError();
                }
            });

            // 4. Attach Event Listeners
            document.getElementById('google-signin-btn').addEventListener('click', signIn);
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            
            document.getElementById('message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                if (input.value.trim() && userId) {
                    sendMessage(input.value);
                }
            });
        };
    </script>

</body>
</html>
