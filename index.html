<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQUIT UP ! (Prototype)</title>
  <style>
    :root{
      --bg:#071327; --panel:rgba(255,255,255,0.02); --muted:#9fb0c3; --accent:#6ee7b7;
      font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#061021,#071a2a);color:#e6eef8}
    .app {display:grid;grid-template-columns:72px 280px 1fr 240px; height:100vh; gap:12px; padding:12px;}
    .card{background:var(--panel); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.6); overflow:hidden}
    .servers{display:flex;flex-direction:column;align-items:center;padding:8px;gap:8px}
    .server{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#081b28;cursor:pointer;user-select:none}
    .server.active{outline:3px solid rgba(255,255,255,0.06)}
    .sidebar{display:flex;flex-direction:column;padding:12px;gap:12px}
    .header{display:flex;align-items:center;justify-content:space-between}
    .channels{flex:1;overflow:auto;padding:8px;border-radius:8px;background:transparent}
    .channel{padding:8px;border-radius:6px;cursor:pointer}
    .channel.active{background:rgba(255,255,255,0.02)}
    .chat{display:flex;flex-direction:column;height:100%}
    .messages{flex:1; padding:18px; overflow:auto}
    .msg{margin-bottom:12px;display:flex;gap:10px;align-items:flex-start}
    .avatar{width:36px;height:36px;border-radius:8px;background:#123038;display:flex;align-items:center;justify-content:center;font-weight:600}
    .bubble{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;max-width:70%}
    .composer{display:flex;padding:12px;gap:8px;border-top:1px solid rgba(255,255,255,0.02)}
    .composer input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#042;cursor:pointer}
    .members{display:flex;flex-direction:column;padding:12px;gap:8px}
    .member{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    footer.small{font-size:12px;text-align:center;padding:8px;color:var(--muted)}
    .signin{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));backdrop-filter: blur(4px)}
    .signin .card{padding:28px;text-align:center;max-width:420px}
    button.google{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#fff;color:#111;cursor:pointer}
    @media (max-width:900px){ .app{grid-template-columns:64px 220px 1fr; } .members{display:none} }
  </style>
</head>
<body>
  <div class="app">
    <!-- Servers -->
    <div class="card servers">
      <div style="font-weight:700;padding:6px;color:var(--accent);">SU</div>
      <div id="serverList"></div>
      <button id="newServerBtn" class="btn" style="margin-top:auto;width:56px;">+</button>
    </div>

    <!-- Left sidebar: server name & channels -->
    <div class="card sidebar">
      <div class="header">
        <div id="serverName">Squit Up — Home</div>
        <div class="muted" id="userNameShort">Not signed</div>
      </div>
      <div style="display:flex;gap:8px">
        <input id="newChannelName" placeholder="New channel name" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)">
        <button id="createChannel" class="btn">Add</button>
      </div>
      <div class="channels card" id="channelList"></div>
      <footer class="small muted">Squit Up — Chatting & Chilling</footer>
    </div>

    <!-- Center: chat -->
    <div class="card chat">
      <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between">
        <div><strong id="channelTitle">#general</strong><div class="muted" id="channelDesc">Welcome to Squit Up</div></div>
        <div class="muted" id="userStatus">Offline</div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <input id="messageInput" placeholder="Message #general" />
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>

    <!-- Right: members -->
    <div class="card members">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Members</strong>
        <div class="muted" id="memberCount">0</div>
      </div>
      <div id="memberList" style="overflow:auto;max-height:75vh"></div>
      <div style="margin-top:auto">
        <button id="signOutBtn" class="btn" style="width:100%">Sign out</button>
      </div>
    </div>
  </div>

  <!-- Sign in overlay -->
  <div id="signinOverlay" class="signin" style="display:none">
    <div class="card">
      <h2>Squit Up — Sign in</h2>
      <p class="muted">Sign in with Google to continue</p>
      <button id="googleSignIn" class="google">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" style="height:20px"/>
        Sign in with Google
      </button>
      <p style="margin-top:12px" class="muted">Local prototype — your Firebase project is used to store messages.</p>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    // Import Firebase modular SDK from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";

    // --- Your provided firebaseConfig (wired as given) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB1zvVHaBrbzX5iA9fBVNGa_3sY1-WCSpY",
      authDomain: "squit-up-auth.firebaseapp.com",
      projectId: "squit-up-auth",
      storageBucket: "squit-up-auth.firebasestorage.app",
      messagingSenderId: "503910898443",
      appId: "1:503910898443:web:c5a56eb24cd4f183d8600e",
      measurementId: "G-K4LHFHSNJC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Initial selection
    let currentServerId = "default-server";
    let currentChannelId = "general";

    // UI elements
    const signinOverlay = document.getElementById('signinOverlay');
    const googleSignIn = document.getElementById('googleSignIn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userNameShort = document.getElementById('userNameShort');
    const userStatus = document.getElementById('userStatus');
    const serverList = document.getElementById('serverList');
    const channelList = document.getElementById('channelList');
    const messagesEl = document.getElementById('messages');
    const memberList = document.getElementById('memberList');
    const memberCount = document.getElementById('memberCount');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const newServerBtn = document.getElementById('newServerBtn');
    const newChannelName = document.getElementById('newChannelName');
    const createChannel = document.getElementById('createChannel');
    const serverName = document.getElementById('serverName');
    const channelTitle = document.getElementById('channelTitle');
    const channelDesc = document.getElementById('channelDesc');

    // utils
    function el(tag, cls=''){const e=document.createElement(tag);if(cls)e.className=cls;return e;}
    function timeShort(ts){
      try{ return new Date(ts.seconds*1000).toLocaleTimeString(); }catch(e){ return ''; }
    }

    // Sign-in
    googleSignIn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("Sign-in error: " + err.message);
      }
    };
    signOutBtn.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        signinOverlay.style.display = 'none';
        userNameShort.textContent = user.displayName?.split(' ')[0] || 'User';
        userStatus.textContent = 'Online';
        // update member entry
        const memberRef = doc(db, 'servers', currentServerId, 'members', user.uid);
        await setDoc(memberRef, {
          uid: user.uid,
          name: user.displayName,
          photoURL: user.photoURL || null,
          lastSeen: serverTimestamp()
        }, { merge: true });
      } else {
        signinOverlay.style.display = 'flex';
        userNameShort.textContent = 'Not signed';
        userStatus.textContent = 'Offline';
        memberList.innerHTML = '';
      }
    });

    // Ensure default server+channel exists
    async function ensureDefaultServer() {
      const sref = doc(db, 'servers', currentServerId);
      await setDoc(sref, { name: "Squit Up — Home", createdAt: serverTimestamp() }, { merge: true });
      const cref = doc(db, 'servers', currentServerId, 'channels', currentChannelId);
      await setDoc(cref, { name: "general", topic: "General chat", createdAt: serverTimestamp() }, { merge: true });
    }
    await ensureDefaultServer();

    // Render one server (prototype)
    function renderServers(servers) {
      serverList.innerHTML = '';
      for (const s of servers) {
        const d = el('div','server'); d.textContent = (s.name||'SU').slice(0,2).toUpperCase();
        d.onclick = () => {
          currentServerId = s.id;
          serverName.textContent = s.name || 'Server';
          loadChannels();
          subscribeMembers();
          loadMessages();
        };
        serverList.appendChild(d);
      }
    }
    renderServers([{ id: currentServerId, name: "Squit Up — Home" }]);

    // Load channels
    let channelsUnsub = null;
    function loadChannels(){
      if (channelsUnsub) channelsUnsub();
      channelList.innerHTML = '';
      const q = query(collection(db, 'servers', currentServerId, 'channels'), orderBy('createdAt'));
      channelsUnsub = onSnapshot(q, snapshot => {
        channelList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const ch = docSnap.data(); ch.id = docSnap.id;
          const row = el('div','channel'); row.textContent = '# ' + (ch.name || ch.id);
          row.onclick = () => {
            currentChannelId = ch.id;
            channelTitle.textContent = '#' + (ch.name || ch.id);
            channelDesc.textContent = ch.topic || '';
            loadMessages();
          };
          channelList.appendChild(row);
        });
      });
    }
    loadChannels();

    // Create channel
    createChannel.onclick = async () => {
      const name = newChannelName.value.trim();
      if (!name) return alert("Enter channel name");
      const col = collection(db, 'servers', currentServerId, 'channels');
      await addDoc(col, { name, topic: '', createdAt: serverTimestamp() });
      newChannelName.value = '';
    };

    // Messages: listener & sender
    let unsubscribeMessages = null;
    function loadMessages(){
      if (unsubscribeMessages) unsubscribeMessages();
      messagesEl.innerHTML = '';
      const msgsCol = collection(db, 'servers', currentServerId, 'channels', currentChannelId, 'messages');
      const q = query(msgsCol, orderBy('createdAt'));
      unsubscribeMessages = onSnapshot(q, snapshot => {
        messagesEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const m = docSnap.data();
          const row = el('div','msg');
          const avatar = el('div','avatar'); avatar.textContent = (m.name||'U').slice(0,1).toUpperCase();
          const bubble = el('div','bubble');
          bubble.innerHTML = `<strong>${escapeHtml(m.name||'Anonymous')}</strong> <span class="muted" style="font-size:12px"> ${timeShort(m.createdAt||{})}</span>
                              <div style="margin-top:6px">${escapeHtml(m.text)}</div>`;
          row.appendChild(avatar); row.appendChild(bubble);
          messagesEl.appendChild(row);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }
    // initial messages
    loadMessages();

    // Send message
    sendBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert("Sign in first");
      const text = messageInput.value.trim();
      if (!text) return;
      const msgsCol = collection(db, 'servers', currentServerId, 'channels', currentChannelId, 'messages');
      await addDoc(msgsCol, {
        uid: user.uid,
        name: user.displayName,
        text,
        createdAt: serverTimestamp()
      });
      messageInput.value = '';
    };

    // Members list
    let membersUnsub = null;
    function subscribeMembers(){
      if (membersUnsub) membersUnsub();
      const q = query(collection(db, 'servers', currentServerId, 'members'), orderBy('name'));
      membersUnsub = onSnapshot(q, snap => {
        memberList.innerHTML = '';
        let c=0;
        snap.forEach(s => {
          const m = s.data();
          const row = el('div','member');
          const av = el('div','avatar'); av.textContent = (m.name||'U').slice(0,1).toUpperCase();
          const name = el('div'); name.innerHTML = `<div><strong>${escapeHtml(m.name||'User')}</strong></div><div class="muted" style="font-size:12px">${m.uid}</div>`;
          row.appendChild(av); row.appendChild(name);
          memberList.appendChild(row);
          c++;
        });
        memberCount.textContent = c;
      });
    }
    subscribeMembers();

    // Add server
    newServerBtn.onclick = async () => {
      const name = prompt("New server name (prototype):");
      if (!name) return;
      const id = name.toLowerCase().replace(/\s+/g,'-').slice(0,28);
      await setDoc(doc(db,'servers',id),{ name, createdAt: serverTimestamp() });
      currentServerId = id;
      serverName.textContent = name;
      loadChannels();
      subscribeMembers();
      await ensureDefaultServer();
    };

    // HTML escape
    function escapeHtml(str){
      if(!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
